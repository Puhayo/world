<!DOCTYPE html>
<html>
<head>
    <title>중력 미로 탈출 게임</title>
    <link rel="icon" type="image/png" href="icon.png">
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: rgb(220, 219, 219); /* 페이지 전체 배경을 하얀색으로 설정 */

        }
        #game-container {
            position: relative;
            width: 600px;
            height: 600px;
            border: 20px solid black;
            margin-top: 40px;
            background-color: white; /* 게임 컨테이너 배경을 하얀색으로 설정 */
            z-index: 2; /* 배경 이미지보다 위에 오도록 z-index 증가 */
        }
        #player {
            position: absolute; /* 위치 속성을 절대 위치로 설정 */
            width: 60px; /* 크기를 40x40으로 증가 */
            height: 60px;
            background-image: url('pix.png'); /* 이미지 경로 설정 */
            background-size: contain; /* 이미지가 요소 크기에 맞게 조정되도록 설정 */
            background-position: center ; /* 이미지를 중앙에 위치 */
            background-repeat: no-repeat; /* 이미지가 반복되지 않도록 설정 */
            transition: transform 0.5s ease; /* 회전 애니메이션 유지 */
            transform-origin: center center;
        }
        #goal {
            position: absolute;
            width: 40px;  /* 이미지 크기에 맞게 조정 */
            height: 40px;
            background-image: url('goal.png');  /* 이미지 경로 설정 */
            background-size: contain;  /* 이미지가 요소에 맞게 조정되도록 설정 */
            background-position: center;  /* 이미지를 중앙에 위치 */
            background-repeat: no-repeat;  /* 이미지 반복 방지 */
        }
        .wall {
            position: absolute;
            background-color: #333;
        }
        #controls {
            position: relative;
            width: 150px;
            height: 100px;
            margin: 20px auto;
            z-index: 2; /* 배경 이미지보다 위에 오도록 설정 */
        }
        .gravity-button {
            position: absolute;
            width: 80px;
            height: 80px;
            font-size: 16px;
            cursor: pointer;
        }
        #up-button {
            top: 0;
            left: 50%;
            transform: translateX(-50%);
        }
        #left-button {
            top: 80px;
            left: calc(50% - 80px);
            transform: translateX(-50%);
        }
        #down-button {
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
        }
        #right-button {
            top: 80px;
            left: calc(50% + 80px);
            transform: translateX(-50%);
        }
        #stage-title {
            position: absolute;
            top: -80px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 36px;
            font-weight: bold;
            color: #333;
            z-index: 2; /* 배경 이미지보다 위에 오도록 설정 */
        }
        #game-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2; /* 배경 이미지보다 위에 오도록 설정 */
        }
        #stage-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 600px;
            margin-bottom: 40px;
            position: relative;
            z-index: 2; /* 배경 이미지보다 위에 오도록 설정 */
        }
        .stage-button {
            margin: 5px;
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
            flex: 0 0 calc(20% - 10px);
        }
        .particle {
            position: absolute;
            width: 5px;
            height: 5px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            pointer-events: none;
            animation: particle-animation 1s forwards;
        }

        @keyframes particle-animation {
            0% {
                transform: translate(0, 0);
                opacity: 1;
            }
            100% {
                transform: translate(var(--x), var(--y));
                opacity: 0;
            }
        }

        .player {
            position: absolute;
            width: 100px;
            height: 100px;
            left: 50%;
            top: 50%;
            transform-origin: center bottom !important;
            transform: translate(-50%, -50%) scale(1);
            transition: transform 0.3s ease;
        }
        #portal1, #portal2, #portal3, #portal5, #portal7, #portal9, #portal11, #portal13, #portal15, #portal17, #portal19, #portal21, #portal23, #portal25 {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('portal.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
        }
        #portal27, #portal29, #portal31, #portal33, #portal35, #portal37, #portal39, #portal41, #portal43 {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('portal.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
        }
        #portal4, #portal6, #portal8, #portal10, #portal12, #portal14, #portal16, #portal18, #portal20, #portal22, #portal24, #portal26 {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('portal.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0; /* 투명도 추가 */
        }
        #portal28, #portal30, #portal32, #portal34, #portal36, #portal38, #portal40, #portal42, #portal44 {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('portal.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0; /* 투명도 추가 */
        }
        #background-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 0; /* 모든 UI 요소보다 아래에 위치 */
        }
        #background-image.stage-bg-1 {
            background-image: url('./background/1.png');
        }
        #background-image.stage-bg-2 {
            background-image: url('./background/2.png');
        }
        #background-image.stage-bg-3 {
            background-image: url('./background/3.png');
        }
        #background-image.stage-bg-4 {
            background-image: url('./background/4.png');
        }
        #background-image.stage-bg-5 {
            background-image: url('./background/5.png');
        }
        #background-image.stage-bg-6 {
            background-image: url('./background/6.png');
        }
        #background-image.stage-bg-7 {
            background-image: url('./background/7.png');
        }
        #background-image.stage-bg-8 {
            background-image: url('./background/8.png');
        }
        #background-image.stage-bg-9 {
            background-image: url('./background/9.png');
        }
        #background-image.stage-bg-10 {
            background-image: url('./background/10.png');
        }
        /* 새로운 메인 컨테이너 스타일 */
        #main-container {
            background-color: rgba(216, 210, 210, 0.6); /* 투명도 0.8 추가 */
            padding: 20px 20px 60px 20px; /* 아래쪽 패딩만 40px로 늘림 */
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 2;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        /* 다른 요소들의 z-index는 제거해도 됩니다 (이미 컨테이너가 처리함) */
        #game-area, #stage-buttons, #controls, #stage-title {
            position: relative;
        }

        /* 스테이지 5의 레드존 스타일 */
        .danger-zone {
            position: absolute;
            background-color: rgba(255, 0, 0, 1);  /* 반투명한 빨간색 */
            pointer-events: none;
        }

        /* 스테이지 6의 레드존 스타일 (조명 효과 적용) */
        .dark-danger-zone {
            position: absolute;
            background-color: rgba(255, 0, 0, 1);  /* 반투명한 빨간색 */
            pointer-events: none;
            transition: opacity 0.3s, background-color 0.3s;  /* 색상 전환도 부드럽게 */
        }

        .moving-platform {
            position: absolute;
            background-color: #001aff;  /*  벽보다 약간 밝은 색상 */
        }
        #light-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #333;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
        }

        #light-overlay.active {
            opacity: 1;  /* 어두운 정도 조절 (0: 투명 ~ 1: 완전 검정) */
            mask-image: radial-gradient(circle at center, transparent 30px, #333 50px);
            -webkit-mask-image: radial-gradient(circle at center, transparent 30px, #333 50px);
        }

        /* 스테이지 4의 벽을 위한 특별한 스타일 */
        .wall.dark-wall {
            background-color: #333;
            opacity: 0;  /* 완전히 투명하게 설정 */
            transition: opacity 0.3s;
        }

        /* 조명이 비출 때 벽이 보이게 함 */
        #light-overlay.active ~ .wall.dark-wall {
            opacity: 0.9;  /* 조명 아래에서만 보이게 */
        }
    </style>
</head>
<body>
    <div id="background-image"></div>
    <div id="main-container">
        <div id="game-area">
            <div id="stage-buttons">
                <!-- 스테이지 버튼은 여기에 추가됩니다 -->
            </div>
            <div id="game-container">
                <div id="stage-title">Stage 1</div>
                <div id="player"></div>
                <div id="goal"></div>
                <div id="portal1" style="display: none;"></div>
                <div id="portal2" style="display: none;"></div>
                <div id="portal3" style="display: none;"></div>
                <div id="portal4" style="display: none;"></div>
                <div id="portal5" style="display: none;"></div>
                <div id="portal6" style="display: none;"></div>
                <div id="portal7" style="display: none;"></div>
                <div id="portal8" style="display: none;"></div>
                <div id="portal9" style="display: none;"></div>
                <div id="portal10" style="display: none;"></div>
                <div id="portal11" style="display: none;"></div>
                <div id="portal12" style="display: none;"></div>
                <div id="portal13" style="display: none;"></div>    
                <div id="portal14" style="display: none;"></div>
                <div id="portal15" style="display: none;"></div>
                <div id="portal16" style="display: none;"></div>
                <div id="portal17" style="display: none;"></div>
                <div id="portal18" style="display: none;"></div>
                <div id="portal19" style="display: none;"></div>
                <div id="portal20" style="display: none;"></div>
                <div id="portal21" style="display: none;"></div>
                <div id="portal22" style="display: none;"></div>
                <div id="portal23" style="display: none;"></div>
                <div id="portal24" style="display: none;"></div>
                <div id="portal25" style="display: none;"></div>
                <div id="portal26" style="display: none;"></div>    
                <div id="portal27" style="display: none;"></div>
                <div id="portal28" style="display: none;"></div>
                <div id="portal29" style="display: none;"></div>
                <div id="portal30" style="display: none;"></div>
                <div id="portal31" style="display: none;"></div>
                <div id="portal32" style="display: none;"></div>
                <div id="portal33" style="display: none;"></div>
                <div id="portal34" style="display: none;"></div>
                <div id="portal35" style="display: none;"></div>
                <div id="portal36" style="display: none;"></div>
                <div id="portal37" style="display: none;"></div>
                <div id="portal38" style="display: none;"></div>
                <div id="portal39" style="display: none;"></div>
                <div id="portal40" style="display: none;"></div>
                <div id="portal41" style="display: none;"></div>
                <div id="portal42" style="display: none;"></div>
                <div id="portal43" style="display: none;"></div>
                <div id="portal44" style="display: none;"></div>
                
                <div id="light-overlay"></div>
            </div>
        </div>
        <div id="controls">
            <button id="up-button" class="gravity-button" onclick="changeGravity('up')">위(W)</button>
            <button id="left-button" class="gravity-button" onclick="changeGravity('left')">왼쪽(A)</button>
            <button id="down-button" class="gravity-button" onclick="changeGravity('down')">아래(S)</button>
            <button id="right-button" class="gravity-button" onclick="changeGravity('right')">오른쪽(D)</button>
        </div>
    </div>
    <script>
        const player = document.getElementById('player');
        const goal = document.getElementById('goal');
        const gameContainer = document.getElementById('game-container');

        const gameWidth = 600;
        const gameHeight = 600;
        const playerWidth = 60;
        const playerHeight = 60;

        let currentGravity = 'down';
        let playerVelocity = { x: 0, y: 0 };
        let isJumping = false;
        let canJump = true;
        let lastJumpTime = 0;
        const jumpCooldown = 500; // 점프 쿨다운 시간 (밀리초)
        const gravity = 0.8; // 중력 강도 증가
        const jumpForce = 10;
        let isOnGround = true;
        const moveSpeed = 5;
        const maxFallSpeed = 10; // 최대 낙하 속도 설정
        let lastMoveTime = 0;
        const moveDelay = 200; // 연속 이동 사이의 지연 시간 (밀리초)
        let keyState = {
            ArrowLeft: false,
            ArrowRight: false,
            ArrowUp: false,
            ArrowDown: false,
            KeyW: false,
            KeyA: false,
            KeyS: false,
            KeyD: false
        };

        const stages = [
            // 스테이지 1
            [
                { x: 100, y: 0, width: 20, height: 400 },
                { x: 100, y: 500, width: 420, height: 20 },
                { x: 500, y: 100, width: 100, height: 20 },
                { x: 200, y: 100, width: 20, height: 300 },
                { x: 300, y: 200, width: 200, height: 20 },
                { x: 400, y: 200, width: 20, height: 200 },
                { x: 500, y: 100, width: 20, height: 400 },
            ],
            // 스테이지 2
            [
                { x: 0, y: 100, width: 500, height: 20 },
                { x: 100, y: 200, width: 20, height: 300 },
                { x: 200, y: 300, width: 400, height: 20 },
                { x: 300, y: 0, width: 20, height: 200 },
                { x: 400, y: 400, width: 20, height: 200 },
            ],
            // 스테이지 3
            [
                { x: 0, y: 200, width: 400, height: 20 },
                { x: 200, y: 100, width: 20, height: 220 },
                { x: 300, y: 300, width: 300, height: 20 },
                { x: 500, y: 0, width: 20, height: 200 },
            ],
            // 스테이지 4
            [
                { x: 100, y: 100, width: 20, height: 200 },
                { x: 100, y: 300, width: 100, height: 20 },
                { x: 100, y: 400, width: 20, height: 100 },
                { x: 100, y: 100, width: 200, height: 20 },
                { x: 200, y: 400, width: 20, height: 100 },
                { x: 200, y: 200, width: 100, height: 20 },
                { x: 300, y: 100, width: 20, height: 400 },
                { x: 300, y: 400, width: 120, height: 20 },
                { x: 400, y: 100, width: 20, height: 300 },
                { x: 400, y: 500, width: 20, height: 100 },
                { x: 400, y: 100, width: 200, height: 20 },
                { x: 500, y: 200, width: 20, height: 400 },
                { x: 0, y: 500, width: 220, height: 20 },
            ],
            // 스테이지 5
            [
                { x: 0, y: 300, width: 400, height: 20 },
                { x: 200, y: 0, width: 20, height: 200 },
                { x: 300, y: 400, width: 20, height: 200 },
            ],
            // 스테이지 6
            [
                { x: 100, y: 0, width: 20, height: 400 },
                { x: 300, y: 100, width: 300, height: 20 },
                { x: 300, y: 300, width: 20, height: 200 },
                { x: 300, y: 300, width: 300, height: 20 },
                { x: 500, y: 400, width: 20, height: 200 },
            ],
            // 스테이지 7
            [
                { x: 0, y: 100, width: 600, height: 20 },
                { x: 150, y: 300, width: 20, height: 300 },
                { x: 0, y: 300, width: 600, height: 20 },
                { x: 400, y: 100, width: 200, height: 20 },
                { x: 0, y: 500, width: 600, height: 20 },
                { x: 350, y: 100, width: 20, height: 500 },
                { x: 200, y: 0, width: 20, height: 100 },
            ],
            // 스테이지 8
            [
                { x: 100, y: 100, width: 400, height: 20 },
                { x: 100, y: 200, width: 20, height: 300 },
                { x: 200, y: 300, width: 300, height: 20 },
                { x: 400, y: 0, width: 20, height: 200 },
                { x: 500, y: 400, width: 20, height: 200 },
            ],
            // 스테이지 9
            [
                { x: 0, y: 300, width: 500, height: 20 },
                { x: 200, y: 100, width: 20, height: 400 },
                { x: 300, y: 0, width: 20, height: 200 },
                { x: 400, y: 200, width: 200, height: 20 },
                { x: 500, y: 300, width: 20, height: 300 },
            ],
            // 스테이지 10
            [
                { x: 100, y: 0, width: 20, height: 300 },
                { x: 200, y: 200, width: 300, height: 20 },
                { x: 300, y: 300, width: 20, height: 300 },
                { x: 400, y: 100, width: 200, height: 20 },
                { x: 500, y: 0, width: 20, height: 500 },
            ],
        ];

        let currentStage = 0;
        let walls = [];

        // 전역 변수 추가
        let portalCooldown = false;
        const portal1 = document.getElementById('portal1');
        const portal2 = document.getElementById('portal2');
        const portal3 = document.getElementById('portal3');
        const portal4 = document.getElementById('portal4');
        const portal5 = document.getElementById('portal5');
        const portal6 = document.getElementById('portal6');
        const portal7 = document.getElementById('portal7');
        const portal8 = document.getElementById('portal8');
        const portal9 = document.getElementById('portal9');
        const portal10 = document.getElementById('portal10');
        const portal11 = document.getElementById('portal11');
        const portal12 = document.getElementById('portal12');
        const portal13 = document.getElementById('portal13');
        const portal14 = document.getElementById('portal14');
        const portal15 = document.getElementById('portal15');
        const portal16 = document.getElementById('portal16');
        const portal17 = document.getElementById('portal17');
        const portal18 = document.getElementById('portal18');
        const portal19 = document.getElementById('portal19');
        const portal20 = document.getElementById('portal20');
        const portal21 = document.getElementById('portal21');
        const portal22 = document.getElementById('portal22');
        const portal23 = document.getElementById('portal23');
        const portal24 = document.getElementById('portal24');
        const portal25 = document.getElementById('portal25');
        const portal26 = document.getElementById('portal26');
        const portal27 = document.getElementById('portal27');
        const portal28 = document.getElementById('portal28');
        const portal29 = document.getElementById('portal29');
        const portal30 = document.getElementById('portal30');
        const portal31 = document.getElementById('portal31');
        const portal32 = document.getElementById('portal32');
        const portal33 = document.getElementById('portal33');
        const portal34 = document.getElementById('portal34');
        const portal35 = document.getElementById('portal35');
        const portal36 = document.getElementById('portal36');
        const portal37 = document.getElementById('portal37');
        const portal38 = document.getElementById('portal38');
        const portal39 = document.getElementById('portal39');
        const portal40 = document.getElementById('portal40');
        const portal41 = document.getElementById('portal41');
        const portal42 = document.getElementById('portal42');
        const portal43 = document.getElementById('portal43');
        const portal44 = document.getElementById('portal44');
        

        const dangerZones = {
            4: [  // 스테이지 5의 위험 구역
                { x: 100, y: 500, width: 200, height: 20 },
                { x: 400, y: 300, width: 100, height: 20 },
                { x: 500, y: 200, width: 20, height: 300 },
                { x: 400, y: 100, width: 200, height: 20 }
            ]
        };

        const darkDangerZones = {
            5: [  // 스테이지 6의 위험 구역
                { x: 100, y: 500, width: 220, height: 20 },
                { x: 400, y: 300, width: 100, height: 20 },
                { x: 500, y: 200, width: 20, height: 200 },
                { x: 100, y: 200, width: 220, height: 20 },

            ]
        };

        const movingPlatforms = {
            2: [
                {
                    x: 200, y: 400, width: 100, height: 20,  // 초기 위치와 크기
                    startX: 200, endX: 500,  // x축 이동 범위
                    startY: 400, endY: 400,  // y축 이동 범위 (수평 이동만)
                    speed: 2,  // 이동 속도
                    direction: 1  // 1: 오른쪽/아래로, -1: 왼쪽/위로
                },
                {
                    x: 400, y: 0, width: 20, height: 100,  // 초기 위치와 크기
                    startX: 300, endX: 300,  // x축 이동 범위 (수직 이동만)
                    startY: 0, endY: 200,  // y축 이동 범위
                    speed: 2,  // 이동 속도
                    direction: 1  // 1: 오른쪽/아래로, -1: 왼쪽/위로
                }
            ]
        };

        // 전역 변수로 overlay 요소 참조 추가
        const lightOverlay = document.getElementById('light-overlay');

        function createStageButtons() {
            const stageButtonsContainer = document.getElementById('stage-buttons');
            const totalStages = stages.length;
            const stagesPerRow = Math.ceil(totalStages / 2);

            for (let i = 0; i < totalStages; i++) {
                const button = document.createElement('button');
                button.textContent = `스테이지 ${i + 1}`;
                button.className = 'stage-button';
                button.onclick = () => loadStage(i);
                stageButtonsContainer.appendChild(button);

                if (i === stagesPerRow - 1) {
                    stageButtonsContainer.appendChild(document.createElement('br'));
                }
            }
        }

        function loadStage(stageIndex) {
            currentStage = stageIndex;
            document.getElementById('stage-title').textContent = `스테이지 ${stageIndex + 1}`;
            
            // 배경 이미지 변경
            const bgElement = document.getElementById('background-image');
            // 모든 stage-bg 클래스 제거
            bgElement.className = '';
            // 새로운 스테이지의 배경 클래스 추가
            bgElement.className = `stage-bg-${stageIndex + 1}`;
            
            // 기존 벽 제거
            const existingWalls = document.querySelectorAll('.wall');
            existingWalls.forEach(wall => wall.remove());

            // 포탈 표시/숨김 처리
            portal1.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal2.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal3.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal4.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal5.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal6.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal7.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal8.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal9.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal10.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal11.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal12.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal13.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal14.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal15.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal16.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal17.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal18.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal19.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal20.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal21.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal22.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal23.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal24.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal25.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal26.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal27.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal28.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal29.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal30.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal31.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal32.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal33.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal34.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal35.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal36.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal37.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal38.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal39.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal40.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal41.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal42.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal43.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal44.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            


            if (stageIndex === 1) {
                // 스테이지 2의 포탈 위치 설정
                portal1.style.left = '250px';
                portal1.style.top = '50px';
                portal2.style.left = '540px';
                portal2.style.top = '20px';
                
                // 나머지 포탈 숨기기
                for(let i=3; i<=44; i++) {
                    document.getElementById(`portal${i}`).style.display = 'none';
                }
            } else if (stageIndex === 6) {
                // 스테이지 7의 포탈 위치 설정x
                for(let i=1; i<=3; i++) {
                    document.getElementById(`portal${i}`).style.display = 'none';
                }

                portal3.style.left = '100px'; /* 첫번째 */
                portal3.style.top = '540px';
                portal4.style.left = '220px';
                portal4.style.top = '540px';

                portal5.style.left = '175px'; /* 두번째  원점*/
                portal5.style.top = '540px';
                portal6.style.left = '20px';
                portal6.style.top = '540px';

                portal7.style.left = '305px'; /* 세번째 */
                portal7.style.top = '540px';
                portal8.style.left = '450px';
                portal8.style.top = '540px';

                portal9.style.left = '540px'; /* 네번째 */  
                portal9.style.top = '540px';
                portal10.style.left = '300px';
                portal10.style.top = '440px';

                portal11.style.left = '390px'; /* 다섯번째 */
                portal11.style.top = '540px';
                portal12.style.left = '20px';
                portal12.style.top = '540px';

                portal13.style.left = '180px'; /* 여섯번째 원점 */
                portal13.style.top = '440px';
                portal14.style.left = '20px';
                portal14.style.top = '540px';

                portal15.style.left = '180px'; /* 일곱번째 */
                portal15.style.top = '340px';
                portal16.style.left = '20px';
                portal16.style.top = '440px';

                portal17.style.left = '20px'; /* 여덟번째 원점*/
                portal17.style.top = '340px';
                portal18.style.left = '20px';
                portal18.style.top = '540px';

                portal19.style.left = '100px'; /* 아홉번째 */
                portal19.style.top = '340px';
                portal20.style.left = '540px';
                portal20.style.top = '340px';

                portal21.style.left = '540px'; /* 열번째 */
                portal21.style.top = '440px';
                portal22.style.left = '540px';
                portal22.style.top = '140px';

                portal23.style.left = '390px'; /* 열한번째 */
                portal23.style.top = '440px';
                portal24.style.left = '20px';
                portal24.style.top = '540px';

                portal25.style.left = '390px'; /* 열두번째 */
                portal25.style.top = '340px';
                portal26.style.left = '20px';
                portal26.style.top = '540px';

                portal27.style.left = '390px'; /* 열세번째 */
                portal27.style.top = '140px';
                portal28.style.left = '20px';
                portal28.style.top = '540px';

                portal29.style.left = '390px'; /* 열네번째 */
                portal29.style.top = '240px';
                portal30.style.left = '20px';
                portal30.style.top = '540px';

                portal31.style.left = '540px'; /* 열다섯번째 */
                portal31.style.top = '240px';
                portal32.style.left = '160px';
                portal32.style.top = '190px'; /* 지금은 여기까지 */

                portal33.style.left = '20px'; /* 열여섯번째 */
                portal33.style.top = '240px';
                portal34.style.left = '20px';
                portal34.style.top = '540px';

                portal35.style.left = '20px'; /* 열일곱번째 */
                portal35.style.top = '140px';
                portal36.style.left = '375px';
                portal36.style.top = '30px';

                portal37.style.left = '290px'; /* 열여덟번째 */
                portal37.style.top = '240px';
                portal38.style.left = '20px';
                portal38.style.top = '540px';

                portal39.style.left = '290px'; /* 열아홉번째 */
                portal39.style.top = '140px';
                portal40.style.left = '20px';
                portal40.style.top = '540px';

                portal41.style.left = '540px'; /* 스테이지 8 첫번째 */
                portal41.style.top = '30px';
                portal42.style.left = '120px';
                portal42.style.top = '30px';

                portal43.style.left = '240px'; /* 스테이지 8 두번째 */
                portal43.style.top = '30px';
                portal44.style.left = '20px';
                portal44.style.top = '540px';



            }

            // 새 스테이지의 벽 생성
            walls = stages[stageIndex];
            createWalls();

            // 플레이어와 목표 위치 설정
            resetGame();
            setGoalPosition();

            // 기존 위험 구역 제거
            const existingDangerZones = document.querySelectorAll('.danger-zone, .dark-danger-zone');
            existingDangerZones.forEach(zone => zone.remove());
            
            // 스테이지 5의 일반 위험 구역 생성
            if (dangerZones[stageIndex]) {
                dangerZones[stageIndex].forEach(zone => {
                    const dangerZone = document.createElement('div');
                    dangerZone.className = 'danger-zone';
                    dangerZone.style.left = zone.x + 'px';
                    dangerZone.style.top = zone.y + 'px';
                    dangerZone.style.width = zone.width + 'px';
                    dangerZone.style.height = zone.height + 'px';
                    gameContainer.appendChild(dangerZone);
                });
            }

            // 스테이지 6의 어두운 위험 구역 생성
            if (darkDangerZones[stageIndex]) {
                darkDangerZones[stageIndex].forEach(zone => {
                    const dangerZone = document.createElement('div');
                    dangerZone.className = 'dark-danger-zone';
                    dangerZone.style.left = zone.x + 'px';
                    dangerZone.style.top = zone.y + 'px';
                    dangerZone.style.width = zone.width + 'px';
                    dangerZone.style.height = zone.height + 'px';
                    gameContainer.appendChild(dangerZone);
                });
            }

            // 기존 움직이는 바닥 제거
            const existingPlatforms = document.querySelectorAll('.moving-platform');
            existingPlatforms.forEach(platform => platform.remove());

            // 해당 스테이지의 움직이는 바닥 생성
            if (movingPlatforms[stageIndex]) {
                movingPlatforms[stageIndex].forEach(platform => {
                    const platformElement = document.createElement('div');
                    platformElement.className = 'moving-platform wall';
                    platformElement.style.left = platform.x + 'px';
                    platformElement.style.top = platform.y + 'px';
                    platformElement.style.width = platform.width + 'px';
                    platformElement.style.height = platform.height + 'px';
                    gameContainer.appendChild(platformElement);
                });
            }

            // 조명 효과 토글 (스테이지 4와 6에 적용)
            if (stageIndex === 3 || stageIndex === 5) {  // 스테이지 4 또는 6
                lightOverlay.classList.add('active');
                updateLightPosition();
                
                // 벽에 dark-wall 클래스 추가
                document.querySelectorAll('.wall').forEach(wall => {
                    wall.classList.add('dark-wall');
                });
            } else {
                lightOverlay.classList.remove('active');
            }
        }

        function createWalls() {
            walls.forEach((wall, index) => {
                const wallElement = document.createElement('div');
                wallElement.className = 'wall';
                wallElement.style.left = wall.x + 'px';
                wallElement.style.top = wall.y + 'px';
                wallElement.style.width = wall.width + 'px';
                wallElement.style.height = wall.height + 'px';
                gameContainer.appendChild(wallElement);
            });
        }

        function checkWallCollision() {
            const playerLeft = parseFloat(player.style.left);
            const playerTop = parseFloat(player.style.top);
            const playerRight = playerLeft + playerWidth;
            const playerBottom = playerTop + playerHeight;

            // 일반 벽과 움직이는 벽을 모두 포함하는 배열 생성
            let allWalls = [...walls];
            
            // 현재 스테이지가 3이면 움직이는 벽도 추가
            if (currentStage === 2 && movingPlatforms[2]) {
                movingPlatforms[2].forEach(platform => {
                    allWalls.push({
                        x: platform.x,
                        y: platform.y,
                        width: platform.width,
                        height: platform.height
                    });
                });
            }

            for (const wall of allWalls) {
                if (playerRight > wall.x && playerLeft < wall.x + wall.width &&
                    playerBottom > wall.y && playerTop < wall.y + wall.height) {
                    // 충돌 발생
                    const overlapLeft = playerRight - wall.x;
                    const overlapRight = wall.x + wall.width - playerLeft;
                    const overlapTop = playerBottom - wall.y;
                    const overlapBottom = wall.y + wall.height - playerTop;

                    // 가장 작은 겹을 찾아 그 방향으로 밀어냄
                    const minOverlap = Math.min(overlapLeft, overlapRight, overlapTop, overlapBottom);

                    if (minOverlap === overlapLeft) {
                        player.style.left = (wall.x - playerWidth) + 'px';
                        playerVelocity.x = 0;
                    } else if (minOverlap === overlapRight) {
                        player.style.left = (wall.x + wall.width) + 'px';
                        playerVelocity.x = 0;
                    } else if (minOverlap === overlapTop) {
                        player.style.top = (wall.y - playerHeight) + 'px';
                        playerVelocity.y = 0;
                    } else if (minOverlap === overlapBottom) {
                        player.style.top = (wall.y + wall.height) + 'px';
                        playerVelocity.y = 0;
                    }
                }
            }
        }

        function checkCollision() {
            const playerLeft = parseFloat(player.style.left);
            const playerTop = parseFloat(player.style.top);
            const playerRight = playerLeft + playerWidth;
            const playerBottom = playerTop + playerHeight;

            let wasOnGround = isOnGround;
            isOnGround = false;

            if (playerLeft <= 0) {
                player.style.left = '0px';
                playerVelocity.x = 0;
                if (currentGravity === 'left') {
                    isJumping = false;
                    canJump = true;
                    isOnGround = true;
                }
            } else if (playerRight >= gameWidth) {
                player.style.left = (gameWidth - playerWidth) + 'px';
                playerVelocity.x = 0;
                if (currentGravity === 'right') {
                    isJumping = false;
                    canJump = true;
                    isOnGround = true;
                }
            }

            if (playerTop <= 0) {
                player.style.top = '0px';
                playerVelocity.y = 0;
                if (currentGravity === 'up') {
                    isJumping = false;
                    canJump = true;
                    isOnGround = true;
                }
            } else if (playerBottom >= gameHeight) {
                player.style.top = (gameHeight - playerHeight) + 'px';
                playerVelocity.y = 0;
                if (currentGravity === 'down') {
                    isJumping = false;
                    canJump = true;
                    isOnGround = true;
                }
            }

            checkWallCollision();

            // 바닥에 닿았을 때 입자 효과 생성
            if (!wasOnGround && isOnGround) {
                createParticles();
            }
        }

        function checkPortalCollision() {
            if (portalCooldown) return;

            const playerRect = player.getBoundingClientRect();
            
            if (currentStage === 6) { // 스테이지 7
                const portalPairs = [
                    [portal1, portal2],
                    [portal3, portal4],
                    [portal5, portal6],
                    [portal7, portal8],
                    [portal9, portal10],
                    [portal11, portal12],
                    [portal13, portal14],
                    [portal15, portal16],
                    [portal17, portal18],
                    [portal19, portal20],
                    [portal21, portal22],
                    [portal23, portal24],
                    [portal25, portal26],
                    [portal27, portal28],
                    [portal29, portal30],
                    [portal31, portal32],
                    [portal33, portal34],
                    [portal35, portal36],
                    [portal37, portal38],
                    [portal39, portal40],
                    [portal41, portal42],
                    [portal43, portal44]

                ];

                for (const [portalA, portalB] of portalPairs) {
                    const portalARect = portalA.getBoundingClientRect();
                    const portalBRect = portalB.getBoundingClientRect();

                    if (isColliding(playerRect, portalARect)) {
                        teleportPlayer(portalB);
                        break;
                    }
                }
            } else if (currentStage === 1) { // 스테이지 2
                const portal1Rect = portal1.getBoundingClientRect();
                const portal2Rect = portal2.getBoundingClientRect();

                if (isColliding(playerRect, portal1Rect)) {
                    teleportPlayer(portal2);
                }
            }
        }

        function isColliding(rect1, rect2) {
            return rect1.left < rect2.right &&
                   rect1.right > rect2.left &&
                   rect1.top < rect2.bottom &&
                   rect1.bottom > rect2.top;
        }

        function teleportPlayer(targetPortal) {
            const targetX = parseFloat(targetPortal.style.left);
            const targetY = parseFloat(targetPortal.style.top);
            
            // 포탈 위치에 약간의 오프셋 추가하여 더 자연스러운 이동
            player.style.left = (targetX + 10) + 'px';
            player.style.top = (targetY + 10) + 'px';
            
            // 포탈 사용시 속도 초기화
            playerVelocity.x = 0;
            playerVelocity.y = 0;
            
            // 포탈 쿨다운 설정
            portalCooldown = true;
            setTimeout(() => {
                portalCooldown = false;
            }, 10); // 쿨다운 시간 1초로 감소
        }

        function updateMovingPlatforms() {
            if (currentStage !== 2) return;  // 스테이지 3에서만 실행

            const platforms = document.querySelectorAll('.moving-platform');
            movingPlatforms[2].forEach((platformData, index) => {
                const platform = platforms[index];
                
                // x축 이동
                if (platformData.startX !== platformData.endX) {
                    platformData.x += platformData.speed * platformData.direction;
                    
                    // x축 향 전환 체크
                    if (platformData.x >= platformData.endX) {
                        platformData.direction = -1;
                    } else if (platformData.x <= platformData.startX) {
                        platformData.direction = 1;
                    }
                    platform.style.left = platformData.x + 'px';
                }
                
                // y축 이동
                if (platformData.startY !== platformData.endY) {
                    platformData.y += platformData.speed * platformData.direction;
                    
                    // y축 방향 전환 체크
                    if (platformData.y >= platformData.endY) {
                        platformData.direction = -1;
                    } else if (platformData.y <= platformData.startY) {
                        platformData.direction = 1;
                    }
                    platform.style.top = platformData.y + 'px';
                }
                
                // 플레이어가 플랫폼 위에 있는지 체크
                const playerLeft = parseFloat(player.style.left);
                const playerBottom = parseFloat(player.style.top) + playerHeight;
                const platformTop = platformData.y;
                
                if (playerBottom >= platformTop && 
                    playerBottom <= platformTop + platformData.height &&
                    playerLeft >= platformData.x - playerWidth &&
                    playerLeft <= platformData.x + platformData.width) {
                    // 플레이어를 랫폼과 함께 이동
                    if (platformData.startX !== platformData.endX) {
                        player.style.left = (parseFloat(player.style.left) + platformData.speed * platformData.direction) + 'px';
                    }
                    if (platformData.startY !== platformData.endY) {
                        player.style.top = (platformData.y - playerHeight) + 'px';
                    }
                }
            });
        }

        // 조명 위치 업데이트 함수
        function updateLightPosition() {
            if (currentStage !== 3 && currentStage !== 5) return;  // 스테이지 4와 6에서만 실행
            
            const x = parseFloat(player.style.left) + (playerWidth / 2);
            const y = parseFloat(player.style.top) + (playerHeight / 2);
            
            lightOverlay.style.maskImage = `radial-gradient(circle at ${x}px ${y}px, transparent 30px, black 50px)`;
            lightOverlay.style.webkitMaskImage = `radial-gradient(circle at ${x}px ${y}px, transparent 30px, black 50px)`;
        }

        function update() {
            if (currentGravity === 'left') {
                playerVelocity.x = Math.max(playerVelocity.x - gravity, -maxFallSpeed);
            } else if (currentGravity === 'right') {
                playerVelocity.x = Math.min(playerVelocity.x + gravity, maxFallSpeed);
            } else if (currentGravity === 'up') {
                playerVelocity.y = Math.max(playerVelocity.y - gravity, -maxFallSpeed);
            } else if (currentGravity === 'down') {
                playerVelocity.y = Math.min(playerVelocity.y + gravity, maxFallSpeed);
            }

            player.style.left = (parseFloat(player.style.left) + playerVelocity.x) + 'px';
            player.style.top = (parseFloat(player.style.top) + playerVelocity.y) + 'px';

            checkCollision();
            updateMovingPlatforms();  // 움직이는 바닥 업데이트
            checkDangerZones();
            updateLightPosition();  // 조명 위치 업데이트 추가
            checkGoalCollision();
            checkPortalCollision();

            requestAnimationFrame(update);
        }

        function handleKeyDown(event) {
            const currentTime = Date.now();
            if (currentTime - lastMoveTime < moveDelay) return;

            if (keyState[event.code]) return;

            keyState[event.code] = true;
            lastMoveTime = currentTime;

            switch (event.code) {
                case 'ArrowLeft':
                case 'KeyA':
                    playerVelocity.x = -moveSpeed;
                    break;
                case 'ArrowRight':
                case 'KeyD':
                    playerVelocity.x = moveSpeed;
                    break;
                case 'ArrowUp':
                case 'KeyW':
                    playerVelocity.y = -moveSpeed;
                    break;
                case 'ArrowDown':
                case 'KeyS':
                    playerVelocity.y = moveSpeed;
                    break;
            }

            // WASD 키로 중력 변경
            switch (event.code) {
                case 'KeyW':
                    changeGravity('up');
                    break;
                case 'KeyA':
                    changeGravity('left');
                    break;
                case 'KeyS':
                    changeGravity('down');
                    break;
                case 'KeyD':
                    changeGravity('right');
                    break;
            }
        }

        function handleKeyUp(event) {
            keyState[event.code] = false;

            switch (event.code) {
                case 'ArrowLeft':
                case 'KeyA':
                    if (playerVelocity.x < 0) playerVelocity.x = 0;
                    break;
                case 'ArrowRight':
                case 'KeyD':
                    if (playerVelocity.x > 0) playerVelocity.x = 0;
                    break;
                case 'ArrowUp':
                case 'KeyW':
                    if (playerVelocity.y < 0) playerVelocity.y = 0;
                    break;
                case 'ArrowDown':
                case 'KeyS':
                    if (playerVelocity.y > 0) playerVelocity.y = 0;
                    break;
            }
        }

        function resetGame() {
            player.style.left = '10px';
            player.style.top = (gameHeight - playerHeight - 10) + 'px';
            playerVelocity = { x: 0, y: 0 };
            changeGravity('down');
        }

        function createParticles() {
            const particleCount = 20;
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                const angle = Math.random() * 2 * Math.PI;
                const distance = Math.random() * 50;
                particle.style.setProperty('--x', `${Math.cos(angle) * distance}px`);
                particle.style.setProperty('--y', `${Math.sin(angle) * distance}px`);
                particle.style.left = `${parseFloat(player.style.left) + playerWidth / 2}px`;
                particle.style.top = `${parseFloat(player.style.top) + playerHeight / 2}px`;
                gameContainer.appendChild(particle);

                // 일정 시간 후 입자 제거
                setTimeout(() => {
                    particle.remove();
                }, 1000);
            }
        }

        function changeGravity(direction) {
            currentGravity = direction;
            playerVelocity.x = 0;
            playerVelocity.y = 0;
            gameContainer.style.borderColor = 'black';

            let rotation = 0;
            if (direction === 'left') {
                gameContainer.style.borderLeftColor = 'green';
                rotation = 90;
            } else if (direction === 'right') {
                gameContainer.style.borderRightColor = 'green';
                rotation = -90;
            } else if (direction === 'up') {
                gameContainer.style.borderTopColor = 'green';
                rotation = 180;
            } else if (direction === 'down') {
                gameContainer.style.borderBottomColor = 'green';
                rotation = 0;
            }
            
            // 이미지 회전
            player.style.transform = `rotate(${rotation}deg)`;
        }

        function setGoalPosition() {
            // 각 스테이지마다 다른 목 위 설정
            const goalPositions = [
                { x: 540, y: 30 }, //1번 스테이지
                { x: 30, y: 30 }, //2번 스테이지
                { x: 30, y: 30 }, //3번 스테이지    
                { x: 540, y: 30 }, //4번 스테이지
                { x: 30, y: 30 }, //5번 스테이지
                { x: 540, y: 30 }, //6번 스테이지
                { x: 30, y: 30 }, //7번 스테이지
                { x: 540, y: 30 }, //8번 스테이지
                { x: 30, y: 30 }, //9번 스테이지   
                { x: 540, y: 30 }, //10번 스테이지
            ];

            const position = goalPositions[currentStage];
            goal.style.left = `${position.x}px`;
            goal.style.top = `${position.y}px`;
        }

        function checkGoalCollision() {
            const playerRect = player.getBoundingClientRect();
            const goalRect = goal.getBoundingClientRect();

            if (playerRect.left < goalRect.right &&
                playerRect.right > goalRect.left &&
                playerRect.top < goalRect.bottom &&
                playerRect.bottom > goalRect.top) {
                // 목표에 도달했을 때
                if (currentStage < stages.length - 1) {
                    loadStage(currentStage + 1);
                } else {
                    alert('축하합니다! 모든 스테이지를 클리어하셨습니다!');
                    loadStage(0); // 처음 스테이지로 돌아가기
                }
            }
        }

        function checkDangerZones() {
            // 스테이지 5와 6에서만 체크
            if (currentStage !== 4 && currentStage !== 5) return;  
            
            const playerLeft = parseFloat(player.style.left);
            const playerTop = parseFloat(player.style.top);
            const playerRight = playerLeft + playerWidth;
            const playerBottom = playerTop + playerHeight;
            
            // 스테이지 5의 일반 위험 구역 체크
            if (currentStage === 4 && dangerZones[4]) {
                for (const zone of dangerZones[4]) {
                    if (playerRight > zone.x && 
                        playerLeft < zone.x + zone.width &&
                        playerBottom > zone.y && 
                        playerTop < zone.y + zone.height) {
                        resetGame();
                        break;
                    }
                }
            }
            
            // 스테이지 6의 어두운 위험 구역 체크
            if (currentStage === 5 && darkDangerZones[5]) {
                for (const zone of darkDangerZones[5]) {
                    if (playerRight > zone.x && 
                        playerLeft < zone.x + zone.width &&
                        playerBottom > zone.y && 
                        playerTop < zone.y + zone.height) {
                        resetGame();
                        break;
                    }
                }
            }
        }

        createStageButtons();
        loadStage(0);
        update();

        document.addEventListener('keydown', handleKeyDown);
        document.addEventListener('keyup', handleKeyUp);

        //goal.style.left = '570px';
        //goal.style.top = '10px';
    </script>
</body>
</html>





















































