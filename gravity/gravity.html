<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ì¤‘ë ¥ ë¯¸ë¡œ íƒˆì¶œ ê²Œì„</title>
    <link rel="icon" type="image/png" href="icon.png">
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: rgb(220, 219, 219); /* í˜ì´ì§€ ì „ì²´ ë°°ê²½ì„ í•˜ì–€ìƒ‰ìœ¼ë¡œ ì„¤ì • */

        }
        #game-container {
            position: relative;
            width: 600px;
            height: 600px;
            border: 20px solid black;
            margin-top: 40px;
            background-color: white; /* ê²Œì„ ì»¨í…Œì´ë„ˆ ë°°ê²½ì„ í•˜ì–€ìƒ‰ìœ¼ë¡œ ì„¤ì • */
            z-index: 2; /* ë°°ê²½ ì´ë¯¸ì§€ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ z-index ì¦ê°€ */
        }
        #player {
            position: absolute; /* ìœ„ì¹˜ ì†ì„±ì„ ì ˆëŒ€ ìœ„ì¹˜ë¡œ ì„¤ì • */
            width: 60px; /* í¬ê¸°ë¥¼ 40x40ìœ¼ë¡œ ì¦ê°€ */
            height: 60px;
            background-image: url('pix.png'); /* ì´ë¯¸ì§€ ê²½ë¡œ ì„¤ì • */
            background-size: contain; /* ì´ë¯¸ì§€ê°€ ìš”ì†Œ í¬ê¸°ì— ë§ê²Œ ì¡°ì •ë˜ë„ë¡ ì„¤ì • */
            background-position: center ; /* ì´ë¯¸ì§€ë¥¼ ì¤‘ì•™ì— ìœ„ì¹˜ */
            background-repeat: no-repeat; /* ì´ë¯¸ì§€ê°€ ë°˜ë³µë˜ì§€ ì•Šë„ë¡ ì„¤ì • */
            transition: transform 0.5s ease; /* íšŒì „ ì• ë‹ˆë©”ì´ì…˜ ìœ ì§€ */
            transform-origin: center center;
        }
        #goal {
            position: absolute;
            width: 40px;  /* ì´ë¯¸ì§€ í¬ê¸°ì— ë§ê²Œ ì¡°ì • */
            height: 40px;
            background-image: url('goal.png');  /* ì´ë¯¸ì§€ ê²½ë¡œ ì„¤ì • */
            background-size: contain;  /* ì´ë¯¸ì§€ê°€ ìš”ì†Œì— ë§ê²Œ ì¡°ì •ë˜ë„ë¡ ì„¤ì • */
            background-position: center;  /* ì´ë¯¸ì§€ë¥¼ ì¤‘ì•™ì— ìœ„ì¹˜ */
            background-repeat: no-repeat;  /* ì´ë¯¸ì§€ ë°˜ë³µ ë°©ì§€ */
        }
        .wall {
            position: absolute;
            background-color: #333;
        }
        #controls {
            position: relative;
            width: 150px;
            height: 100px;
            margin: 20px auto;
            z-index: 2; /* ë°°ê²½ ì´ë¯¸ì§€ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ ì„¤ì • */
        }
        #stage-title {
            position: absolute;
            top: -80px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 36px;
            font-weight: bold;
            color: #333;
            z-index: 2; /* ë°°ê²½ ì´ë¯¸ì§€ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ ì„¤ì • */
        }
        #game-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2; /* ë°°ê²½ ì´ë¯¸ì§€ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ ì„¤ì • */
        }
        #stage-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 600px;
            margin-bottom: 40px;
            position: relative;
            z-index: 2; /* ë°°ê²½ ì´ì§€ë‹¤ ìœ„ì— ì˜¤ë„ë¡ ì„¤ì • */
        }
        .stage-button {
            margin: 5px;
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
            flex: 0 0 calc(20% - 10px);
        }
        .stage-button.disabled {
            opacity: 0.5;
        }
        .particle {
            position: absolute;
            width: 5px;
            height: 5px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            pointer-events: none;
            animation: particle-animation 1s forwards;
        }

        @keyframes particle-animation {
            0% {
                transform: translate(0, 0);
                opacity: 1;
            }
            100% {
                transform: translate(var(--x), var(--y));
                opacity: 0;
            }
        }

        .player {
            position: absolute;
            width: 100px;
            height: 100px;
            left: 50%;
            top: 50%;
            transform-origin: center bottom !important;
            transform: translate(-50%, -50%) scale(1);
            transition: transform 0.3s ease;
        }
        #portal1, #portal2, #portal3, #portal5, #portal7, #portal9, #portal11, #portal13, #portal15, #portal17, #portal19, #portal21, #portal23, #portal25 {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('portal.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
        }
        #portal27, #portal29, #portal31, #portal33, #portal35, #portal37, #portal39, #portal41, #portal43 {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('portal.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
        }
        #portal4, #portal6, #portal8, #portal10, #portal12, #portal14, #portal16, #portal18, #portal20, #portal22, #portal24, #portal26 {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('portal.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0; /* íˆ¬ëª…ë„ ì¶”ê°€ */
        }
        #portal28, #portal30, #portal32, #portal34, #portal36, #portal38, #portal40, #portal42, #portal44 {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('portal.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0; /* íˆ¬ëª…ë„ ì¶”ê°€ */
        }
        #background-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 0; /* ëª¨ë“  UI ìš”ì†Œë³´ë‹¤ ì•„ë˜ì— ìœ„ì¹˜ */
        }
        #background-image.stage-bg-1 {
            background-image: url('./background/1.png');
        }
        #background-image.stage-bg-2 {
            background-image: url('./background/2.png');
        }
        #background-image.stage-bg-3 {
            background-image: url('./background/3.png');
        }
        #background-image.stage-bg-4 {
            background-image: url('./background/4.png');
        }
        #background-image.stage-bg-5 {
            background-image: url('./background/5.png');
        }
        #background-image.stage-bg-6 {
            background-image: url('./background/6.png');
        }
        #background-image.stage-bg-7 {
            background-image: url('./background/7.png');
        }
        #background-image.stage-bg-8 {
            background-image: url('./background/8.png');
        }
        #background-image.stage-bg-9 {
            background-image: url('./background/9.png');
        }
        #background-image.stage-bg-10 {
            background-image: url('./background/10.png');
        }
        /* ìƒˆë¡œìš´  ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        #main-container {
            background-color: rgba(216, 210, 210, 0.6); /* íˆ¬ëª…ë„ 0.8 ì¶”ê°€ */
            padding: 20px 20px 120px 20px; /* ì•„ë˜ìª½ íŒ¨ë”©ë§Œ 40pxë¡œ ëŠ˜ë¦¼ */
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 2;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        /*  ìš”ì†Œë“¤ì˜ z-indexëŠ” ì œê±°í•´ë„ ë©ë‹ˆë‹¤ (ì´ë¯¸ ì»¨í…Œì´ë„ˆê°€ ì²˜ë¦¬í•¨) */
        #game-area, #stage-buttons, #controls, #stage-title {
            position: relative;
        }

        /* ìŠ¤í…Œì´ 5 ë ˆì¡´ ìŠ¤íƒ€ì¼ */
        .danger-zone {
            position: absolute;
            background-color: rgba(255, 0, 0, 1);  /* ê¸°ì¡´ ë ˆë“œì¡´ */
            pointer-events: none;
        }

        /* ìŠ¤í…Œì´ì§€ 6ì˜ ë ˆë“œì¡´ ìŠ¤íƒ€ì¼ (ì¡°ëª… íš¨ê³¼ ì ìš©) */
        .dark-danger-zone {
            position: absolute;
            background-color: rgba(255, 0, 0, 1);  /* ë°˜íˆ¬ëª…í•œ ê°„ìƒ‰ */
            pointer-events: none;
            transition: opacity 0.3s, background-color 0.3s;  /* ìƒ‰ìƒ ì „í™˜ë„ ë¶€ë“œëŸ½ê²Œ */
        }

        .moving-platform {
            position: absolute;
            background-color: #001aff;  /*  ë²½ë³´ë‹¤ ì•½ê°„ ë°ì€ ìƒ‰ìƒ */
        }
        #light-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #333;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
        }

        #light-overlay.active {
            opacity: 1;  /* ì–´ë‘ìš´ ì •ë„ ì¡°ì ˆ (0: íˆ¬ëª… ~ 1: ì™„ì „ ê²€ì •) */
            mask-image: radial-gradient(circle at center, transparent 30px, #333 50px);
            -webkit-mask-image: radial-gradient(circle at center, transparent 30px, #333 50px);
        }

        /* ìŠ¤í…Œì´ì§€ 4ì˜ ë²½ì„ í•œ íŠ¹ë³„í•œ ìŠ¤íƒ€ì¼ */
        .wall.dark-wall {
            background-color: #333;
            opacity: 0;  /* ì™„ì „ íˆ¬ëª…í•˜ê²Œ ì„¤ì • */
            transition: opacity 0.3s;
        }

        /* ì¡°ëª…ì´ ë¹„ì¶œ ë•Œ ë²½ì´ ë³´ì´ê²Œ í•¨ */
        #light-overlay.active ~ .wall.dark-wall {
            opacity: 0.9;  /* ì¡°ëª… ì•„ë˜ì—ì„œë§Œ ë³´ì´ê²Œ */
        }

        #audio-controls {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(105px, 400px); /* ê²Œì„ ë§µ ìœ„ìª½ìœ¼ë¡œ ì´ë™ */
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
        }

        #mute-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        #volume-slider {
            width: 82px;
            cursor: pointer;
        }

        #volume-value {
            min-width: 42px;
        }

        #user-info {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-130px, 40px); /* ê²Œì„ ë§µ ìœ„ìª½ìœ¼ë¡œ ì´ë™ */
            background-color: rgba(255, 255, 255, 1);
            padding: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            font-size: 16px;
        }

        #logout-button {
            padding: 5px 10px;
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #logout-button:hover {
            background-color: #cc0000;
        }

        #game-review {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(350px, 180px);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 5px;
            width: 250px;
            z-index: 1000;
            text-align: center;
        }

        #game-review h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #333;
        }

        .star-rating {
            margin-bottom: 15px;
        }

        .star {
            color: #ddd;
            font-size: 24px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .star.active {
            color: #ffd700;
        }

        #rating-value {
            margin-left: 10px;
            font-size: 14px;
        }

        #review-text {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: none;
        }

        #submit-review {
            width: 100%;
            padding: 8px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #submit-review:hover {
            background-color: #45a049;
        }

        /* ê²Œì„ ì„¤ëª… íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        .instructions-container {
            text-align: center;

            position: fixed;
            left: 50%;
            top: 50%;
            width: 250px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            z-index: 1000;
            font-family: 'Arial', sans-serif;
            transform: translate(350px, -350px);
            padding: 20px;
            border-radius: 5px;

        }

        .instructions-content {
            padding: 20px;
        }

        .instructions-content h2 {
            color: #3498db;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .instruction-section {
            margin-bottom: 20px;
        }

        .instruction-section h3 {
            color: #e74c3c;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .instruction-section ul {
            list-style-type: none;
            padding-left: 0;
        }

        .instruction-section li {
            margin-bottom: 10px;
            font-size: 16px;
            line-height: 1.4;
            padding: 5px 10px;
            background-color: #ffffff;
            border-radius: 5px;
            transition: all 0.2s ease;
        }

        /* ìŠ¤í…Œì´ì§€ 10ìš© ì–´ë‘ìš´ ë ˆë“œì¡´ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .dark-danger-zone-10 {
            position: absolute;
            background-color: rgb(255, 0, 0);  
            pointer-events: none;
            opacity: 1;  /* ê¸°ë³¸ì ìœ¼ï¿½ï¿½ íˆ¬ëª… */
            transition: opacity 0.3s ease;  /* ë¶€ë“œëŸ¬ìš´ í˜ì´ë“œ íš¨ê³¼ */
        }

        /* ì¤‘ë ¥ ë°˜ì‘í˜• ë¸”ë¡ ìŠ¤íƒ€ì¼ */
        .gravity-block {
            position: absolute;
            background-color: #8A2BE2 !important;
            pointer-events: none;
            z-index: 1;
            /* ë¶€ë“œëŸ¬ìš´ ì›€ì§ì„ì„ ìœ„í•œ transition ì œê±° */
            transition: none;
        }

        #survey-block {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-300px, 400px); /* user-info ì•„ë˜ì— ìœ„ì¹˜í•˜ë„ë¡ ì¡°ì • */
            background-color: rgba(255, 255, 255, 1);
            padding: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            z-index: 1000;
        }

        #survey-link {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 16px;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #survey-link:hover {
            background-color: #45a049;
        }

        #survey-link i {
            font-size: 18px;
        }

        /* í†µí•©ëœ ì»¨íŠ¸ë¡¤ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ ìˆ˜ì • */
        #integrated-controls {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, 550%); /* ë°•ìŠ¤ì˜ ì¤‘ì‹¬ì´ ê¸°ì¤€ì ì´ ë˜ë„ë¡ ìˆ˜ì • */
            background-color: rgba(255, 255, 255, 0.8);
            padding: 15px 25px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: auto;
        }

        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìˆ˜ì • */
        #user-info, #audio-controls, #survey-block {
            position: static;
            transform: none;
            background-color: transparent;
            padding: 0;
            margin: 0;
            border-radius: 0;
        }

        /* êµ¬ë¶„ì„  ìŠ¤íƒ€ì¼ ìœ ì§€ */
        .control-divider {
            width: 1px;
            height: 30px;
            background-color: #ddd;
            margin: 0 10px; /* ì—¬ë°± ì•½ê°„ ì¦ê°€ */
        }

        /* ì„¤ë¬¸ì¡°ì‚¬ ë§í¬ ìŠ¤íƒ€ì¼ ìˆ˜ì • */
        #survey-link {
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-size: 14px;
            transition: background-color 0.3s;
            white-space: nowrap; /* í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }

        .clear-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            z-index: 2000;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.5s ease-in;
            min-width: 300px;
        }

        .clear-message h2 {
            color: #4CAF50;
            font-size: 28px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .clear-message p {
            color: #333;
            font-size: 16px;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .clear-message button {
            margin-top: 10px;
            padding: 12px 25px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }

        .clear-message button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries
      
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyDrwv8GrSacKk1B2yrJkz1oX7GUQhfWDh8",
          authDomain: "test-d13ce.firebaseapp.com", 
          projectId: "test-d13ce",
          storageBucket: "test-d13ce.firebasestorage.app",
          messagingSenderId: "12340326841",
          appId: "1:12340326841:web:b72bf64fb4e5ff92690668",
          measurementId: "G-JQHF3XC6S0"
        };
      
        // Initialize Firebase íŒŒì´ì–´ë² ì´ìŠ¤ ì„¤ì •í•´ë³´ê¸°
        try {
            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app);
            console.log('Firebaseê°€ ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            console.log('ì•± ì •ë³´:', app);
            console.log('ì• ë„ë¦¬í‹±ìŠ¤ ì •ë³´:', analytics);
        } catch (error) {
            console.error('Firebase ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        }
      </script>
    <div id="background-image"></div>
    <div id="main-container">
        <!-- ê²Œì„ ì»¨í…Œì´ë„ˆ ì•ì— ì¶”ê°€ -->
        <div id="game-instructions" class="instructions-container">
            <div class="instructions-content">
                <h2>ê²Œì„ ì„¤ëª…</h2>
                <div class="instruction-section">
                    <h3>ê¸°ë³¸ ì¡°ì‘</h3>
                    <ul>
                        <li>â† â†’ : ì¢Œìš° ì´ë™</li>
                        <li>â†‘   â†“ : ìƒí•˜ ì´ë™</li>
                        <li>WASD : ì¤‘ë ¥ ë°©í–¥ ë³€ê²½</li>
                    </ul>
                </div>
                <div class="instruction-section">
                    <h3>ê²Œì„ ê·œì¹™</h3>
                    <ul>
                        <li>ì¤‘ë ¥ì„ ì´ìš©í•´</li>
                        <li>ë¯¸ë¡œï¿½ï¿½ í’€ë©´ì„œ</li>
                        <li>ë¸”ë™í™€ê¹Œì§€ ë„ë‹¬í•˜ì„¸ìš”!</li>
                    </ul>
                </div>
            </div>
        </div>
        <div id="game-area">
            <div id="stage-buttons">
                <!-- ìŠ¤í…Œì´ì§€ ë²„íŠ¼ì€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
            <div id="game-container">
                <div id="stage-title">Stage 1</div>
                <div id="player"></div>
                <div id="goal"></div>
                <div id="portal1" style="display: none;"></div>
                <div id="portal2" style="display: none;"></div>
                <div id="portal3" style="display: none;"></div>
                <div id="portal4" style="display: none;"></div>
                <div id="portal5" style="display: none;"></div>
                <div id="portal6" style="display: none;"></div>
                <div id="portal7" style="display: none;"></div>
                <div id="portal8" style="display: none;"></div>
                <div id="portal9" style="display: none;"></div>
                <div id="portal10" style="display: none;"></div>
                <div id="portal11" style="display: none;"></div>
                <div id="portal12" style="display: none;"></div>
                <div id="portal13" style="display: none;"></div>    
                <div id="portal14" style="display: none;"></div>
                <div id="portal15" style="display: none;"></div>
                <div id="portal16" style="display: none;"></div>
                <div id="portal17" style="display: none;"></div>
                <div id="portal18" style="display: none;"></div>
                <div id="portal19" style="display: none;"></div>
                <div id="portal20" style="display: none;"></div>
                <div id="portal21" style="display: none;"></div>
                <div id="portal22" style="display: none;"></div>
                <div id="portal23" style="display: none;"></div>
                <div id="portal24" style="display: none;"></div>
                <div id="portal25" style="display: none;"></div>
                <div id="portal26" style="display: none;"></div>    
                <div id="portal27" style="display: none;"></div>
                <div id="portal28" style="display: none;"></div>
                <div id="portal29" style="display: none;"></div>
                <div id="portal30" style="display: none;"></div>
                <div id="portal31" style="display: none;"></div>
                <div id="portal32" style="display: none;"></div>
                <div id="portal33" style="display: none;"></div>
                <div id="portal34" style="display: none;"></div>
                <div id="portal35" style="display: none;"></div>
                <div id="portal36" style="display: none;"></div>
                <div id="portal37" style="display: none;"></div>
                <div id="portal38" style="display: none;"></div>
                <div id="portal39" style="display: none;"></div>
                <div id="portal40" style="display: none;"></div>
                <div id="portal41" style="display: none;"></div>
                <div id="portal42" style="display: none;"></div>
                <div id="portal43" style="display: none;"></div>
                <div id="portal44" style="display: none;"></div>
                
                <div id="light-overlay"></div>
            </div>
        </div>
        <div id="integrated-controls">
            <div id="survey-block">
                <a id="survey-link" href="https://forms.gle/qFotWGKbx5fqKLfT7" target="_blank">
                    ê²Œì„ ì„¤ë¬¸ì¡°ì‚¬
                </a>
            </div>
            
            <div class="control-divider"></div>
            
            <div id="user-info">
                <span id="student-info">í•™ë²ˆ: </span>
                <button id="logout-button">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            
            <div class="control-divider"></div>
            
            <div id="audio-controls">
                <button id="mute-button">ğŸ”Š</button>
                <input type="range" id="volume-slider" min="0" max="100" value="50">
                <span id="volume-value">50%</span>
            </div>
        </div>
        <div id="game-review">
            <h3>ê²Œì„ í‰ê°€í•˜ê¸° (ìµëª…)</h3>
            <div class="star-rating">
                <span class="star" data-rating="1">â˜…</span>
                <span class="star" data-rating="2">â˜…</span>
                <span class="star" data-rating="3">â˜…</span>
                <span class="star" data-rating="4">â˜…</span>
                <span class="star" data-rating="5">â˜…</span>
                <span id="rating-value">0ì </span>
            </div>
            <textarea id="review-text" placeholder="ê²Œì„ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”              (ìµëª…ìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤)" maxlength="200"></textarea>
            <button id="submit-review">í›„ê¸° ë‚¨ê¸°ê¸°</button>
        </div>
    </div>
    <audio id="bgm-1" loop src="music/1s.mp3"></audio>
    <audio id="bgm-2" loop src="music/2s.mp3"></audio>
    <audio id="bgm-3" loop src="music/3s.mp3"></audio>
    <audio id="bgm-4" loop src="music/4s.mp3"></audio>
    <audio id="bgm-5" loop src="music/5s.mp3"></audio>
    <audio id="bgm-6" loop src="music/6s.mp3"></audio>
    <audio id="bgm-7" loop src="music/7s.mp3"></audio>
    <audio id="bgm-8" loop src="music/8s.mp3"></audio>
    <audio id="bgm-9" loop src="music/9s.mp3"></audio>
    <audio id="bgm-10" loop src="music/10s.mp3"></audio>
    <script>
        const player = document.getElementById('player');
        const goal = document.getElementById('goal');
        const gameContainer = document.getElementById('game-container');

        const gameWidth = 600;
        const gameHeight = 600;
        const playerWidth = 60;
        const playerHeight = 60;

        let currentGravity = 'down';
        let playerVelocity = { x: 0, y: 0 };
        let isJumping = false;
        let canJump = true;
        let lastJumpTime = 0;
        const jumpCooldown = 500; // ì í”„ ì¿¨ë‹¤ìš´ ê°„ (ë°€ë¦¬ì´ˆ)
        const gravity = 0.8; // ì¤‘ë ¥ ê°•ë„ ì¦ê°€
        const jumpForce = 10;
        let isOnGround = true;
        const moveSpeed = 5;
        const maxFallSpeed = 10; // ìµœëŒ€ ë‚™í•˜ ì†ë„ ì„¤ì •
        let lastMoveTime = 0;
        const moveDelay = 200; // ì—°ì† ì´ë™ ì‚¬ì´ì˜ ì§€ì—° ì‹œê°„ (ë°€ë¦¬ì´ˆ)
        let keyState = {
            ArrowLeft: false,
            ArrowRight: false,
            ArrowUp: false,
            ArrowDown: false,
            KeyW: false,
            KeyA: false,
            KeyS: false,
            KeyD: false
        };

        const stages = [
            // ìŠ¤í…Œì´ì§€ 1
            [
                { x: 100, y: 0, width: 20, height: 400 },
                { x: 100, y: 500, width: 420, height: 20 },
                { x: 500, y: 100, width: 100, height: 20 },
                { x: 200, y: 100, width: 20, height: 300 },
                { x: 300, y: 200, width: 200, height: 20 },
                { x: 400, y: 200, width: 20, height: 200 },
                { x: 500, y: 100, width: 20, height: 400 },
            ],
            // ìŠ¤í…Œì´ì§€ 2
            [
                { x: 0, y: 100, width: 500, height: 20 },
                { x: 100, y: 200, width: 20, height: 300 },
                { x: 200, y: 300, width: 400, height: 20 },
                { x: 300, y: 0, width: 20, height: 200 },
                { x: 400, y: 400, width: 20, height: 200 },
            ],
            // ìŠ¤í…Œì´ì§€ 3
            [
                { x: 0, y: 300, width: 520, height: 20 },
                { x: 200, y: 0, width: 20, height: 200 },
                { x: 200, y: 300, width: 20, height: 200 },

                { x: 300, y: 400, width: 300, height: 20 },
                { x: 500, y: 200, width: 20, height: 100 },
                { x: 300, y: 80, width: 200, height: 20 },
                { x: 300, y: 0, width: 20, height: 200 },


            ],
            // ìŠ¤í…Œì´ì§€ 4
            [
                { x: 100, y: 100, width: 20, height: 200 },
                { x: 100, y: 300, width: 100, height: 20 },
                { x: 100, y: 400, width: 20, height: 100 },
                { x: 100, y: 100, width: 200, height: 20 },
                { x: 200, y: 400, width: 20, height: 100 },
                { x: 200, y: 200, width: 100, height: 20 },
                { x: 300, y: 100, width: 20, height: 400 },
                { x: 300, y: 400, width: 120, height: 20 },
                { x: 400, y: 100, width: 20, height: 300 },
                { x: 400, y: 500, width: 20, height: 100 },
                { x: 400, y: 100, width: 200, height: 20 },
                { x: 500, y: 200, width: 20, height: 400 },
                { x: 0, y: 500, width: 220, height: 20 },
            ],
            // ìŠ¤í…Œì´ 5
            [
                { x: 0, y: 300, width: 400, height: 20 },
                { x: 200, y: 0, width: 20, height: 200 },
                { x: 300, y: 400, width: 20, height: 200 },
            ],
            // ìŠ¤í…Œì´ì§€ 6
            [
                { x: 100, y: 0, width: 20, height: 400 },
                { x: 300, y: 100, width: 300, height: 20 },
                { x: 300, y: 300, width: 20, height: 200 },
                { x: 300, y: 300, width: 300, height: 20 },
                { x: 500, y: 400, width: 20, height: 200 },
            ],
            // ìŠ¤í…Œì´ì§€ 7
            [
                { x: 0, y: 100, width: 600, height: 20 },
                { x: 150, y: 300, width: 20, height: 300 },
                { x: 0, y: 300, width: 600, height: 20 },
                { x: 400, y: 100, width: 200, height: 20 },
                { x: 0, y: 500, width: 600, height: 20 },
                { x: 350, y: 100, width: 20, height: 500 },
                { x: 200, y: 0, width: 20, height: 100 },
            ],
            // ìŠ¤í…Œì´ì§€ 8
            [
                
                { x: 100, y: 200, width: 20, height: 400 },
                { x: 100, y: 500, width: 300, height: 20 },
                { x: 300, y: 100, width: 300, height: 20 },
                { x: 200, y: 100, width: 20, height: 320 },
                { x: 400, y: 200, width: 100, height: 20 },
                { x: 400, y: 200, width: 20, height: 100 },
                { x: 500, y: 200, width: 20, height: 200 },
                { x: 0, y: 100, width: 200, height: 20 },
                { x: 100, y: 200, width: 20, height: 300 },
                { x: 200, y: 300, width: 300, height: 20 },
                { x: 300, y: 100, width: 20, height: 100 },
                { x: 400, y: 400, width: 20, height: 200 },
                { x: 300, y: 400, width: 100, height: 20 },
                
            ],
            // ìŠ¤í…Œì´ì§€ 9
            [
                { x: 0, y: 300, width: 500, height: 20 },
                { x: 200, y: 100, width: 20, height: 400 },
                { x: 300, y: 0, width: 20, height: 220 },
                { x: 500, y: 100, width: 100, height: 20 },
                { x: 500, y: 300, width: 20, height: 200 },
                { x: 0, y: 500, width: 100, height: 20 },
                { x: 300, y: 500, width: 100, height: 20 },
                { x: 100, y: 300, width: 20, height: 100 },
                { x: 300, y: 500, width: 20, height: 100 },
                { x: 400, y: 300, width: 20, height: 100 },
                { x: 400, y: 400, width: 100, height: 20 },
                { x: 400, y: 220, width: 20, height: 100 },


            ],
            // ìŠ¤í…Œì´ì§€ 10
            [
                { x: 100, y: 0, width: 20, height: 300 },
                { x: 100, y: 400, width: 20, height: 200 },
                { x: 200, y: 200, width: 300, height: 20 },
                { x: 300, y: 300, width: 20, height: 200 },
                { x: 400, y: 200, width: 20, height: 300 },
                { x: 500, y: 200, width: 20, height: 100 },
                { x: 500, y: 400, width: 20, height: 200 },
                { x: 200, y: 400, width: 200, height: 20 },
                { x: 500, y: 100, width: 100, height: 20 },
                { x: 300, y: 100, width: 100, height: 20 },

                
            ],
        ];

        let currentStage = 0;
        let walls = [];

        // ì „ì—­ ë³€ìˆ˜ ê°€
        let portalCooldown = false;
        const portal1 = document.getElementById('portal1');
        const portal2 = document.getElementById('portal2');
        const portal3 = document.getElementById('portal3');
        const portal4 = document.getElementById('portal4');
        const portal5 = document.getElementById('portal5');
        const portal6 = document.getElementById('portal6');
        const portal7 = document.getElementById('portal7');
        const portal8 = document.getElementById('portal8');
        const portal9 = document.getElementById('portal9');
        const portal10 = document.getElementById('portal10');
        const portal11 = document.getElementById('portal11');
        const portal12 = document.getElementById('portal12');
        const portal13 = document.getElementById('portal13');
        const portal14 = document.getElementById('portal14');
        const portal15 = document.getElementById('portal15');
        const portal16 = document.getElementById('portal16');
        const portal17 = document.getElementById('portal17');
        const portal18 = document.getElementById('portal18');
        const portal19 = document.getElementById('portal19');
        const portal20 = document.getElementById('portal20');
        const portal21 = document.getElementById('portal21');
        const portal22 = document.getElementById('portal22');
        const portal23 = document.getElementById('portal23');
        const portal24 = document.getElementById('portal24');
        const portal25 = document.getElementById('portal25');
        const portal26 = document.getElementById('portal26');
        const portal27 = document.getElementById('portal27');
        const portal28 = document.getElementById('portal28');
        const portal29 = document.getElementById('portal29');
        const portal30 = document.getElementById('portal30');
        const portal31 = document.getElementById('portal31');
        const portal32 = document.getElementById('portal32');
        const portal33 = document.getElementById('portal33');
        const portal34 = document.getElementById('portal34');
        const portal35 = document.getElementById('portal35');
        const portal36 = document.getElementById('portal36');
        const portal37 = document.getElementById('portal37');
        const portal38 = document.getElementById('portal38');
        const portal39 = document.getElementById('portal39');
        const portal40 = document.getElementById('portal40');
        const portal41 = document.getElementById('portal41');
        const portal42 = document.getElementById('portal42');
        const portal43 = document.getElementById('portal43');
        const portal44 = document.getElementById('portal44');
        

        // dangerZones ê°ì²´ì— 10ìŠ¤í…Œì´(index 9)ì˜ ìœ„ êµ¬ì—­ ì¶”ê°€
        const dangerZones = {
            4: [  // ìŠ¤í…Œì´ì§€ 5ì˜ ìœ„í—˜ êµ¬ì—­
                { x: 100, y: 500, width: 200, height: 20 },
                { x: 400, y: 300, width: 100, height: 20 },
                { x: 500, y: 200, width: 20, height: 300 },
                { x: 400, y: 100, width: 200, height: 20 }
            ],
            9: [  // ìŠ¤í…Œì´ì§€ 10ì˜ ìœ„í—˜ êµ¬ì—­
                { x: 120, y: 200, width: 180, height: 20 },
                { x: 300, y: 400, width: 20, height: 100 },
                { x: 400, y: 100, width: 100, height: 20 },
                { x: 200, y: 500, width: 200, height: 20 },
                { x: 150, y: 50, width: 20, height: 150 },
                { x: 350, y: 250, width: 150, height: 20 }
            ]
        };

        const darkDangerZones = {
            5: [  // ìŠ¤í…Œì´ì§€ 6ì˜ ìœ„í—˜ êµ¬ì—­
                { x: 100, y: 500, width: 220, height: 20 },
                { x: 500, y: 300, width: 20, height: 100 },
                { x: 100, y: 200, width: 220, height: 20 },

            ]
        };

        const movingPlatforms = {
            2: [
                {
                    x: 0, y: 500, width: 500, height: 20,  // ì´ˆê¸° ìœ„ì¹˜ì™€ í¬ê¸° 
                    startX: 0, endX: 100,  // xì¶• ì´ë™ ë²”ìœ„
                    startY: 500, endY: 500,  // y ì´ë™ ë²”ìœ„ (ìˆ˜í‰ ì´ë™ë§Œ)
                    speed: 1,  // ì´ë™ ì†ë„
                    direction: 1  // 1: ì˜¤ë¥¸ìª½/ì•„ë˜ë¡œ, -1: ì™¼ìª½/ìœ„ë¡œ
                },
                {
                    x: 400, y: 100, width: 20, height: 220,  // ì´ˆê¸° ìœ„ì¹˜ì™€ í¬ê¸°
                    startX: 400, endX: 400,  // xì¶• ì´ë™ ë²”ìœ„ (ì§ ì´ë™ë§Œ)
                    startY: 100, endY: 180,  // yì¶• ì´ë™ ï¿½ï¿½ìœ„
                    speed: 1,  // ì´ë™ ì†ë„
                    direction: 1  // 1: ì˜¤ë¥¸ìª½/ì•„ë˜ë¡œ, -1: ì™¼ìª½/ìœ„ë¡œ
                },
                {
                    x: 0, y: 100, width: 100, height: 20,  // ì´ˆê¸° ìœ„ì¹˜ì™€ í¬ê¸°
                    startX: 0, endX: 100,  // xì¶• ì´ë™ ë²”ìœ„ (ìˆ˜ì§ ì´ë™ë§Œ)
                    startY: 0, endY: 0,  // yì¶• ì´ë™ ë²”ìœ„
                    speed: 1,  // ì´ë™ ì†ë„
                    direction: 1  // 1: ì˜¤ë¥¸ìª½/ì•„ë˜ë¡œ, -1: ì™¼ìª½/ìœ„ë¡œ
                }
            ]
            
        };

        // ì „ì—­ ë³€ìˆ˜ë¡œ overlay ìš”ì†Œ ì°¸ì¡° ì¶”ê°€
        const lightOverlay = document.getElementById('light-overlay');

        // ì „ì—­ ë³€ìˆ˜ ì¶”ê°€
        let currentBgm = null;
        let isMuted = false;
        const bgmElements = {
            1: document.getElementById('bgm-1'),
            2: document.getElementById('bgm-2'),
            3: document.getElementById('bgm-3'),
            4: document.getElementById('bgm-4'),
            5: document.getElementById('bgm-5'),
            6: document.getElementById('bgm-6'),
            7: document.getElementById('bgm-7'),
            8: document.getElementById('bgm-8'),
            9: document.getElementById('bgm-9'),
            10: document.getElementById('bgm-10')
        };
        let volumeValue = 40; // ì´ˆê¸° ë³¼ë¥¨ê°’

        // ì „ì—­ ë³€ìˆ˜ ì¶”ê°€
        let gameStartTime = Date.now();
        let stageStartTime = Date.now();
        let lastStageTime = 0;

        // ì „ì—­ ë³€ìˆ˜ ì¶”ê°€ (ë‹¤ë¥¸ ì „ì—­ ë³€ìˆ˜ë“¤ê³¼ í•¨ê»˜ ë°°ì¹˜)
        let stageTimer = null;
        let timeLimit = 30;

        // HTMLì— íƒ€ì´ë¨¸ ìš”ì†Œ ì¶”ê°€
        const timerDisplay = document.createElement('div');
        timerDisplay.id = 'stage-timer';
        timerDisplay.style.cssText = `
            position: absolute;
            top: -80px;
            right: 20px;
            font-size: 24px;
            color: #fff;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 15px;
            border-radius: 5px;
            z-index: 100;
            display: none;
        `;
        document.getElementById('game-container').appendChild(timerDisplay);

        // íƒ€ì´ë¨¸ ì‹œì‘ í•¨ìˆ˜
        function startStageTimer() {
            timerDisplay.style.display = 'block';
            timeLimit = 30;
            
            if (stageTimer) clearInterval(stageTimer);
            
            updateTimerDisplay();
            stageTimer = setInterval(() => {
                timeLimit--;
                updateTimerDisplay();
                
                if (timeLimit <= 0) {
                    clearInterval(stageTimer);
                    resetStage8();
                }
            }, 1000);
        }

        // íƒ€ì´ë¨¸ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateTimerDisplay() {
            timerDisplay.textContent = `Time: ${timeLimit}s`;
            timerDisplay.style.color = timeLimit <= 10 ? '#ff0000' : '#fff';
        }

        // ìŠ¤í…Œì´ì§€ 8 ë¦¬ì…‹ í•¨ìˆ˜ ìˆ˜ì •
        function resetStage8() {
            gravityChangeCount = 0;  // ì¤‘ë ¥ ë³€í™” íšŸìˆ˜ ì´ˆê¸°
            updateGravityCounter();
            playerVelocity = { x: 0, y: 0 };
            currentGravity = 'down';
            player.style.left = '20px';
            player.style.top = '540px';
            
            // ì¤‘ë ¥ ë°©í–¥ ì´ˆê¸°í™”
            gameContainer.style.borderColor = 'black';
            gameContainer.style.borderBottomColor = 'green';
            player.style.transform = 'rotate(0deg)';

            // íƒ€ì´ë¨¸ ì¬ì‹œì‘
            startStageTimer();
        }

        // ì´ë²¤íŠ¸ ë¡œê·¸ ê¸°ë¡ í•¨ìˆ˜
        async function logGameEvent(eventType, detail = '') {
            const studentId = localStorage.getItem('studentId');
            const currentTime = new Date().toISOString();
            const sessionDuration = Math.floor((Date.now() - gameStartTime) / 1000); //  ë‹¨ìœ„
            const stageTime = Math.floor((Date.now() - stageStartTime) / 1000); // ì´ˆ ë‹¨ìœ„

            try {
                await fetch('https://script.google.com/macros/s/AKfycbwecWl2pI3YLf0YnjcLWUxUDJF6-o7emGO3in8PJtGbzUPucqyvivEHHiMBaeBJ8XiyYQ/exec', {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify({
                        timestamp: currentTime,
                        studentId: studentId,
                        eventType: eventType,
                        currentStage: currentStage + 1,
                        sessionDuration: sessionDuration,
                        stageTime: stageTime,
                        detail: detail
                    })
                });
            } catch (error) {
                console.error('ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨:', error);
            }
        }

        // ë¡œê·¸ì¸ í•¨ìˆ˜ ìˆ˜ì •
        function initializeUserInfo() {
            const studentId = localStorage.getItem('studentId');
            
            if (!studentId) {
                window.location.href = 'login.html';
                return;
            }

            // ë§¤ ë¡œê·¸ì¸ë§ˆë‹¤ í´ë¦¬ì–´ ê¸°ë¡ ì´ˆê¸°í™”
            localStorage.removeItem('clearedStages');
            updateStageButtons();

            gameStartTime = Date.now();
            stageStartTime = Date.now();
            logGameEvent('LOGIN');

            const studentInfoElement = document.getElementById('student-info');
            studentInfoElement.textContent = `í•™ë²ˆ: ${studentId}`;

            const logoutButton = document.getElementById('logout-button');
            logoutButton.addEventListener('click', () => {
                logGameEvent('LOGOUT').then(() => {
                    localStorage.removeItem('studentId');
                    window.location.href = 'login.html';
                });
            });
        }

        function createStageButtons() {
            const stageButtonsContainer = document.getElementById('stage-buttons');
            const totalStages = stages.length;
            const stagesPerRow = Math.ceil(totalStages / 2);

            for (let i = 0; i < totalStages; i++) {
                const button = document.createElement('button');
                button.textContent = `ìŠ¤í…Œì´ì§€ ${i + 1}`;
                button.className = 'stage-button';
                button.onclick = () => {
                    // ì²« ìŠ¤í…Œì´ì§€ì´ê±°ë‚˜ ì´ì „ ìŠ¤í…Œì´ì§€ë¥¼ í´ë¦¬ì–´í–ˆì„ ë•Œë§Œ ì ‘ê·¼ ê°€ëŠ¥
                    const clearedStages = localStorage.getItem('clearedStages') ? 
                        JSON.parse(localStorage.getItem('clearedStages')) : [];
                    
                    if (i === 0 || clearedStages.includes(i - 1)) {
                        loadStage(i);
                    } else {
                        alert('ì´ì „ ìŠ¤í…Œì´ì§€ë¥¼ ë¨¼ì € í´ë¦¬ì–´í•´ì£¼ì„¸ìš”!');
                    }
                };
                stageButtonsContainer.appendChild(button);

                if (i === stagesPerRow - 1) {
                    stageButtonsContainer.appendChild(document.createElement('br'));
                }
            }
            
            // ì´ˆê¸°ì— ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateStageButtons();
        }
        
        // ìŠ¤í…Œì´ì§€ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateStageButtons() {
            const buttons = document.querySelectorAll('.stage-button');
            const clearedStages = localStorage.getItem('clearedStages') ? 
                JSON.parse(localStorage.getItem('clearedStages')) : [];

            buttons.forEach((button, index) => {
                if (index === 0 || clearedStages.includes(index - 1)) {
                    button.classList.remove('disabled');
                    button.disabled = false;
                } else {
                    button.classList.add('disabled');
                    button.disabled = true;
                }
            });
        }

        // í˜ì´ì§€ ìµœìƒë‹¨ì— ì¶”ê°€
        let lastStage = 0; // ì „ì—­ ë³€ìˆ˜ë¡œ ë§ˆì§€ë§‰ ìŠ¤í…Œì´ì§€ ì €ì¥

        // loadStage í•¨ìˆ˜ ë‚´ë¶€ì— ì¶”ê°€ (ê¸°ì¡´ ì½”ë“œëŠ” ìœ ì§€)
        function loadStage(stageIndex) {
            lastStage = stageIndex; // í˜„ì¬ ìŠ¤í…Œì´ì§€ ì €ì¥
            currentStage = stageIndex;
            
            lastStageTime = Math.floor((Date.now() - stageStartTime) / 1000);
            logGameEvent('STAGE_CHANGE', `Stage ${currentStage + 1} -> ${stageIndex + 1}, Time spent: ${lastStageTime}s`);
            stageStartTime = Date.now();
            
            // ì´ì „ BGM ì •ì§€
            if (currentBgm) {
                currentBgm.pause();
                currentBgm.currentTime = 0;
            }

            // ìƒˆë¡œìš´ BGM ì‹œì‘
            const newBgm = bgmElements[stageIndex + 1];
            if (newBgm) {
                newBgm.volume = volumeValue / 100;
                newBgm.muted = isMuted;
                newBgm.play();
                currentBgm = newBgm;
            }

            document.getElementById('stage-title').textContent = `ìŠ¤í…Œì´ì§€ ${stageIndex + 1}`;

            // 7ìŠ¤í…Œì´ì§€ í¬íƒˆ ë¦¬ ê°œì„ 
            if (stageIndex === 6) { // ìŠ¤í…Œì´ì§€ 7
                // ë¨¼ì € ëª¨ë“  í¬íƒˆ ìˆ¨ê¸°ê¸°
                for(let i = 1; i <= 44; i++) {
                    document.getElementById(`portal${i}`).style.display = 'none';
                }

                // í•„ìš”í•œ í¬íƒˆë§Œ í‘œì‹œ
                const portalsToShow = [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 
                                     17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 
                                     30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 
                                     43, 44];
                
                portalsToShow.forEach(num => {
                    const portal = document.getElementById(`portal${num}`);
                    if (portal) {
                        portal.style.display = 'block';
                    }
                });
            } else if (stageIndex === 1) { // ìŠ¤í…Œì´ì§€ 2
                // ëª¨ë“  í¬íƒˆ ìˆ¨ê¸°ê¸°
                for(let i = 1; i <= 44; i++) {
                    document.getElementById(`portal${i}`).style.display = 'none';
                }

                // ìŠ¤í…Œì´ì§€ 2ì˜ í¬íƒˆë§Œ í‘œì‹œ
                const portal1 = document.getElementById('portal1');
                const portal2 = document.getElementById('portal2');
                if (portal1) portal1.style.display = 'block';
                if (portal2) portal2.style.display = 'block';
            } else {
                // ë‹¤ë¥¸ ìŠ¤í…Œì´ì§€ì—ì„œëŠ” ëª¨ë“  í¬íƒˆ ìˆ¨ê¸°ê¸°
                for(let i = 1; i <= 44; i++) {
                    document.getElementById(`portal${i}`).style.display = 'none';
                }
            }
            
            // ë©”ì‹œì§€ div ì œê±° (ë‹¤ë¥¸ ìŠ¤í…Œì´ì§€ë¡œ ì´ë™í•  ë•Œ)
            const messageDiv = document.getElementById('stage-message');
            if (messageDiv) {
                messageDiv.remove();
            }
            
            // í”Œë ˆì´ì–´ì™€ ëª©í‘œ ì§€ì  ë‹¤ì‹œ í‘œì‹œ
            player.style.display = 'block';
            goal.style.display = 'block';
            
            // ë°°ê²½ ì´ë¯¸ì§€ ë³€ê²½
            const bgElement = document.getElementById('background-image');
            // ë“  stage-bg í´ë˜ìŠ¤ ì œê±°
            bgElement.className = '';
            // ìƒˆë¡œìš´ ìŠ¤í…Œì´ì§€ì˜ ë°°ê²½ í´ë˜ìŠ¤ ì¶”ê°€
            bgElement.className = `stage-bg-${stageIndex + 1}`;
            
            // ê¸°ì¡´ ë²½ ì œê±°
            const existingWalls = document.querySelectorAll('.wall');
            existingWalls.forEach(wall => wall.remove());

            // í¬íƒˆ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
            portal1.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal2.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal3.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal4.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal5.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal6.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal7.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal8.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal9.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal10.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal11.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal12.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal13.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal14.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal15.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal16.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal17.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal18.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal19.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal20.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal21.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal22.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal23.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal24.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal25.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal26.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal27.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal28.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal29.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal30.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal31.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal32.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal33.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal34.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal35.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal36.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal37.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal38.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal39.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal40.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal41.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal42.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal43.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal44.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            

            if (stageIndex === 1) {
                // ìŠ¤í…Œì´ì§€ 2ì˜ í¬íƒˆ ìœ„ì¹˜ ì„¤ì •
                portal2.style.left = '250px';
                portal2.style.top = '50px';
                portal1.style.left = '540px';
                portal1.style.top = '20px';
                
                // ë‚˜ë¨¸ì§€ í¬íƒˆ ìˆ¨ê¸°ê¸°
                for(let i=3; i<=44; i++) {
                    document.getElementById(`portal${i}`).style.display = 'none';
                }
            } else if (stageIndex === 6) {
                // ìŠ¤í…Œì´ì§€ 7ì˜ í¬íƒˆ ìœ„ì¹˜ ì„¤ì •x
                for(let i=1; i<=2; i++) {
                    document.getElementById(`portal${i}`).style.display = 'none';
                }

                portal3.style.left = '100px'; /* ì²«ë²ˆì§¸ */
                portal3.style.top = '540px';
                portal4.style.left = '220px';
                portal4.style.top = '540px';

                portal7.style.left = '175px'; /* ë‘ì§¸  ì›ì */
                portal7.style.top = '540px';
                portal6.style.left = '20px';
                portal6.style.top = '540px';

                portal5.style.left = '305px'; /* ë²ˆì§¸ */
                portal5.style.top = '540px';
                portal8.style.left = '450px';
                portal8.style.top = '540px';

                portal11.style.left = '540px'; /* ë„¤ë²ˆì§¸ */  
                portal11.style.top = '540px';
                portal10.style.left = '300px';
                portal10.style.top = '440px';

                portal9.style.left = '390px'; /* ë‹¤ì„¯ë²ˆì§¸ */
                portal9.style.top = '540px';
                portal12.style.left = '20px';
                portal12.style.top = '540px';

                portal13.style.left = '180px'; /* ì—¬ì„¯ì§¸ ì›ì  */
                portal13.style.top = '440px';
                portal14.style.left = '20px';
                portal14.style.top = '540px';

                portal15.style.left = '180px'; /* ì¼ê³±ë²ˆì§¸ */
                portal15.style.top = '340px';
                portal16.style.left = '20px';
                portal16.style.top = '440px';

                portal17.style.left = '20px'; /* ì—¬ëŸë²ˆì§¸ ï¿½ï¿½ì */
                portal17.style.top = '340px';
                portal18.style.left = '20px';
                portal18.style.top = '540px';

                portal19.style.left = '100px'; /* ì•„í™‰ë²ˆì§¸ */
                portal19.style.top = '340px';
                portal20.style.left = '540px';
                portal20.style.top = '340px';

                portal21.style.left = '540px'; /* ì—´ë²ˆì§¸ */
                portal21.style.top = '440px';
                portal22.style.left = '540px';
                portal22.style.top = '140px';

                portal23.style.left = '390px'; /* ì—´í•œë²ˆì§¸ */
                portal23.style.top = '440px';
                portal24.style.left = '20px';
                portal24.style.top = '540px';

                portal25.style.left = '390px'; /* ì—´ë‘ë²ˆì§¸ */
                portal25.style.top = '340px';
                portal26.style.left = '20px';
                portal26.style.top = '540px';

                portal27.style.left = '390px'; /* ì—´ì„¸ë²ˆì§¸ */
                portal27.style.top = '140px';
                portal28.style.left = '20px';
                portal28.style.top = '540px';

                portal29.style.left = '390px'; /* ì—´ë„¤ë²ˆì§¸ */
                portal29.style.top = '240px';
                portal30.style.left = '20px';
                portal30.style.top = '540px';

                portal31.style.left = '540px'; /* ì—´ë‹¤ì„¯ë²ˆì§¸ */
                portal31.style.top = '240px';
                portal32.style.left = '160px';
                portal32.style.top = '190px'; /* ì§€ê¸ˆì€ ì—¬ê¸°ê¹Œì§€ */

                portal33.style.left = '20px'; /* ì—´ì—¬ì„¯ë²ˆì§¸ */
                portal33.style.top = '240px';
                portal34.style.left = '20px';
                portal34.style.top = '540px';

                portal35.style.left = '20px'; /* ì—´ì¼ê³±ë²ˆì§¸ */
                portal35.style.top = '140px';
                portal36.style.left = '375px';
                portal36.style.top = '30px';

                portal37.style.left = '290px'; /* ì—´ì—¬ëŸë²ˆì§¸ */
                portal37.style.top = '240px';
                portal38.style.left = '20px';
                portal38.style.top = '540px';

                portal39.style.left = '290px'; /* ì—´ì•„í™‰ë²ˆ */
                portal39.style.top = '140px';
                portal40.style.left = '20px';
                portal40.style.top = '540px';

                portal41.style.left = '540px'; /* ìŠ¤í…Œì´ì§€ 8 ì²«ë²ˆì§¸ */
                portal41.style.top = '30px';
                portal42.style.left = '120px';
                portal42.style.top = '30px';

                portal43.style.left = '240px'; /* ìŠ¤í…Œì´ì§€ 8 ë‘ë²ˆ */
                portal43.style.top = '30px';
                portal44.style.left = '20px';
                portal44.style.top = '540px';




            }

            // ìƒˆ ìŠ¤í…Œì´ì§€ì˜ ë²½ ìƒì„±
            walls = stages[stageIndex];
            createWalls();

            // í”Œë ˆì´ì–´ì™€ ëª©í‘œ ìœ„ì¹˜ ì„¤ì •
            resetGame();
            setGoalPosition();

            // ê¸°ì¡´ ìœ„í—˜ êµ¬ì—­ ì œê±°
            const existingDangerZones = document.querySelectorAll('.danger-zone, .dark-danger-zone, .dark-danger-zone-10');
            existingDangerZones.forEach(zone => zone.remove());
            
            // ìŠ¤í…Œì´ì§€ 10ì˜ ìœ„í—˜ êµ¬ì—­ ìƒì„±
            if (stageIndex === 9) {  // ìŠ¤í…Œì´ì§€ 10
                dangerZones[9].forEach(zone => {
                    const dangerZone = document.createElement('div');
                    dangerZone.className = 'dark-danger-zone-10';
                    dangerZone.style.left = zone.x + 'px';
                    dangerZone.style.top = zone.y + 'px';
                    dangerZone.style.width = zone.width + 'px';
                    dangerZone.style.height = zone.height + 'px';
                    gameContainer.appendChild(dangerZone);
                });
            } else if (dangerZones[stageIndex]) {  // ë‹¤ë¥¸ ìŠ¤í…Œì´ì§€
                dangerZones[stageIndex].forEach(zone => {
                    const dangerZone = document.createElement('div');
                    dangerZone.className = 'danger-zone';
                    dangerZone.style.left = zone.x + 'px';
                    dangerZone.style.top = zone.y + 'px';
                    dangerZone.style.width = zone.width + 'px';
                    dangerZone.style.height = zone.height + 'px';
                    gameContainer.appendChild(dangerZone);
                });
            }

            // ìŠ¤í…Œì´ì§€ 6ì˜ ì–´ë‘ìš´ ìœ„í—˜ êµ¬ì—­ ìƒì„±
            if (darkDangerZones[stageIndex]) {
                darkDangerZones[stageIndex].forEach(zone => {
                    const dangerZone = document.createElement('div');
                    dangerZone.className = 'dark-danger-zone';
                    dangerZone.style.left = zone.x + 'px';
                    dangerZone.style.top = zone.y + 'px';
                    dangerZone.style.width = zone.width + 'px';
                    dangerZone.style.height = zone.height + 'px';
                    gameContainer.appendChild(dangerZone);
                });
            }

            // ê¸°ì¡´ ì›€ì§ì´ëŠ” ë°”ë‹¥ ì œê±°
            const existingPlatforms = document.querySelectorAll('.moving-platform');
            existingPlatforms.forEach(platform => platform.remove());

            // í•´ë‹¹ ìŠ¤í…Œì´ì§€ì˜ ì›€ì§ì´ëŠ” ë°”ë‹¥ ìƒì„±
            if (movingPlatforms[stageIndex]) {
                movingPlatforms[stageIndex].forEach(platform => {
                    const movingPlatform = document.createElement('div');
                    movingPlatform.className = 'moving-platform';
                    movingPlatform.style.left = platform.x + 'px';
                    movingPlatform.style.top = platform.y + 'px';
                    movingPlatform.style.width = platform.width + 'px';
                    movingPlatform.style.height = platform.height + 'px';
                    platform.element = movingPlatform;
                    gameContainer.appendChild(movingPlatform);
                });
            }

            // ì¡°ëª… íš¨ê³¼ í† ê¸€ (ìŠ¤í…Œì´ì§€ 4, 6, 10ì— ì ìš©)
            if (stageIndex === 3 || stageIndex === 5 || stageIndex === 9) {  // ìŠ¤í…Œì´ì§€ 4, 6, 10
                lightOverlay.classList.add('active');
                updateLightPosition();
                
                // ë²½ dark-wall í´ë˜ìŠ¤ ì¶”ê°€
                document.querySelectorAll('.wall').forEach(wall => {
                    wall.classList.add('dark-wall');
                });
            } else {
                lightOverlay.classList.remove('active');
                // dark-wall í´ë˜ìŠ¤ ì œê±°
                document.querySelectorAll('.wall').forEach(wall => {
                    wall.classList.remove('dark-wall');
                });
            }

            // íƒ€ì´ë¨¸ ê´€ë ¨ ì½”ë“œ ìˆ˜ì • (loadStage í•¨ìˆ˜ ë‚´)
            if (stageIndex === 7 || stageIndex === 9) {  // ìŠ¤í…Œì´ì§€ 8ê³¼ 10
                startStageTimer();
                if (stageIndex === 7) {  // ìŠ¤í…Œì´ì§€ 8
                    gravityChangeCount = 0;
                    updateGravityCounter();
                } else {  // ìŠ¤í…Œì´ì§€ 10ì—ì„œëŠ”
                    const counter = document.getElementById('gravity-counter');
                    if (counter) counter.remove();
                }
            } else {
                // ë‹¤ë¥¸ ìŠ¤í…Œì´ì§€ì—ì„œëŠ” íƒ€ì´ë¨¸ì™€ ì¹´ìš´í„° ëª¨ë‘ ìˆ¨ê¸°ê¸°
                if (stageTimer) {
                    clearInterval(stageTimer);
                    stageTimer = null;
                }
                timerDisplay.style.display = 'none';
                const counter = document.getElementById('gravity-counter');
                if (counter) counter.remove();
            }
            
            // ê¸°ì¡´ ì¤‘ë ¥ ë¸”ë¡ ì œê±°
            const existingGravityBlocks = document.querySelectorAll('.gravity-block');
            existingGravityBlocks.forEach(block => block.remove());

            // ì¤‘ë ¥ ë¸”ë¡ ìƒì„± (ìŠ¤í…Œì´ì§€ 9ì—ë§Œ)
            if (stageIndex === 8 && gravityBlocks[8]) {
                gravityBlocks[8].forEach(block => {
                    const gravityBlock = document.createElement('div');
                    gravityBlock.className = 'gravity-block';
                    gravityBlock.style.left = block.x + 'px';
                    gravityBlock.style.top = block.y + 'px';
                    gravityBlock.style.width = block.width + 'px';
                    gravityBlock.style.height = block.height + 'px';
                    gravityBlock.dataset.type = block.type;
                    gravityBlock.style.backgroundColor = '#8A2BE2'; // ë³´ë¼ìƒ‰ ì§ì ‘ ì§€ì •
                    gravityBlock.style.position = 'absolute';
                    gravityBlock.style.zIndex = '1';
                    gameContainer.appendChild(gravityBlock);
                });
            }

            // ìŠ¤í…Œì´ì§€ 8ì¼ ë•Œ ì¤‘ë ¥ ë³€í™” ì¹´ìš´í„° ì´ˆê¸°í™”
            if (stageIndex === 7) {  // ìŠ¤í…Œì´ì§€ 8
                gravityChangeCount = 0;
                updateGravityCounter();
            } else {
                // ë‹¤ë¥¸ ìŠ¤í…Œì´ì§€ì—ì„œëŠ” ì¹´ìš´í„° ì œê±°
                const counter = document.getElementById('gravity-counter');
                if (counter) counter.remove();
            }
        }

        function createWalls() {
            walls.forEach((wall, index) => {
                const wallElement = document.createElement('div');
                wallElement.className = 'wall';
                wallElement.style.left = wall.x + 'px';
                wallElement.style.top = wall.y + 'px';
                wallElement.style.width = wall.width + 'px';
                wallElement.style.height = wall.height + 'px';
                gameContainer.appendChild(wallElement);
            });
        }

        function checkWallCollision() {
            const playerLeft = parseFloat(player.style.left);
            const playerTop = parseFloat(player.style.top);
            const playerRight = playerLeft + playerWidth;
            const playerBottom = playerTop + playerHeight;

            // ì¼ë°˜ ë²½ê³¼ ì›€ì§ì´ëŠ” ë²½ì„ ëª¨ë‘ í¬í•¨í•˜ëŠ” ë°°ì—´ ìƒì„±
            let allWalls = [...walls];
            
            // í˜„ì¬ ìŠ¤í…Œì´ì§€ê°€ 3ë©´ ì›€ì§ì´ëŠ” ë²½ë„ ì¶”ê°€
            if ((currentStage === 2 || currentStage === 7) && movingPlatforms[currentStage]) {
                movingPlatforms[currentStage].forEach(platform => {
                    allWalls.push({
                        x: platform.x,
                        y: platform.y,
                        width: platform.width,
                        height: platform.height
                    });
                });
            }

            for (const wall of allWalls) {
                if (playerRight > wall.x && playerLeft < wall.x + wall.width &&
                    playerBottom > wall.y && playerTop < wall.y + wall.height) {
                    // ì¶©ëŒ ë°œìƒ
                    const overlapLeft = playerRight - wall.x;
                    const overlapRight = wall.x + wall.width - playerLeft;
                    const overlapTop = playerBottom - wall.y;
                    const overlapBottom = wall.y + wall.height - playerTop;

                    // ê°€ì¥ ì‘ì€ ê²¹ ì°¾ì•„ ê·¸ ë°©í–¥ìœ¼ ë°€ì–´ëƒ„
                    const minOverlap = Math.min(overlapLeft, overlapRight, overlapTop, overlapBottom);

                    if (minOverlap === overlapLeft) {
                        player.style.left = (wall.x - playerWidth) + 'px';
                        playerVelocity.x = 0;
                    } else if (minOverlap === overlapRight) {
                        player.style.left = (wall.x + wall.width) + 'px';
                        playerVelocity.x = 0;
                    } else if (minOverlap === overlapTop) {
                        player.style.top = (wall.y - playerHeight) + 'px';
                        playerVelocity.y = 0;
                    } else if (minOverlap === overlapBottom) {
                        player.style.top = (wall.y + wall.height) + 'px';
                        playerVelocity.y = 0;
                    }
                }
            }
        }

        function checkCollision() {
            const playerRect = {
                left: parseFloat(player.style.left),
                right: parseFloat(player.style.left) + playerWidth,
                top: parseFloat(player.style.top),
                bottom: parseFloat(player.style.top) + playerHeight
            };

            // ìœ„í—˜ êµ¬ì—­(ë“œì¡´) ì¶©ëŒ ì²´í¬
            const dangerZones = document.querySelectorAll('.danger-zone, .dark-danger-zone, .dark-danger-zone-10');
            for (const zone of dangerZones) {
                const zoneRect = {
                    left: parseFloat(zone.style.left),
                    right: parseFloat(zone.style.left) + parseFloat(zone.style.width),
                    top: parseFloat(zone.style.top),
                    bottom: parseFloat(zone.style.top) + parseFloat(zone.style.height)
                };

                if (isColliding(playerRect, zoneRect)) {
                    resetGame();
                    return;
                }
            }

            let wasOnGround = isOnGround;
            isOnGround = false;

            if (playerRect.left <= 0) {
                player.style.left = '0px';
                playerVelocity.x = 0;
                if (currentGravity === 'left') {
                    isJumping = false;
                    canJump = true;
                    isOnGround = true;
                }
            } else if (playerRect.right >= gameWidth) {
                player.style.left = (gameWidth - playerWidth) + 'px';
                playerVelocity.x = 0;
                if (currentGravity === 'right') {
                    isJumping = false;
                    canJump = true;
                    isOnGround = true;
                }
            }

            if (playerRect.top <= 0) {
                player.style.top = '0px';
                playerVelocity.y = 0;
                if (currentGravity === 'up') {
                    isJumping = false;
                    canJump = true;
                    isOnGround = true;
                }
            } else if (playerRect.bottom >= gameHeight) {
                player.style.top = (gameHeight - playerHeight) + 'px';
                playerVelocity.y = 0;
                if (currentGravity === 'down') {
                    isJumping = false;
                    canJump = true;
                    isOnGround = true;
                }
            }

            checkWallCollision();

            // ë°”ë‹¥ì— ë‹¿ì•˜ì„ ë•Œ ì…ì íš¨ê³¼ ï¿½ï¿½ì„±
            if (!wasOnGround && isOnGround) {
                createParticles();
            }
        }

        function checkPortalCollision() {
            if (portalCooldown) return;

            const playerRect = player.getBoundingClientRect();
            
            if (currentStage === 1) { // ìŠ¤í…Œì´ì§€ 2
                const portal1Rect = portal1.getBoundingClientRect();

                // portal1ì—ì„œ portal2ë¡œë§Œ ì´ë™ ê°€ëŠ¥ (ë‹¨ë°©í–¥)
                if (isColliding(playerRect, portal1Rect)) {
                    player.style.left = parseFloat(portal2.style.left) + 'px';
                    player.style.top = parseFloat(portal2.style.top) + 'px';
                    playerVelocity = { x: 0, y: 0 };
                    portalCooldown = true;
                    setTimeout(() => portalCooldown = false, 100);
                }
            } 
            else if (currentStage === 6) { // ìŠ¤í…Œì´ì§€ 7
                const portalPairs = [
                    [portal3, portal4],
                    [portal5, portal6],
                    [portal7, portal8],
                    [portal9, portal10],
                    [portal11, portal12],
                    [portal13, portal14],
                    [portal15, portal16],
                    [portal17, portal18],
                    [portal19, portal20],
                    [portal21, portal22],
                    [portal23, portal24],
                    [portal25, portal26],
                    [portal27, portal28],
                    [portal29, portal30],
                    [portal31, portal32],
                    [portal33, portal34],
                    [portal35, portal36],
                    [portal37, portal38],
                    [portal39, portal40],
                    [portal41, portal42],
                    [portal43, portal44]
                ];

                for (const [portalA, portalB] of portalPairs) {
                    const portalARect = portalA.getBoundingClientRect();

                    if (isColliding(playerRect, portalARect)) {
                        player.style.left = parseFloat(portalB.style.left) + 'px';
                        player.style.top = parseFloat(portalB.style.top) + 'px';
                        playerVelocity = { x: 0, y: 0 };
                        portalCooldown = true;
                        setTimeout(() => portalCooldown = false, 100);
                        break;
                    }
                }
            }
        }

        function isColliding(rect1, rect2) {
            const margin = 5; // ì¶©ëŒ ê°ì§€ ì—¬ìœ  ê³µê°„
            return !(rect1.right - margin < rect2.left || 
                     rect1.left + margin > rect2.right || 
                     rect1.bottom - margin < rect2.top || 
                     rect1.top + margin > rect2.bottom);
        }

        function updateMovingPlatforms() {
            // ìŠ¤í…Œì´ì§€ 3 ë˜ëŠ” ìŠ¤í…Œì´ì§€ 8ì—ì„œë§Œ ì‹¤í–‰
            if (currentStage !== 2 ) return;  

            if (movingPlatforms[currentStage]) {
        movingPlatforms[currentStage].forEach(platform => {
            if (platform.element) {  // elementê°€ ì¡´ì¬í•  ë•Œë§Œ ì‹¤í–‰
                // ìˆ˜í‰ ì´ë™
                if (platform.startX !== platform.endX) {
                    platform.x += platform.speed * platform.direction;
                    if (platform.x >= platform.endX || platform.x <= platform.startX) {
                        platform.direction *= -1;
                    }
                    platform.element.style.left = platform.x + 'px';
                }
                // ìˆ˜ì§ ì´ë™
                if (platform.startY !== platform.endY) {
                    platform.y += platform.speed * platform.direction;
                    if (platform.y >= platform.endY || platform.y <= platform.startY) {
                        platform.direction *= -1;
                    }
                    platform.element.style.top = platform.y + 'px';
                }
            }
        });
    }
        }

        // ì¡°ëª… ìœ„ì¹˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateLightPosition() {
            if (currentStage !== 3 && currentStage !== 5 && currentStage !== 9) return;  // ìŠ¤í…Œì´ì§€ 4, 6, 10ì—ì„œë§Œ ì‹¤í–‰
            
            const x = parseFloat(player.style.left) + (playerWidth / 2);
            const y = parseFloat(player.style.top) + (playerHeight / 2);
            
            lightOverlay.style.maskImage = `radial-gradient(circle at ${x}px ${y}px, transparent 30px, black 50px)`;
            lightOverlay.style.webkitMaskImage = `radial-gradient(circle at ${x}px ${y}px, transparent 30px, black 50px)`;
        }

        // ìºë¦­í„° ì¶©ëŒ ì˜ì—­ ì„¤ì • (ì „ì—­ ë³€ìˆ˜ë¡œ ì¶”ê°€)
        const playerCollision = {
            topOffset: 5,      // ìœ„ìª½ ì—¬ë°±
            bottomOffset: 5,   // ì•„ë˜ìª½ ì—¬ë°±
            leftOffset: 10,     // ì™¼ìª½ ì—¬ë°±
            rightOffset: 10,    // ì˜¤ë¥¸ìª½ ì—¬ë°±
            tolerance: 10      // ì¶©ëŒ ê°ì§€ ì—¬ìœ  ê°’
        };

        function update() {
            if (currentGravity === 'left') {
                playerVelocity.x = Math.max(playerVelocity.x - gravity, -maxFallSpeed);
            } else if (currentGravity === 'right') {
                playerVelocity.x = Math.min(playerVelocity.x + gravity, maxFallSpeed);
            } else if (currentGravity === 'up') {
                playerVelocity.y = Math.max(playerVelocity.y - gravity, -maxFallSpeed);
            } else if (currentGravity === 'down') {
                playerVelocity.y = Math.min(playerVelocity.y + gravity, maxFallSpeed);
            }

            player.style.left = (parseFloat(player.style.left) + playerVelocity.x) + 'px';
            player.style.top = (parseFloat(player.style.top) + playerVelocity.y) + 'px';

            checkCollision();
            updateMovingPlatforms();  // ì›€ì§ì´ëŠ” ë°”ë‹¥ ì—…ë°ì´íŠ¸
            checkDangerZones();
            updateLightPosition();  // ì¡°ëª… ìœ„ì¹˜ ì—…ë°íŠ¸ ì¶”ê°€
            updateDangerZoneVisibility();  // ì¶”ê°€
            checkGoalCollision();
            checkPortalCollision();

            // ì›€ì§ì´ëŠ” í”Œí¼ ì—…ë°ì´íŠ¸
            if (movingPlatforms[currentStage]) {
                movingPlatforms[currentStage].forEach(platform => {
                    // í”Œë«í¼ ë™ ë¡œì§
                    if (platform.startX !== platform.endX) {
                        platform.x += platform.speed * platform.direction;
                        if (platform.x >= platform.endX || platform.x <= platform.startX) {
                            platform.direction *= -1;
                        }
                    }
                    if (platform.startY !== platform.endY) {
                        platform.y += platform.speed * platform.direction;
                        if (platform.y >= platform.endY || platform.y <= platform.startY) {
                            platform.direction *= -1;
                        }
                    }

                    // í”Œë ˆì´ì–´ì˜ ì‹¤ì œ ì¶©ëŒ ì˜ ê³„ì‚°
                    const playerLeft = parseFloat(player.style.left) + playerCollision.leftOffset;
                    const playerTop = parseFloat(player.style.top) + playerCollision.topOffset;
                    const playerRight = parseFloat(player.style.left) + playerWidth - playerCollision.rightOffset;
                    const playerBottom = parseFloat(player.style.top) + playerHeight - playerCollision.bottomOffset;

                    // í”Œë«í¼ê³¼ì˜ ëŒ ê°ì§€
                    if (playerRight > platform.x && 
                        playerLeft < platform.x + platform.width && 
                        playerBottom > platform.y && 
                        playerTop < platform.y + platform.height) {
                        
                        // ì¶©ëŒ ë°©í–¥ í™•ì¸ (tolerance ê°’ ì‚¬ìš©)
                        const bottomCollision = Math.abs(playerBottom - platform.y) < playerCollision.tolerance;
                        const topCollision = Math.abs(playerTop - (platform.y + platform.height)) < playerCollision.tolerance;
                        const leftCollision = Math.abs(playerRight - platform.x) < playerCollision.tolerance;
                        const rightCollision = Math.abs(playerLeft - (platform.x + platform.width)) < playerCollision.tolerance;

                        // ë°”ë‹¥ ì¶©ëŒ
                        if (bottomCollision && playerVelocity.y >= 0) {
                            player.style.top = (platform.y - playerHeight + playerCollision.bottomOffset) + 'px';
                            playerVelocity.y = 0;
                            isOnGround = true;
                        }
                        // ì²œì¥ ì¶©ëŒ
                        else if (topCollision && playerVelocity.y <= 0) {
                            player.style.top = (platform.y + platform.height - playerCollision.topOffset) + 'px';
                            playerVelocity.y = 0;
                        }
                        // ì¸¡ë©´ ì¶©ëŒ
                        else if (leftCollision && playerVelocity.x >= 0) {
                            player.style.left = (platform.x - playerWidth + playerCollision.rightOffset) + 'px';
                            playerVelocity.x = 0;
                        }
                        else if (rightCollision && playerVelocity.x <= 0) {
                            player.style.left = (platform.x + platform.width - playerCollision.leftOffset) + 'px';
                            playerVelocity.x = 0;
                        }
                    }
                });
            }

            // ë§µ ê²½ê³„ ì²´í¬ (ì¶©ëŒ ì˜ì—­ ê³ ë ¤)
            const playerX = parseFloat(player.style.left) + playerCollision.leftOffset;
            const playerY = parseFloat(player.style.top) + playerCollision.topOffset;
            const adjustedWidth = playerWidth - (playerCollision.leftOffset + playerCollision.rightOffset);
            const adjustedHeight = playerHeight - (playerCollision.topOffset + playerCollision.bottomOffset);

            if (playerX < 0 || playerX + adjustedWidth > gameWidth || 
                playerY < 0 || playerY + adjustedHeight > gameHeight) {
                resetGame();
                // 10ìŠ¤í…Œì´ì§€ì—ì„œ ê²½ê³„ì— ë‹¿ì•˜ì„ ë•Œë„ íƒ€ì´ë¨¸ ì´ˆê¸°í™”
                if (currentStage === 9) {
                    resetStageTimer();
                }
            }

            // ë ¥ ë¸”ë¡ ì—…ë°ì´íŠ¸ (ìŠ¤í…Œì´ì§€ 9ì—ë§Œ)
            if (currentStage === 8) {
                updateGravityBlocks();
            }

            requestAnimationFrame(update);
        }

        // í”Œë ˆì–´ ìœ„ì¹˜ ë¦¬ì…‹ í•¨ìˆ˜ ì¶”ê°€
        function resetPlayerPosition() {
            playerVelocity = { x: 0, y: 0 };
            currentGravity = 'down';
            
            // ìŠ¤í…Œì´ì§€ë³„ ì‹œì‘ ìœ„ì¹˜ë¡œ ì´ë™
            switch(currentStage) {
                case 2: // ìŠ¤í…Œì´ì§€ 3
                    player.style.left = '30px';
                    player.style.top = '30px';
                    break;
                // ë‹¤ë¥¸ ìŠ¤í…Œì´ì§€ì˜ ì‹œì‘ ìœ„ì¹˜ë„ í•„í•˜ë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€
                default:
                    player.style.left = '30px';
                    player.style.top = '30px';
            }
        }

        function handleKeyDown(event) {
            const currentTime = Date.now();
            if (currentTime - lastMoveTime < moveDelay) return;

            if (keyState[event.code]) return;

            keyState[event.code] = true;
            lastMoveTime = currentTime;

            // ìŠ¤í…Œì´ì§€ 10ì—ì„œëŠ” ë°©í–¥í‚¤ ë°˜ì „
            if (currentStage === 9) { // 0-based indexì´ë¯€ë¡œ ìŠ¤í…Œì´ì§€ 10ì€ 9
                switch (event.code) {
                    case 'ArrowLeft':
                    case 'KeyA':
                        playerVelocity.x = moveSpeed; // ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™
                        break;
                    case 'ArrowRight':
                    case 'KeyD':
                        playerVelocity.x = -moveSpeed; // ì™¼ìª½ìœ¼ë¡œ ì´ë™
                        break;
                    case 'ArrowUp':
                    case 'KeyW':
                        playerVelocity.y = moveSpeed; // ì•„ë˜ë¡œ ì´ë™
                        break;
                    case 'ArrowDown':
                    case 'KeyS':
                        playerVelocity.y = -moveSpeed; // ìœ„ë¡œ ì´
                        break;
                }
            } else {
                // ê¸°ì¡´ ë°©í–¥í‚¤ ë™ì‘
                switch (event.code) {
                    case 'ArrowLeft':
                    case 'KeyA':
                        playerVelocity.x = -moveSpeed;
                        break;
                    case 'ArrowRight':
                    case 'KeyD':
                        playerVelocity.x = moveSpeed;
                        break;
                    case 'ArrowUp':
                    case 'KeyW':
                        playerVelocity.y = -moveSpeed;
                        break;
                    case 'ArrowDown':
                    case 'KeyS':
                        playerVelocity.y = moveSpeed;
                        break;
                }
            }

            // WASD í‚¤ë¡œ ì¤‘ë ¥ ë³€ê²½ (ìŠ¤í…Œì´ì§€ 10ì—ì„œë„ ë™ì¼í•˜ê²Œ ìœ ì§€)
            switch (event.code) {
                case 'KeyW':
                    changeGravity('up');
                    break;
                case 'KeyA':
                    changeGravity('left');
                    break;
                case 'KeyS':
                    changeGravity('down');
                    break;
                case 'KeyD':
                    changeGravity('right');
                    break;
            }
        }

        function handleKeyUp(event) {
            keyState[event.code] = false;

            // ìŠ¤í…Œì´ì§€ 10ì—ì„œëŠ” ë°©í–¥í‚¤ ë°˜ì „
            if (currentStage === 9) {
                switch (event.code) {
                    case 'ArrowLeft':
                    case 'KeyA':
                        if (playerVelocity.x > 0) playerVelocity.x = 0;
                        break;
                    case 'ArrowRight':
                    case 'KeyD':
                        if (playerVelocity.x < 0) playerVelocity.x = 0;
                        break;
                    case 'ArrowUp':
                    case 'KeyW':
                        if (playerVelocity.y > 0) playerVelocity.y = 0;
                        break;
                    case 'ArrowDown':
                    case 'KeyS':
                        if (playerVelocity.y < 0) playerVelocity.y = 0;
                        break;
                }
            } else {
                // ê¸°ì¡´ ë°©í–¥í‚¤ ë™ì‘
                switch (event.code) {
                    case 'ArrowLeft':
                    case 'KeyA':
                        if (playerVelocity.x < 0) playerVelocity.x = 0;
                        break;
                    case 'ArrowRight':
                    case 'KeyD':
                        if (playerVelocity.x > 0) playerVelocity.x = 0;
                        break;
                    case 'ArrowUp':
                    case 'KeyW':
                        if (playerVelocity.y < 0) playerVelocity.y = 0;
                        break;
                    case 'ArrowDown':
                    case 'KeyS':
                        if (playerVelocity.y > 0) playerVelocity.y = 0;
                        break;
                }
            }
        }

        function resetGame() {
            player.style.left = '10px';
            player.style.top = (gameHeight - playerHeight - 10) + 'px';
            playerVelocity = { x: 0, y: 0 };
            
            // 10ìŠ¤í…Œì´ì§€ì—ì„œëŠ” í•­ìƒ íƒ€ì´ë¨¸ ì´ˆê¸°í™”
            if (currentStage === 9) {
                resetStageTimer();
            }
            
            // ìŠ¤í…Œì´ì§€ 8ì—ì„œëŠ” í•­ìƒ ì•„ë˜ ë°©í–¥ìœ¼ë¡œ ì¤‘ë ¥ ì´ˆê¸°í™”
            if (currentStage === 7) {
                changeGravity('down');
            } else {
                // ë‹¤ë¥¸ ìŠ¤í…Œì´ì§€ëŠ” ê¸°ì¡´ëŒ€ë¡œ ìœ ì§€
                changeGravity('down');
            }
        }

        function createParticles() {
            const particleCount = 20;
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                const angle = Math.random() * 2 * Math.PI;
                const distance = Math.random() * 50;
                particle.style.setProperty('--x', `${Math.cos(angle) * distance}px`);
                particle.style.setProperty('--y', `${Math.sin(angle) * distance}px`);
                particle.style.left = `${parseFloat(player.style.left) + playerWidth / 2}px`;
                particle.style.top = `${parseFloat(player.style.top) + playerHeight / 2}px`;
                gameContainer.appendChild(particle);

                // ì¼ì • ì‹œê°„ í›„ ì…ì ì œê±°
                setTimeout(() => {
                    particle.remove();
                }, 1000);
            }
        }

        // ì „ì—­ ë³€ìˆ˜ ì¶”ê°€
        let gravityChangeCount = 0;
        const MAX_GRAVITY_CHANGES = 5;

        // changeGravity í•¨ìˆ˜ ìˆ˜ì •
        function changeGravity(direction) {
            // ìŠ¤í…Œì´ì§€ 8ì—ì„œë§Œ ì¤‘ë ¥ ë³€í™” ì œí•œ ì ìš©
            if (currentStage === 7) {  // ìŠ¤í…Œì´ì§€ 8
                if (gravityChangeCount >= MAX_GRAVITY_CHANGES) {
                    resetStage8();
                    return;
                }
                gravityChangeCount++;
                updateGravityCounter();
            }

            currentGravity = direction;
            playerVelocity.x = 0;
            playerVelocity.y = 0;
            gameContainer.style.borderColor = 'black';

            let rotation = 0;
            switch(direction) {
                case 'left':
                    gameContainer.style.borderLeftColor = 'green';
                    rotation = 90;
                    break;
                case 'right':
                    gameContainer.style.borderRightColor = 'green';
                    rotation = -90;
                    break;
                case 'up':
                    gameContainer.style.borderTopColor = 'green';
                    rotation = 180;
                    break;
                case 'down':
                    gameContainer.style.borderBottomColor = 'green';
                    rotation = 0;
                    break;
            }
            player.style.transform = `rotate(${rotation}deg)`;
        }

        function setGoalPosition() {
            // ê° ìŠ¤í…Œì´ì§€ë§ˆ ë‹¤ë¥¸ ëª© ìœ„ ì„¤ì •
            const goalPositions = [
                { x: 540, y: 30 }, //1ë²ˆ ìŠ¤í…Œì´ì§€
                { x: 30, y: 30 }, //2ë²ˆ ìŠ¤í…Œì´ì§€
                { x: 30, y: 30 }, //3ë²ˆ ìŠ¤í…Œì´ì§€    
                { x: 540, y: 30 }, //4ë²ˆ ìŠ¤í…Œì´ì§€
                { x: 30, y: 30 }, //5ë²ˆ ìŠ¤í…Œì´ì§€
                { x: 540, y: 30 }, //6ë²ˆ í…Œì´ì§€
                { x: 30, y: 30 }, //7ë²ˆ ìŠ¤í…Œì´ì§€
                { x: 540, y: 30 }, //8ë²ˆ ìŠ¤í…Œì´
                { x: 30, y: 30 }, //9ë²ˆ ìŠ¤í…Œì´ì§€   
                { x: 540, y: 30 }, //10ë²ˆ ìŠ¤í…Œì´ì§€
            ];

            const position = goalPositions[currentStage];
            goal.style.left = `${position.x}px`;
            goal.style.top = `${position.y}px`;
        }

        function checkGoalCollision() {
            const playerRect = player.getBoundingClientRect();
            const goalRect = goal.getBoundingClientRect();

            if (isColliding(playerRect, goalRect)) {
                // ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´ ì‹œê°„ ê¸°ë¡
                const stageTime = Math.floor((Date.now() - stageStartTime) / 1000);
                logGameEvent('STAGE_CLEAR', `Time: ${stageTime}s`);

                // í´ë¦¬ì–´í•œ ìŠ¤í…Œì´ì§€ ì €ì¥
                const clearedStages = localStorage.getItem('clearedStages') ? 
                    JSON.parse(localStorage.getItem('clearedStages')) : [];
                if (!clearedStages.includes(currentStage)) {
                    clearedStages.push(currentStage);
                    localStorage.setItem('clearedStages', JSON.stringify(clearedStages));
                }

                // ìŠ¤í…Œì´ì§€ 10 í´ë¦¬ì–´ ì‹œ ì—”ë”© í˜ì´ì§€ë¡œ ì´ë™
                if (currentStage === 9) {  // 0-based indexì´ë¯€ë¡œ 9ëŠ” ìŠ¤í…Œì´ì§€ 10
                    window.location.href = 'https://forms.gle/CR2ZSotBoJf6zsB19';
                    return;
                }

                // ë‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ ì´ë™
                loadStage(currentStage + 1);
                updateStageButtons();
            }
        }
        

        // checkDangerZones í•¨ìˆ˜ ìˆ˜ì •
        function checkDangerZones() {
            if (currentStage !== 4 && currentStage !== 5 && currentStage !== 9) return;
            
            const playerLeft = parseFloat(player.style.left);
            const playerTop = parseFloat(player.style.top);
            const playerRight = playerLeft + playerWidth;
            const playerBottom = playerTop + playerHeight;
            
            if (currentStage === 9) {  // ìŠ¤í…Œì´ì§€ 10
                const dangerZones = document.querySelectorAll('.dark-danger-zone-10');
                dangerZones.forEach(zone => {
                    const zoneLeft = parseFloat(zone.style.left);
                    const zoneTop = parseFloat(zone.style.top);
                    const zoneRight = zoneLeft + parseFloat(zone.style.width);
                    const zoneBottom = zoneTop + parseFloat(zone.style.height);
                    
                    if (playerRight > zoneLeft && 
                        playerLeft < zoneRight && 
                        playerBottom > zoneTop && 
                        playerTop < zoneBottom) {
                        resetGame();
                        // íƒ€ì´ë¨¸ ì´ˆê¸°í™” ì¶”ê°€
                        if (stageTimer) {
                            clearInterval(stageTimer);
                        }
                        timeLimit = 30; // ì‹œê°„ ì´ˆê¸°í™”
                        startStageTimer(); // íƒ€ì´ë¨¸ ì¬ì‹œì‘
                    }
                });
            } else {
                // ... ê¸°ì¡´ ìœ„í—˜ êµ¬ì—­ ì²´í¬ ì½”ë“œ ...
            }
        }

        // ë³¼ë¥¨ ì»¨íŠ¸ë¡¤ ì´ë²¤íŠ¸ ì¶”ê°€
        function initializeAudio() {
            const muteButton = document.getElementById('mute-button');
            const volumeSlider = document.getElementById('volume-slider');
            const volumeDisplay = document.getElementById('volume-value');

            // ëª¨ë“  BGM ìš”ì†Œì— ì´ˆê¸° ë³¼ë¥¨ ì„¤ì •
            Object.values(bgmElements).forEach(audio => {
                audio.volume = volumeValue / 100;
            });

            // ìŒì†Œê±° ë²„íŠ¼ ì´ë²¤íŠ¸
            muteButton.addEventListener('click', () => {
                isMuted = !isMuted;
                muteButton.textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
                
                Object.values(bgmElements).forEach(audio => {
                    audio.muted = isMuted;
                });
                
                logGameEvent('MUTE_TOGGLE', isMuted ? 'muted' : 'unmuted');
            });

            // ë³¼ë¥¨ ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
            volumeSlider.addEventListener('input', () => {
                const newVolume = volumeSlider.value;
                volumeValue = newVolume;
                volumeDisplay.textContent = `${newVolume}%`;
                
                Object.values(bgmElements).forEach(audio => {
                    audio.volume = newVolume / 100;
                });
            });
        }

        function initializeReviewSystem() {
            const stars = document.querySelectorAll('.star');
            const ratingValue = document.getElementById('rating-value');
            const submitButton = document.getElementById('submit-review');
            const reviewText = document.getElementById('review-text');
            let currentRating = 0;

            // ë³„ì  ì‹œìŠ¤í…œ
            stars.forEach(star => {
                star.addEventListener('mouseover', () => {
                    const rating = parseInt(star.dataset.rating);
                    highlightStars(rating);
                });

                star.addEventListener('mouseout', () => {
                    highlightStars(currentRating);
                });

                star.addEventListener('click', () => {
                    currentRating = parseInt(star.dataset.rating);
                    ratingValue.textContent = `${currentRating}ì `;
                    highlightStars(currentRating);
                });
            });

            function highlightStars(rating) {
                stars.forEach(star => {
                    const starRating = parseInt(star.dataset.rating);
                    star.classList.toggle('active', starRating <= rating);
                });
            }

            // í›„ê¸° ì œì¶œ
            submitButton.addEventListener('click', async () => {
                if (currentRating === 0) {
                    alert('ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
                    return;
                }

                if (!reviewText.value.trim()) {
                    alert('í›„ê¸°ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”!');
                    return;
                }

                try {
                    const response = await fetch('https://script.google.com/macros/s/AKfycbyUKeIf0S-tTQYwJCchUROJbJS4dEMLZxBGKuzodpe-1cuabZSSTmPF9VUy0LM7aNk/exec', {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8',
                        },
                        body: JSON.stringify({
                            rating: currentRating,
                            review: reviewText.value,
                            timestamp: new Date().toISOString()
                        })
                    });

                    alert('í›„ê¸°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!');
                    currentRating = 0;
                    reviewText.value = '';
                    ratingValue.textContent = '0ì ';
                    highlightStars(0);

                } catch (error) {
                    console.error('í›„ê¸° ì œì¶œ ì˜¤ë¥˜:', error);
                    alert('í›„ê¸° ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            });
        }

        // ì´ˆê¸°í™” ì½”ë“œì— ì¶”ê°€
        initializeUserInfo();
        initializeAudio();
        initializeReviewSystem();
        createStageButtons();

        // window.onload ì´ë²¤íŠ¸ ìˆ˜ì •
        window.onload = function() {
            // ë§ˆì§€ë§‰ ì €ì¥ëœ ìŠ¤í…Œì´ì§€ë¡œ ë¡œë“œ
            loadStage(lastStage);
            
            // BGM ì´ˆê¸°í™”
            for (let i = 1; i <= 10; i++) {
                bgmElements[i] = document.getElementById(`bgm-${i}`);
            }
            
            update();
        };

        document.addEventListener('keydown', handleKeyDown);
        document.addEventListener('keyup', handleKeyUp);


        let sessionStartTime = Date.now();

        // ì´ë²¤íŠ¸ ë¡œê¹… í•¨ìˆ˜
        async function logEvent(eventType, eventDetail) {
            const studentId = localStorage.getItem('studentId');
            const sessionTime = (Date.now() - sessionStartTime) / 1000; // ì´ˆ ë‹¨ìœ„ë¡œ ë³€í™˜

            try {
                await fetch('https://script.google.com/macros/s/AKfycbzMUuR7N90UM9PqjczwnDoYVqKHwrjXUjmvDQJ-4iSODIjCIq-fetYVfUCqt4rUE95AVw/exec', {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify({
                        studentId: studentId,
                        eventType: eventType,
                        eventDetail: eventDetail,
                        sessionTime: sessionTime
                    })
                });
            } catch (error) {
                console.error('ë¡œê¹… ì˜¤ë¥˜:', error);
            }
        }

        // ë§ˆìš°ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener('click', (e) => {
            logEvent('click', `x: ${e.clientX}, y: ${e.clientY}`);
        });

        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ìŠ¤ë„ˆ
        document.addEventListener('keydown', (e) => {
            logEvent('keypress', e.key);
        });

        // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ìµœì¢… ì„¸ì…˜ ì‹œê°„ ê¸°
        window.addEventListener('beforeunload', () => {
            logEvent('session_end', 'í˜ì´ì§€ ì¢…ë£Œ');
        });

        // í‚¤ ì…ë ¥ ê´€ë ¨ ì„¤ì •ê°’ (ì • ê°€ëŠ¥)
        const MOVEMENT = {
            MOVE_SPEED: 12,      // ê¸° ì´ë™ ì†ë„
            MAX_SPEED: 12,      // ìµœëŒ€ ì´ë™ ì†ë„
            ACCELERATION: 1.2,   // ê°€ì†ë„
            DECELERATION: 0.8,  // ê°ì†ë„
            DIRECTION_CHANGE_SPEED: 1.5,  // ë°©í–¥ ì „í™˜ ì†ë„ (ë†’ì„ìˆ˜ë¡ ë¹ ë¥´ê²Œ ì „í™˜)
            MINIMUM_SPEED: 0.1,  // ì†ë„ê°€ ì´ ê°’ ì´í•˜ë©´ 0ìœ¼ë¡œ ì„¤ì •
            INSTANT_DIRECTION_CHANGE: false, // trueë©´ ì¦‰ì‹œ ë°©í–¥ ì „í™˜
            SMOOTH_FACTOR: 0.85  // ë¶€ë“œëŸ¬ìš´ ì •ë„ (0~1, 1 ê°€ê¹Œìš¸ìˆ˜ë¡ ë¶€ë“œëŸ¬ì›€)
        };

        // í˜„ì¬ ë„ ìƒíƒœ
        let currentSpeed = { x: 0, y: 0 };
        let targetSpeed = { x: 0, y: 0 };

        function updatePlayer() {
            let newX = parseFloat(player.style.left) || 0;
            let newY = parseFloat(player.style.top) || 0;

            // ì¤‘ë ¥ ì ìš© (ê¸°ì¡´ê³¼ ë™ì¼)
            switch(currentGravity) {
                case 'down':
                    playerVelocity.y = Math.min(playerVelocity.y + MOVEMENT.GRAVITY, MOVEMENT.MAX_FALL_SPEED);
                    break;
                case 'up':
                    playerVelocity.y = Math.max(playerVelocity.y - MOVEMENT.GRAVITY, -MOVEMENT.MAX_FALL_SPEED);
                    break;
                case 'left':
                    playerVelocity.x = Math.max(playerVelocity.x - MOVEMENT.GRAVITY, -MOVEMENT.MAX_FALL_SPEED);
                    break;
                case 'right':
                    playerVelocity.x = Math.min(playerVelocity.x + MOVEMENT.GRAVITY, MOVEMENT.MAX_FALL_SPEED);
                    break;
            }

            // ëª©í‘œ ì†ë„ ì„¤ì •
            if (currentGravity === 'up' || currentGravity === 'down') {
                // ì¢Œìš° ì´ë™
                if (keyState['ArrowLeft'] || keyState['KeyA']) {
                    targetSpeed.x = -MOVEMENT.MAX_SPEED;
                } else if (keyState['ArrowRight'] || keyState['KeyD']) {
                    targetSpeed.x = MOVEMENT.MAX_SPEED;
                } else {
                    targetSpeed.x = 0;
                }

                // ë¶€ë“œëŸ¬ìš´ ì†ë„ ì „í™˜
                if (MOVEMENT.INSTANT_DIRECTION_CHANGE) {
                    // ì¦‰ì‹œ ë°©í–¥ ì „í™˜
                    currentSpeed.x = targetSpeed.x;
                } else {
                    // ë¶€ë“œëŸ¬ìš´ ë°©í–¥ ì „í™˜
                    const speedDiff = targetSpeed.x - currentSpeed.x;
                    currentSpeed.x += speedDiff * MOVEMENT.DIRECTION_CHANGE_SPEED * MOVEMENT.SMOOTH_FACTOR;
                    
                    // ë¯¸ì„¸í•œ ì†ë„ëŠ” 0ìœ¼ë¡œ
                    if (Math.abs(currentSpeed.x) < MOVEMENT.MINIMUM_SPEED) {
                        currentSpeed.x = 0;
                    }
                }
            } else {
                // ìƒí•˜ ì´ë™
                if (keyState['ArrowUp'] || keyState['KeyW']) {
                    targetSpeed.y = -MOVEMENT.MAX_SPEED;
                } else if (keyState['ArrowDown'] || keyState['KeyS']) {
                    targetSpeed.y = MOVEMENT.MAX_SPEED;
                } else {
                    targetSpeed.y = 0;
                }

                // ë¶€ë“œëŸ¬ìš´ ì†ë„ ì „í™˜
                if (MOVEMENT.INSTANT_DIRECTION_CHANGE) {
                    currentSpeed.y = targetSpeed.y;
                } else {
                    const speedDiff = targetSpeed.y - currentSpeed.y;
                    currentSpeed.y += speedDiff * MOVEMENT.DIRECTION_CHANGE_SPEED * MOVEMENT.SMOOTH_FACTOR;
                    
                    if (Math.abs(currentSpeed.y) < MOVEMENT.MINIMUM_SPEED) {
                        currentSpeed.y = 0;
                    }
                }
            }

            // ì´ë™ ì ìš©
            newX += currentSpeed.x;
            newY += currentSpeed.y;
            newX += playerVelocity.x;
            newY += playerVelocity.y;

            // ë²½ ì¶©ëŒ ì²´í¬ ë° ìœ„ì¹˜ ì¡°ì •
            const nextRect = {
                left: newX,
                right: newX + playerWidth,
                top: newY,
                bottom: newY + playerHeight
            };

            // ... ë‚˜ë¨¸ì§€ ì½”ë“œëŠ” ë™ì¼ ...
        }

        // ì í”„ ì²˜ë¦¬
        document.addEventListener('keydown', (e) => {
            keyState[e.code] = true;
            
            if ((e.code === 'Space' || e.code === 'KeyW' || e.code === 'ArrowUp') && canJump) {
                const currentTime = Date.now();
                if (currentTime - lastJumpTime > MOVEMENT.JUMP_COOLDOWN) {
                    switch(currentGravity) {
                        case 'down':
                            playerVelocity.y = -MOVEMENT.JUMP_FORCE;
                            break;
                        case 'up':
                            playerVelocity.y = MOVEMENT.JUMP_FORCE;
                            break;
                        case 'left':
                            playerVelocity.x = MOVEMENT.JUMP_FORCE;
                            break;
                        case 'right':
                            playerVelocity.x = -MOVEMENT.JUMP_FORCE;
                            break;
                    }
                    lastJumpTime = currentTime;
                    canJump = false;
                }
            }
        });

        // ìœ„í—˜ êµ¬ì—­ ê°€ì„± ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ì¶”ê°€
        function updateDangerZoneVisibility() {
            if (currentStage !== 9) return;

            const playerX = parseFloat(player.style.left) + playerWidth / 2;
            const playerY = parseFloat(player.style.top) + playerHeight / 2;
            const visibilityRadius = 100; // ë³´ì´ëŠ” ë²”ìœ„ ì„¤ì •

            document.querySelectorAll('.dark-danger-zone-10').forEach(zone => {
                const zoneX = parseFloat(zone.style.left) + parseFloat(zone.style.width) / 2;
                const zoneY = parseFloat(zone.style.top) + parseFloat(zone.style.height) / 2;
                
                // í”Œë ˆì´ì–´ì™€ ìœ„í—˜ êµ¬ì—­ ì‚¬ì´ì˜ ê±°ë¦¬ ê³„ì‚°
                const distance = Math.sqrt(
                    Math.pow(playerX - zoneX, 2) + 
                    Math.pow(playerY - zoneY, 2)
                );
                
                // ê±°ë¦¬ì— ë”°ë¥¸ íˆ¬ëª…ë„ ê³„ì‚°
                if (distance < visibilityRadius) {
                    const opacity = 1 - (distance / visibilityRadius);
                    zone.style.opacity = opacity;
                } else {
                    zone.style.opacity = 0;
                }
            });
        }

        // ìƒˆë¡œìš´ í•¨ìˆ˜ ì¶”ê°€
        function updateGravityBlocks() {
            const blocks = document.querySelectorAll('.gravity-block');
            blocks.forEach(block => {
                const blockRect = block.getBoundingClientRect();
                const playerRect = player.getBoundingClientRect();
                
                // í”Œë ˆì´ì–´ì™€ ë¸”ë¡ ì¶©ëŒ ì²´ï¿½ï¿½
                if (checkBlockCollision(playerRect, blockRect)) {
                    resetGame();
                    return;
                }

                const type = block.dataset.type;
                let shouldMove = false;
                
                // ë¸”ë¡ íƒ€ì…ì— ë”°ë¥¸ ì¤‘ë ¥ ë°˜ì‘
                if (type === 'horizontal' && (currentGravity === 'up' || currentGravity === 'down')) {
                    shouldMove = true;
                } else if (type === 'vertical' && (currentGravity === 'left' || currentGravity === 'right')) {
                    shouldMove = true;
                }

                if (shouldMove) {
                    moveGravityBlock(block);
                }
            });
        }

        function checkBlockCollision(rect1, rect2) {
            return !(rect1.right < rect2.left || 
                     rect1.left > rect2.right || 
                     rect1.bottom < rect2.top || 
                     rect1.top > rect2.bottom);
        }

        function checkWallCollisionForBlock(newX, newY, block) {
            const blockWidth = parseFloat(block.style.width);
            const blockHeight = parseFloat(block.style.height);
            const gap = 1; // ë²½ê³¼ì˜ ê°„ê²©ì„ 1í”½ì…€ë¡œ ì¡°ì •

            return walls.some(wall => {
                // ì¶©ëŒì´ ê°ì§€ë˜ë©´ ë¸”ì„ ë²½ì— ë”± ë¶™ë„ë¡ ì¡°ì •
                if (newX < wall.x + wall.width &&
                    newX + blockWidth > wall.x &&
                    newY < wall.y + wall.height &&
                    newY + blockHeight > wall.y) {
                    
                    // í˜„ì¬ ì¤‘ë ¥ ë°©í–¥ì— ë”°ë¼ ìœ„ì¹˜ ì¡°ì •
                    switch (currentGravity) {
                        case 'down':
                            block.style.top = (wall.y - blockHeight - gap) + 'px';
                            break;
                        case 'up':
                            block.style.top = (wall.y + wall.height + gap) + 'px';
                            break;
                        case 'left':
                            block.style.left = (wall.x + wall.width + gap) + 'px';
                            break;
                        case 'right':
                            block.style.left = (wall.x - blockWidth - gap) + 'px';
                            break;
                    }
                    return true;
                }
                return false;
            });
        }

        function moveGravityBlock(block) {
            const speed = 3;
            let newX = parseFloat(block.style.left);
            let newY = parseFloat(block.style.top);
            const blockWidth = parseFloat(block.style.width);
            const blockHeight = parseFloat(block.style.height);

            switch (currentGravity) {
                case 'down':
                    newY = Math.min(newY + speed, gameHeight - blockHeight);
                    break;
                case 'up':
                    newY = Math.max(newY - speed, 0);
                    break;
                case 'left':
                    newX = Math.max(newX - speed, 0);
                    break;
                case 'right':
                    newX = Math.min(newX + speed, gameWidth - blockWidth);
                    break;
            }

            // ë²½ê³¼ì˜ ì¶©ëŒ ì²´í¬ ë° ì •í™•í•œ ìœ„ì¹˜ ì¡°ì •
            walls.forEach(wall => {
                const collision = checkBlockWallCollision(newX, newY, blockWidth, blockHeight, wall);
                if (collision.collided) {
                    switch (currentGravity) {
                        case 'down':
                            newY = wall.y - blockHeight;
                            break;
                        case 'up':
                            newY = wall.y + wall.height;
                            break;
                        case 'left':
                            newX = wall.x + wall.width;
                            break;
                        case 'right':
                            newX = wall.x - blockWidth;
                            break;
                    }
                }
            });

            block.style.left = newX + 'px';
            block.style.top = newY + 'px';
        }

        function checkBlockWallCollision(blockX, blockY, blockWidth, blockHeight, wall) {
            const collision = {
                collided: false,
                direction: null
            };

            // ì¶©ëŒ ì—¬ë¶€ í™•ì¸
            if (blockX < wall.x + wall.width &&
                blockX + blockWidth > wall.x &&
                blockY < wall.y + wall.height &&
                blockY + blockHeight > wall.y) {
                
                collision.collided = true;

                // ì¶©ëŒ ë°©í–¥ ê²°ì •
                const overlapX = Math.min(blockX + blockWidth, wall.x + wall.width) - 
                                Math.max(blockX, wall.x);
                const overlapY = Math.min(blockY + blockHeight, wall.y + wall.height) - 
                                Math.max(blockY, wall.y);

                if (overlapX < overlapY) {
                    collision.direction = blockX < wall.x ? 'right' : 'left';
                } else {
                    collision.direction = blockY < wall.y ? 'down' : 'up';
                }
            }

            return collision;
        }

        // gravityBlocks ê°ì²´ ìˆ˜ì •
        const gravityBlocks = {
            8: [ // ìŠ¤í…Œì´ì§€ 9
                { 
                    x: 100, y: 500, 
                    width: 100, height: 20, 
                    type: 'horizontal'
                },
                { 
                    x: 0, y: 100, 
                    width: 20, height: 100, 
                    type: 'vertical' /* ìˆ˜ì§ */
                },
                { 
                    x: 100, y: 0, 
                    width: 200, height: 20, 
                    type: 'horizontal'
                },
                { 
                    x: 300, y: 400, 
                    width: 20, height: 100, 
                    type: 'vertical'
                },
                { 
                    x: 500, y: 200, 
                    width: 100, height: 20, 
                    type: 'vertical'
                }
            ]
        };

        // loadStage í•¨ìˆ˜ ë‚´ì˜ ì¤‘ë ¥ ë¸”ë¡ ìƒì„± ë¶€ë¶„ ìˆ˜ì •
        if (stageIndex === 8 && gravityBlocks[8]) {
            gravityBlocks[8].forEach(block => {
                const gravityBlock = document.createElement('div');
                gravityBlock.className = 'gravity-block';
                gravityBlock.style.left = block.x + 'px';
                gravityBlock.style.top = block.y + 'px';
                gravityBlock.style.width = block.width + 'px';
                gravityBlock.style.height = block.height + 'px';
                gravityBlock.dataset.type = block.type;
                gravityBlock.style.backgroundColor = '#8A2BE2'; // ë³´ë¼ìƒ‰ ì§ì ‘ ì§€ì •
                gravityBlock.style.position = 'absolute';
                gravityBlock.style.zIndex = '1';
                gameContainer.appendChild(gravityBlock);
            });
        }

        // ì¤‘ë ¥ ë³€í™” ì¹´ìš´í„° í‘œì‹œ í•¨ìˆ˜ ì¶”ê°€
        function updateGravityCounter() {
            let counterDisplay = document.getElementById('gravity-counter');
            if (!counterDisplay) {
                counterDisplay = document.createElement('div');
                counterDisplay.id = 'gravity-counter';
                counterDisplay.style.position = 'absolute';
                counterDisplay.style.top = '-80px';
                counterDisplay.style.left = '20px';
                counterDisplay.style.padding = '10px';
                counterDisplay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                counterDisplay.style.color = 'white';
                counterDisplay.style.fontSize = '18px';
                counterDisplay.style.borderRadius = '5px';
                counterDisplay.style.zIndex = '1000';
                gameContainer.appendChild(counterDisplay);
            }
            
            const remainingChanges = MAX_GRAVITY_CHANGES - gravityChangeCount;
            counterDisplay.textContent = `ë‚¨ì€ ì¤‘ë ¥ ë³€í™”: ${remainingChanges}`;
            counterDisplay.style.color = remainingChanges <= 2 ? '#ff4444' : 'white';
        }

        // ìŠ¤í…Œì´ì§€ 10 ë¦¬ì…‹ í•¨ìˆ˜ ì¶”ê°€
        function resetStage10() {
            resetStage8();
            
            // ì¤‘ë ¥ ë³€í™” ì¹´ìš´í„°ê°€ ìˆë‹¤ë©´ ì œê±°
            const counter = document.getElementById('gravity-counter');
            if (counter) counter.remove();
            
            // íƒ€ì´ë¨¸ ì¬ì‹œì‘
            startStageTimer();
        }

        // startStageTimer í•¨ìˆ˜ ìˆ˜ì •
        function startStageTimer() {
            timerDisplay.style.display = 'block';
            timeLimit = 30;
            
            if (stageTimer) clearInterval(stageTimer);
            
            updateTimerDisplay();
            stageTimer = setInterval(() => {
                timeLimit--;
                updateTimerDisplay();
                
                if (timeLimit <= 0) {
                    clearInterval(stageTimer);
                    if (currentStage === 7) {  // ìŠ¤í…Œì´ì§€ 8
                        resetStage8();
                    } else if (currentStage === 9) {  // ìŠ¤í…Œì´ì§€ 10
                        resetStage10();
                    }
                }
            }, 1000);
        }

        
        function checkDangerZoneCollision() {
            const playerRect = player.getBoundingClientRect();
            
            // ìŠ¤í…Œì´ì§€ 10ì˜ ìœ„í—˜ êµ¬ì—­ í™•ì¸
            if (currentStage === 9) { // 10ìŠ¤í…Œì´ì§€
                const dangerZones = document.querySelectorAll('.dark-danger-zone-10');
                for (const zone of dangerZones) {
                    const zoneRect = zone.getBoundingClientRect();
                    if (isColliding(playerRect, zoneRect)) {
                        // í”Œë ˆì´ì–´ ìœ„ì¹˜ ì´ˆê¸°í™”
                        player.style.left = '20px';
                        player.style.top = '540px';
                        playerVelocity = { x: 0, y: 0 };
                        
                        // íƒ€ì´ë¨¸ ì´ˆê¸°í™”
                        if (stageTimer) {
                            clearInterval(stageTimer);
                        }
                        resetStage10();
                        
                        return true;
                    }
                }
            }
            
            // ë‹¤ë¥¸ ìŠ¤í…Œì´ì§€ì˜ ìœ„í—˜ êµ¬ì—­ í™•ì¸ (ê¸°ì¡´ ì½”ë“œ)
            if (dangerZones[currentStage]) {
                for (const zone of dangerZones[currentStage]) {
                    const zoneRect = {
                        left: zone.x,
                        right: zone.x + zone.width,
                        top: zone.y,
                        bottom: zone.y + zone.height
                    };
                    if (isColliding(playerRect, zoneRect)) {
                        player.style.left = '20px';
                        player.style.top = '540px';
                        playerVelocity = { x: 0, y: 0 };
                        return true;
                    }
                }
            }
            return false;
        }

        // resetStageTimer í•¨ìˆ˜ê°€ ì—†ë‹¤ë©´ ì¶”ê°€
        function resetStageTimer() {
            if (stageTimer) {
                clearInterval(stageTimer);
                stageTimer = null;
            }
            timeLimit = 30;
            if (timerDisplay) {
                timerDisplay.textContent = timeLimit;
            }
            startStageTimer();
        }

        // ìŠ¤í…Œì´ì§€ ì´ˆê¸°í™” ì‹œ í´ë¦¬ì–´ ê¸°ë¡ë„ ì´ˆê¸°í™”í•˜ëŠ” í•¨ìˆ˜ ì¶”ê°€
        function resetProgress() {
            localStorage.removeItem('clearedStages');
            updateStageButtons();
            loadStage(0); // ì²« ìŠ¤í…Œì´ì§€ë¡œ ì´ë™
        }
    </script>
</body>
</html>

















































