<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ì¤‘ë ¥ ë¯¸ë¡œ íƒˆì¶œ ê²Œì„</title>
    <link rel="icon" type="image/png" href="icon.png">
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: rgb(220, 219, 219); /* í˜ì´ì§€ ì „ì²´ ë°°ê²½ì„ í•˜ì–€ìƒ‰ìœ¼ë¡œ ì„¤ì • */

        }
        #game-container {
            position: relative;
            width: 600px;
            height: 600px;
            border: 20px solid black;
            margin-top: 40px;
            background-color: white; /* ê²Œì„ ì»¨í…Œì´ë„ˆ ë°°ê²½ì„ í•˜ì–€ìƒ‰ìœ¼ë¡œ ì„¤ì • */
            z-index: 2; /* ë°°ê²½ ì´ë¯¸ì§€ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ z-index ì¦ê°€ */
        }
        #player {
            position: absolute; /* ìœ„ì¹˜ ì†ì„±ì„ ì ˆëŒ€ ìœ„ì¹˜ë¡œ ì„¤ì • */
            width: 60px; /* í¬ê¸°ë¥¼ 40x40ìœ¼ë¡œ ì¦ê°€ */
            height: 60px;
            background-image: url('pix.png'); /* ì´ë¯¸ì§€ ê²½ë¡œ ì„¤ì • */
            background-size: contain; /* ì´ë¯¸ì§€ê°€ ìš”ì†Œ í¬ê¸°ì— ë§ê²Œ ì¡°ì •ë˜ë„ë¡ ì„¤ì • */
            background-position: center ; /* ì´ë¯¸ì§€ë¥¼ ì¤‘ì•™ì— ìœ„ì¹˜ */
            background-repeat: no-repeat; /* ì´ë¯¸ì§€ê°€ ë°˜ë³µë˜ì§€ ì•Šë„ë¡ ì„¤ì • */
            transition: transform 0.5s ease; /* íšŒì „ ì• ë‹ˆë©”ì´ì…˜ ìœ ì§€ */
            transform-origin: center center;
        }
        #goal {
            position: absolute;
            width: 40px;  /* ì´ë¯¸ì§€ í¬ê¸°ì— ë§ê²Œ ì¡°ì • */
            height: 40px;
            background-image: url('goal.png');  /* ì´ë¯¸ì§€ ê²½ë¡œ ì„¤ì • */
            background-size: contain;  /* ì´ë¯¸ì§€ê°€ ìš”ì†Œì— ë§ê²Œ ì¡°ì •ë˜ë„ë¡ ì„¤ì • */
            background-position: center;  /* ì´ë¯¸ì§€ë¥¼ ì¤‘ì•™ì— ìœ„ì¹˜ */
            background-repeat: no-repeat;  /* ì´ë¯¸ì§€ ë°˜ë³µ ë°©ì§€ */
        }
        .wall {
            position: absolute;
            background-color: #333;
        }
        #controls {
            position: relative;
            width: 150px;
            height: 100px;
            margin: 20px auto;
            z-index: 2; /* ë°°ê²½ ì´ë¯¸ì§€ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ ì„¤ì • */
        }
        .gravity-button {
            position: absolute;
            width: 80px;
            height: 80px;
            font-size: 16px;
            cursor: pointer;
        }
        #up-button {
            top: 0;
            left: 50%;
            transform: translateX(-50%);
        }
        #left-button {
            top: 80px;
            left: calc(50% - 80px);
            transform: translateX(-50%);
        }
        #down-button {
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
        }
        #right-button {
            top: 80px;
            left: calc(50% + 80px);
            transform: translateX(-50%);
        }
        #stage-title {
            position: absolute;
            top: -80px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 36px;
            font-weight: bold;
            color: #333;
            z-index: 2; /* ë°°ê²½ ì´ë¯¸ì§€ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ ì„¤ì • */
        }
        #game-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2; /* ë°°ê²½ ì´ë¯¸ì§€ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ ì„¤ì • */
        }
        #stage-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 600px;
            margin-bottom: 40px;
            position: relative;
            z-index: 2; /* ë°°ê²½ ì´ë¯¸ì§€ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ ì„¤ì • */
        }
        .stage-button {
            margin: 5px;
            padding: 10px;
            font-size: 16px;
            cursor: pointer;
            flex: 0 0 calc(20% - 10px);
        }
        .particle {
            position: absolute;
            width: 5px;
            height: 5px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            pointer-events: none;
            animation: particle-animation 1s forwards;
        }

        @keyframes particle-animation {
            0% {
                transform: translate(0, 0);
                opacity: 1;
            }
            100% {
                transform: translate(var(--x), var(--y));
                opacity: 0;
            }
        }

        .player {
            position: absolute;
            width: 100px;
            height: 100px;
            left: 50%;
            top: 50%;
            transform-origin: center bottom !important;
            transform: translate(-50%, -50%) scale(1);
            transition: transform 0.3s ease;
        }
        #portal1, #portal2, #portal3, #portal5, #portal7, #portal9, #portal11, #portal13, #portal15, #portal17, #portal19, #portal21, #portal23, #portal25 {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('portal.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
        }
        #portal27, #portal29, #portal31, #portal33, #portal35, #portal37, #portal39, #portal41, #portal43 {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('portal.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
        }
        #portal4, #portal6, #portal8, #portal10, #portal12, #portal14, #portal16, #portal18, #portal20, #portal22, #portal24, #portal26 {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('portal.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0; /* íˆ¬ëª…ë„ ì¶”ê°€ */
        }
        #portal28, #portal30, #portal32, #portal34, #portal36, #portal38, #portal40, #portal42, #portal44 {
            position: absolute;
            width: 40px;
            height: 40px;
            background-image: url('portal.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0; /* íˆ¬ëª…ë„ ì¶”ê°€ */
        }
        #background-image {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 0; /* ëª¨ë“  UI ìš”ì†Œë³´ë‹¤ ì•„ë˜ì— ìœ„ì¹˜ */
        }
        #background-image.stage-bg-1 {
            background-image: url('./background/1.png');
        }
        #background-image.stage-bg-2 {
            background-image: url('./background/2.png');
        }
        #background-image.stage-bg-3 {
            background-image: url('./background/3.png');
        }
        #background-image.stage-bg-4 {
            background-image: url('./background/4.png');
        }
        #background-image.stage-bg-5 {
            background-image: url('./background/5.png');
        }
        #background-image.stage-bg-6 {
            background-image: url('./background/6.png');
        }
        #background-image.stage-bg-7 {
            background-image: url('./background/7.png');
        }
        #background-image.stage-bg-8 {
            background-image: url('./background/8.png');
        }
        #background-image.stage-bg-9 {
            background-image: url('./background/9.png');
        }
        #background-image.stage-bg-10 {
            background-image: url('./background/10.png');
        }
        /* ìƒˆë¡œìš´ ë©”ì¸ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        #main-container {
            background-color: rgba(216, 210, 210, 0.6); /* íˆ¬ëª…ë„ 0.8 ì¶”ê°€ */
            padding: 20px 20px 60px 20px; /* ì•„ë˜ìª½ íŒ¨ë”©ë§Œ 40pxë¡œ ëŠ˜ë¦¼ */
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 2;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        /* ë‹¤ë¥¸ ìš”ì†Œë“¤ì˜ z-indexëŠ” ì œê±°í•´ë„ ë©ë‹ˆë‹¤ (ì´ë¯¸ ì»¨í…Œì´ë„ˆê°€ ì²˜ë¦¬í•¨) */
        #game-area, #stage-buttons, #controls, #stage-title {
            position: relative;
        }

        /* ìŠ¤í…Œì´ì§€ 5ì˜ ë ˆë“œì¡´ ìŠ¤íƒ€ì¼ */
        .danger-zone {
            position: absolute;
            background-color: rgba(255, 0, 0, 1);  /* ë°˜íˆ¬ëª…í•œ ë¹¨ê°„ìƒ‰ */
            pointer-events: none;
        }

        /* ìŠ¤í…Œì´ì§€ 6ì˜ ë ˆë“œì¡´ ìŠ¤íƒ€ì¼ (ì¡°ëª… íš¨ê³¼ ì ìš©) */
        .dark-danger-zone {
            position: absolute;
            background-color: rgba(255, 0, 0, 1);  /* ë°˜íˆ¬ëª…í•œ ë¹¨ê°„ìƒ‰ */
            pointer-events: none;
            transition: opacity 0.3s, background-color 0.3s;  /* ìƒ‰ìƒ ì „í™˜ë„ ë¶€ë“œëŸ½ê²Œ */
        }

        .moving-platform {
            position: absolute;
            background-color: #001aff;  /*  ë²½ë³´ë‹¤ ì•½ê°„ ë°ì€ ìƒ‰ìƒ */
        }
        #light-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #333;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
        }

        #light-overlay.active {
            opacity: 1;  /* ì–´ë‘ìš´ ì •ë„ ì¡°ì ˆ (0: íˆ¬ëª… ~ 1: ì™„ì „ ê²€ì •) */
            mask-image: radial-gradient(circle at center, transparent 30px, #333 50px);
            -webkit-mask-image: radial-gradient(circle at center, transparent 30px, #333 50px);
        }

        /* ìŠ¤í…Œì´ì§€ 4ì˜ ë²½ì„ ìœ„í•œ íŠ¹ë³„í•œ ìŠ¤íƒ€ì¼ */
        .wall.dark-wall {
            background-color: #333;
            opacity: 0;  /* ì™„ì „íˆ íˆ¬ëª…í•˜ê²Œ ì„¤ì • */
            transition: opacity 0.3s;
        }

        /* ì¡°ëª…ì´ ë¹„ì¶œ ë•Œ ë²½ì´ ë³´ì´ê²Œ í•¨ */
        #light-overlay.active ~ .wall.dark-wall {
            opacity: 0.9;  /* ì¡°ëª… ì•„ë˜ì—ì„œë§Œ ë³´ì´ê²Œ */
        }

        #audio-controls {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(125px, 445px); /* ê²Œì„ ë§µ ìœ„ìª½ìœ¼ë¡œ ì´ë™ */
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
        }

        #mute-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        #volume-slider {
            width: 82px;
            cursor: pointer;
        }

        #volume-value {
            min-width: 42px;
        }

        #user-info {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-330px, 457px); /* ê²Œì„ ë§µ ìœ„ìª½ìœ¼ë¡œ ì´ë™ */
            background-color: rgba(255, 255, 255, 1);
            padding: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            font-size: 16px;
        }

        #logout-button {
            padding: 5px 10px;
            background-color: #ff4444;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #logout-button:hover {
            background-color: #cc0000;
        }

        #game-review {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(350px, -100px);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 5px;
            width: 250px;
            z-index: 1000;
        }

        #game-review h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
            color: #333;
        }

        .star-rating {
            margin-bottom: 15px;
        }

        .star {
            color: #ddd;
            font-size: 24px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .star.active {
            color: #ffd700;
        }

        #rating-value {
            margin-left: 10px;
            font-size: 14px;
        }

        #review-text {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: none;
        }

        #submit-review {
            width: 100%;
            padding: 8px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #submit-review:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div id="background-image"></div>
    <div id="main-container">
        <div id="game-area">
            <div id="stage-buttons">
                <!-- ìŠ¤í…Œì´ì§€ ë²„íŠ¼ì€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
            <div id="game-container">
                <div id="stage-title">Stage 1</div>
                <div id="player"></div>
                <div id="goal"></div>
                <div id="portal1" style="display: none;"></div>
                <div id="portal2" style="display: none;"></div>
                <div id="portal3" style="display: none;"></div>
                <div id="portal4" style="display: none;"></div>
                <div id="portal5" style="display: none;"></div>
                <div id="portal6" style="display: none;"></div>
                <div id="portal7" style="display: none;"></div>
                <div id="portal8" style="display: none;"></div>
                <div id="portal9" style="display: none;"></div>
                <div id="portal10" style="display: none;"></div>
                <div id="portal11" style="display: none;"></div>
                <div id="portal12" style="display: none;"></div>
                <div id="portal13" style="display: none;"></div>    
                <div id="portal14" style="display: none;"></div>
                <div id="portal15" style="display: none;"></div>
                <div id="portal16" style="display: none;"></div>
                <div id="portal17" style="display: none;"></div>
                <div id="portal18" style="display: none;"></div>
                <div id="portal19" style="display: none;"></div>
                <div id="portal20" style="display: none;"></div>
                <div id="portal21" style="display: none;"></div>
                <div id="portal22" style="display: none;"></div>
                <div id="portal23" style="display: none;"></div>
                <div id="portal24" style="display: none;"></div>
                <div id="portal25" style="display: none;"></div>
                <div id="portal26" style="display: none;"></div>    
                <div id="portal27" style="display: none;"></div>
                <div id="portal28" style="display: none;"></div>
                <div id="portal29" style="display: none;"></div>
                <div id="portal30" style="display: none;"></div>
                <div id="portal31" style="display: none;"></div>
                <div id="portal32" style="display: none;"></div>
                <div id="portal33" style="display: none;"></div>
                <div id="portal34" style="display: none;"></div>
                <div id="portal35" style="display: none;"></div>
                <div id="portal36" style="display: none;"></div>
                <div id="portal37" style="display: none;"></div>
                <div id="portal38" style="display: none;"></div>
                <div id="portal39" style="display: none;"></div>
                <div id="portal40" style="display: none;"></div>
                <div id="portal41" style="display: none;"></div>
                <div id="portal42" style="display: none;"></div>
                <div id="portal43" style="display: none;"></div>
                <div id="portal44" style="display: none;"></div>
                
                <div id="light-overlay"></div>
            </div>
        </div>
        <div id="controls">
            <button id="up-button" class="gravity-button" onclick="changeGravity('up')">ìœ„(W)</button>
            <button id="left-button" class="gravity-button" onclick="changeGravity('left')">ì™¼ìª½(A)</button>
            <button id="down-button" class="gravity-button" onclick="changeGravity('down')">ì•„ë˜(S)</button>
            <button id="right-button" class="gravity-button" onclick="changeGravity('right')">ì˜¤ë¥¸ìª½(D)</button>
        </div>
        <div id="audio-controls">
            <button id="mute-button">ğŸ”Š</button>
            <input type="range" id="volume-slider" min="0" max="100" value="50">
            <span id="volume-value">50%</span>
        </div>
        <div id="user-info">
            <span id="student-info">í•™ë²ˆ: </span>
            <button id="logout-button">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
        <div id="game-review">
            <h3>ê²Œì„ í‰ê°€í•˜ê¸° (ìµëª…)</h3>
            <div class="star-rating">
                <span class="star" data-rating="1">â˜…</span>
                <span class="star" data-rating="2">â˜…</span>
                <span class="star" data-rating="3">â˜…</span>
                <span class="star" data-rating="4">â˜…</span>
                <span class="star" data-rating="5">â˜…</span>
                <span id="rating-value">0ì </span>
            </div>
            <textarea id="review-text" placeholder="ê²Œì„ í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”              (ìµëª…ìœ¼ë¡œ ë“±ë¡ë©ë‹ˆë‹¤)" maxlength="200"></textarea>
            <button id="submit-review">í›„ê¸° ë‚¨ê¸°ê¸°</button>
        </div>
    </div>
    <audio id="bgm-1" loop src="music/1s.mp3"></audio>
    <audio id="bgm-2" loop src="music/2s.mp3"></audio>
    <audio id="bgm-3" loop src="music/3s.mp3"></audio>
    <audio id="bgm-4" loop src="music/4s.mp3"></audio>
    <audio id="bgm-5" loop src="music/5s.mp3"></audio>
    <audio id="bgm-6" loop src="music/6s.mp3"></audio>
    <audio id="bgm-7" loop src="music/7s.mp3"></audio>
    <script>
        const player = document.getElementById('player');
        const goal = document.getElementById('goal');
        const gameContainer = document.getElementById('game-container');

        const gameWidth = 600;
        const gameHeight = 600;
        const playerWidth = 60;
        const playerHeight = 60;

        let currentGravity = 'down';
        let playerVelocity = { x: 0, y: 0 };
        let isJumping = false;
        let canJump = true;
        let lastJumpTime = 0;
        const jumpCooldown = 500; // ì í”„ ì¿¨ë‹¤ìš´ ì‹œê°„ (ë°€ë¦¬ì´ˆ)
        const gravity = 0.8; // ì¤‘ë ¥ ê°•ë„ ì¦ê°€
        const jumpForce = 10;
        let isOnGround = true;
        const moveSpeed = 5;
        const maxFallSpeed = 10; // ìµœëŒ€ ë‚™í•˜ ì†ë„ ì„¤ì •
        let lastMoveTime = 0;
        const moveDelay = 200; // ì—°ì† ì´ë™ ì‚¬ì´ì˜ ì§€ì—° ì‹œê°„ (ë°€ë¦¬ì´ˆ)
        let keyState = {
            ArrowLeft: false,
            ArrowRight: false,
            ArrowUp: false,
            ArrowDown: false,
            KeyW: false,
            KeyA: false,
            KeyS: false,
            KeyD: false
        };

        const stages = [
            // ìŠ¤í…Œì´ì§€ 1
            [
                { x: 100, y: 0, width: 20, height: 400 },
                { x: 100, y: 500, width: 420, height: 20 },
                { x: 500, y: 100, width: 100, height: 20 },
                { x: 200, y: 100, width: 20, height: 300 },
                { x: 300, y: 200, width: 200, height: 20 },
                { x: 400, y: 200, width: 20, height: 200 },
                { x: 500, y: 100, width: 20, height: 400 },
            ],
            // ìŠ¤í…Œì´ì§€ 2
            [
                { x: 0, y: 100, width: 500, height: 20 },
                { x: 100, y: 200, width: 20, height: 300 },
                { x: 200, y: 300, width: 400, height: 20 },
                { x: 300, y: 0, width: 20, height: 200 },
                { x: 400, y: 400, width: 20, height: 200 },
            ],
            // ìŠ¤í…Œì´ì§€ 3
            [
                { x: 0, y: 200, width: 400, height: 20 },
                { x: 200, y: 100, width: 20, height: 220 },
                { x: 300, y: 300, width: 300, height: 20 },
                { x: 500, y: 0, width: 20, height: 200 },
            ],
            // ìŠ¤í…Œì´ì§€ 4
            [
                { x: 100, y: 100, width: 20, height: 200 },
                { x: 100, y: 300, width: 100, height: 20 },
                { x: 100, y: 400, width: 20, height: 100 },
                { x: 100, y: 100, width: 200, height: 20 },
                { x: 200, y: 400, width: 20, height: 100 },
                { x: 200, y: 200, width: 100, height: 20 },
                { x: 300, y: 100, width: 20, height: 400 },
                { x: 300, y: 400, width: 120, height: 20 },
                { x: 400, y: 100, width: 20, height: 300 },
                { x: 400, y: 500, width: 20, height: 100 },
                { x: 400, y: 100, width: 200, height: 20 },
                { x: 500, y: 200, width: 20, height: 400 },
                { x: 0, y: 500, width: 220, height: 20 },
            ],
            // ìŠ¤í…Œì´ì§€ 5
            [
                { x: 0, y: 300, width: 400, height: 20 },
                { x: 200, y: 0, width: 20, height: 200 },
                { x: 300, y: 400, width: 20, height: 200 },
            ],
            // ìŠ¤í…Œì´ì§€ 6
            [
                { x: 100, y: 0, width: 20, height: 400 },
                { x: 300, y: 100, width: 300, height: 20 },
                { x: 300, y: 300, width: 20, height: 200 },
                { x: 300, y: 300, width: 300, height: 20 },
                { x: 500, y: 400, width: 20, height: 200 },
            ],
            // ìŠ¤í…Œì´ì§€ 7
            [
                { x: 0, y: 100, width: 600, height: 20 },
                { x: 150, y: 300, width: 20, height: 300 },
                { x: 0, y: 300, width: 600, height: 20 },
                { x: 400, y: 100, width: 200, height: 20 },
                { x: 0, y: 500, width: 600, height: 20 },
                { x: 350, y: 100, width: 20, height: 500 },
                { x: 200, y: 0, width: 20, height: 100 },
            ],
            // ìŠ¤í…Œì´ì§€ 8
            [
                { x: 100, y: 100, width: 400, height: 20 },
                { x: 100, y: 200, width: 20, height: 300 },
                { x: 200, y: 300, width: 300, height: 20 },
                { x: 400, y: 0, width: 20, height: 200 },
                { x: 500, y: 400, width: 20, height: 200 },
            ],
            // ìŠ¤í…Œì´ì§€ 9
            [
                { x: 0, y: 300, width: 500, height: 20 },
                { x: 200, y: 100, width: 20, height: 400 },
                { x: 300, y: 0, width: 20, height: 200 },
                { x: 400, y: 200, width: 200, height: 20 },
                { x: 500, y: 300, width: 20, height: 300 },
            ],
            // ìŠ¤í…Œì´ì§€ 10
            [
                { x: 100, y: 0, width: 20, height: 300 },
                { x: 200, y: 200, width: 300, height: 20 },
                { x: 300, y: 300, width: 20, height: 300 },
                { x: 400, y: 100, width: 200, height: 20 },
                { x: 500, y: 0, width: 20, height: 500 },
            ],
        ];

        let currentStage = 0;
        let walls = [];

        // ì „ì—­ ë³€ìˆ˜ ì¶”ê°€
        let portalCooldown = false;
        const portal1 = document.getElementById('portal1');
        const portal2 = document.getElementById('portal2');
        const portal3 = document.getElementById('portal3');
        const portal4 = document.getElementById('portal4');
        const portal5 = document.getElementById('portal5');
        const portal6 = document.getElementById('portal6');
        const portal7 = document.getElementById('portal7');
        const portal8 = document.getElementById('portal8');
        const portal9 = document.getElementById('portal9');
        const portal10 = document.getElementById('portal10');
        const portal11 = document.getElementById('portal11');
        const portal12 = document.getElementById('portal12');
        const portal13 = document.getElementById('portal13');
        const portal14 = document.getElementById('portal14');
        const portal15 = document.getElementById('portal15');
        const portal16 = document.getElementById('portal16');
        const portal17 = document.getElementById('portal17');
        const portal18 = document.getElementById('portal18');
        const portal19 = document.getElementById('portal19');
        const portal20 = document.getElementById('portal20');
        const portal21 = document.getElementById('portal21');
        const portal22 = document.getElementById('portal22');
        const portal23 = document.getElementById('portal23');
        const portal24 = document.getElementById('portal24');
        const portal25 = document.getElementById('portal25');
        const portal26 = document.getElementById('portal26');
        const portal27 = document.getElementById('portal27');
        const portal28 = document.getElementById('portal28');
        const portal29 = document.getElementById('portal29');
        const portal30 = document.getElementById('portal30');
        const portal31 = document.getElementById('portal31');
        const portal32 = document.getElementById('portal32');
        const portal33 = document.getElementById('portal33');
        const portal34 = document.getElementById('portal34');
        const portal35 = document.getElementById('portal35');
        const portal36 = document.getElementById('portal36');
        const portal37 = document.getElementById('portal37');
        const portal38 = document.getElementById('portal38');
        const portal39 = document.getElementById('portal39');
        const portal40 = document.getElementById('portal40');
        const portal41 = document.getElementById('portal41');
        const portal42 = document.getElementById('portal42');
        const portal43 = document.getElementById('portal43');
        const portal44 = document.getElementById('portal44');
        

        const dangerZones = {
            4: [  // ìŠ¤í…Œì´ì§€ 5ì˜ ìœ„í—˜ êµ¬ì—­
                { x: 100, y: 500, width: 200, height: 20 },
                { x: 400, y: 300, width: 100, height: 20 },
                { x: 500, y: 200, width: 20, height: 300 },
                { x: 400, y: 100, width: 200, height: 20 }
            ]
        };

        const darkDangerZones = {
            5: [  // ìŠ¤í…Œì´ì§€ 6ì˜ ìœ„í—˜ êµ¬ì—­
                { x: 100, y: 500, width: 220, height: 20 },
                { x: 400, y: 300, width: 100, height: 20 },
                { x: 500, y: 200, width: 20, height: 200 },
                { x: 100, y: 200, width: 220, height: 20 },

            ]
        };

        const movingPlatforms = {
            2: [
                {
                    x: 200, y: 400, width: 100, height: 20,  // ì´ˆê¸° ìœ„ì¹˜ì™€ í¬ê¸°
                    startX: 200, endX: 500,  // xì¶• ì´ë™ ë²”ìœ„
                    startY: 400, endY: 400,  // yì¶• ì´ë™ ë²”ìœ„ (ìˆ˜í‰ ì´ë™ë§Œ)
                    speed: 2,  // ì´ë™ ì†ë„
                    direction: 1  // 1: ë¥¸ìª½/ì•„ë˜ë¡œ, -1: ì™¼ìª½/ìœ„ë¡œ
                },
                {
                    x: 400, y: 0, width: 20, height: 100,  // ì´ˆê¸° ìœ„ì¹˜ì™€ í¬ê¸°
                    startX: 300, endX: 300,  // xì¶• ì´ë™ ë²”ìœ„ (ìˆ˜ì§ ì´ë™ë§Œ)
                    startY: 0, endY: 200,  // yì¶• ì´ë™ ë²”ìœ„
                    speed: 2,  // ì´ë™ ì†ë„
                    direction: 1  // 1: ì˜¤ë¥¸ìª½/ì•„ë˜ë¡œ, -1: ì™¼ìª½/ìœ„ë¡œ
                }
            ]
        };

        // ì „ì—­ ë³€ìˆ˜ë¡œ overlay ìš”ì†Œ ì°¸ì¡° ì¶”ê°€
        const lightOverlay = document.getElementById('light-overlay');

        // ì „ì—­ ë³€ìˆ˜ ì¶”ê°€
        let currentBgm = null;
        let isMuted = false;
        const bgmElements = {};
        let volume = 0.1; // ê¸°ë³¸ ë³¼ë¥¨ 50%

        function initializeUserInfo() {
            const studentId = localStorage.getItem('studentId');
            
            if (!studentId) {
                // ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ê²½ìš° ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                window.location.href = 'login.html';
                return;
            }

            // í•™ë²ˆ í‘œì‹œ
            const studentInfoElement = document.getElementById('student-info');
            studentInfoElement.textContent = `í•™ë²ˆ: ${studentId}`;

            // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const logoutButton = document.getElementById('logout-button');
            logoutButton.addEventListener('click', () => {
                localStorage.removeItem('studentId');
                window.location.href = 'login.html';
            });
        }

        function createStageButtons() {
            const stageButtonsContainer = document.getElementById('stage-buttons');
            const totalStages = stages.length;
            const stagesPerRow = Math.ceil(totalStages / 2);

            for (let i = 0; i < totalStages; i++) {
                const button = document.createElement('button');
                button.textContent = `ìŠ¤í…Œì´ì§€ ${i + 1}`;
                button.className = 'stage-button';
                button.onclick = () => loadStage(i);
                stageButtonsContainer.appendChild(button);

                if (i === stagesPerRow - 1) {
                    stageButtonsContainer.appendChild(document.createElement('br'));
                }
            }
        }

        function loadStage(stageIndex) {
            // ê¸°ì¡´ BGM ì •ì§€
            if (currentBgm) {
                currentBgm.pause();
                currentBgm.currentTime = 0;
            }

            // ìƒˆë¡œìš´ BGM ì‹œì‘ (ìŠ¤í…Œì´ì§€ 8 ì´ìƒì€ ì œì™¸)
            if (stageIndex < 7) {
                currentBgm = bgmElements[stageIndex + 1];
                if (currentBgm) {
                    currentBgm.volume = isMuted ? 0 : volume;
                    currentBgm.play().catch(error => console.log("BGM ì¬ìƒ ì‹¤íŒ¨:", error));
                }
            }

            currentStage = stageIndex;
            document.getElementById('stage-title').textContent = `ìŠ¤í…Œì´ì§€ ${stageIndex + 1}`;
            
            // ìŠ¤ì´ì§€ 8, 9, 10ì— ëŒ€í•œ ì²˜ë¦¬
            if (stageIndex >= 7) {  // ì¸ë±ìŠ¤ëŠ” 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ 7,8,9ê°€ ìŠ¤í…Œì´ì§€ 8,9,10
                const messages = {
                    7: "ìŠ¤í…Œì´ì§€ 8: ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤!",
                    8: "ìŠ¤í…Œì´ì§€ 9: ê³§ ë§Œë‚˜ìš”!",
                    9: "ìŠ¤í…Œì´ì§€ 10: ê¸°ëŒ€í•´ì£¼ì„¸ìš”!"
                };
                
                // ê²Œì„ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ìš”ì†Œë“¤ ìˆ¨ê¸°ê¸°
                player.style.display = 'none';
                goal.style.display = 'none';
                
                // ê¸°ì¡´ ë²½ ì œê±°
                const existingWalls = document.querySelectorAll('.wall');
                existingWalls.forEach(wall => wall.remove());
                
                // ë©”ì‹œì§€ í‘œì‹œë¥¼ ìœ„í•œ div ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸
                let messageDiv = document.getElementById('stage-message');
                if (!messageDiv) {
                    messageDiv = document.createElement('div');
                    messageDiv.id = 'stage-message';
                    messageDiv.style.cssText = `
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        font-size: 24px;
                        font-weight: bold;
                        text-align: center;
                        color: #333;
                    `;
                    gameContainer.appendChild(messageDiv);
                }
                messageDiv.textContent = messages[stageIndex];
                
                return; // ì—¬ê¸°ì„œ í•¨ìˆ˜ ì¢…ë£Œ
            }
            
            // ë©”ì‹œì§€ div ì œê±° (ë‹¤ë¥¸ ìŠ¤í…Œì´ì§€ë¡œ ì´ë™í•  ë•Œ)
            const messageDiv = document.getElementById('stage-message');
            if (messageDiv) {
                messageDiv.remove();
            }
            
            // í”Œë ˆì´ì–´ì™€ ëª©í‘œ ì§€ì  ë‹¤ì‹œ í‘œì‹œ
            player.style.display = 'block';
            goal.style.display = 'block';
            
            // ë°°ê²½ ì´ë¯¸ì§€ ë³€ê²½
            const bgElement = document.getElementById('background-image');
            // ëª¨ë“  stage-bg í´ë˜ìŠ¤ ì œê±°
            bgElement.className = '';
            // ìƒˆë¡œìš´ ìŠ¤í…Œì´ì§€ì˜ ë°°ê²½ í´ë˜ìŠ¤ ì¶”ê°€
            bgElement.className = `stage-bg-${stageIndex + 1}`;
            
            // ê¸°ì¡´ ë²½ ì œê±°
            const existingWalls = document.querySelectorAll('.wall');
            existingWalls.forEach(wall => wall.remove());

            // í¬íƒˆ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
            portal1.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal2.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal3.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal4.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal5.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal6.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal7.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal8.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal9.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal10.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal11.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal12.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal13.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal14.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal15.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal16.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal17.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal18.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal19.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal20.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal21.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal22.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal23.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal24.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal25.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal26.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal27.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal28.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal29.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal30.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal31.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal32.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal33.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal34.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal35.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal36.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal37.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal38.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal39.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal40.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal41.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal42.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal43.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            portal44.style.display = (stageIndex === 1 || stageIndex === 6) ? 'block' : 'none';
            


            if (stageIndex === 1) {
                // ìŠ¤í…Œì´ì§€ 2ì˜ í¬íƒˆ ìœ„ì¹˜ ì„¤ì •
                portal1.style.left = '250px';
                portal1.style.top = '50px';
                portal2.style.left = '540px';
                portal2.style.top = '20px';
                
                // ë‚˜ë¨¸ì§€ í¬íƒˆ ìˆ¨ê¸°ê¸°
                for(let i=3; i<=44; i++) {
                    document.getElementById(`portal${i}`).style.display = 'none';
                }
            } else if (stageIndex === 6) {
                // ìŠ¤í…Œì´ì§€ 7ì˜ í¬íƒˆ ìœ„ì¹˜ ì„¤ì •x
                for(let i=1; i<=3; i++) {
                    document.getElementById(`portal${i}`).style.display = 'none';
                }

                portal3.style.left = '100px'; /* ì²«ë²ˆì§¸ */
                portal3.style.top = '540px';
                portal4.style.left = '220px';
                portal4.style.top = '540px';

                portal5.style.left = '175px'; /* ë‘ì§¸  ì›ì */
                portal5.style.top = '540px';
                portal6.style.left = '20px';
                portal6.style.top = '540px';

                portal7.style.left = '305px'; /* ë²ˆì§¸ */
                portal7.style.top = '540px';
                portal8.style.left = '450px';
                portal8.style.top = '540px';

                portal9.style.left = '540px'; /* ë„¤ë²ˆì§¸ */  
                portal9.style.top = '540px';
                portal10.style.left = '300px';
                portal10.style.top = '440px';

                portal11.style.left = '390px'; /* ë‹¤ì„¯ë²ˆì§¸ */
                portal11.style.top = '540px';
                portal12.style.left = '20px';
                portal12.style.top = '540px';

                portal13.style.left = '180px'; /* ì—¬ì„¯ë²ˆì§¸ ì›ì  */
                portal13.style.top = '440px';
                portal14.style.left = '20px';
                portal14.style.top = '540px';

                portal15.style.left = '180px'; /* ì¼ê³±ë²ˆì§¸ */
                portal15.style.top = '340px';
                portal16.style.left = '20px';
                portal16.style.top = '440px';

                portal17.style.left = '20px'; /* ì—¬ëŸë²ˆì§¸ ì›ì */
                portal17.style.top = '340px';
                portal18.style.left = '20px';
                portal18.style.top = '540px';

                portal19.style.left = '100px'; /* ì•„í™‰ë²ˆì§¸ */
                portal19.style.top = '340px';
                portal20.style.left = '540px';
                portal20.style.top = '340px';

                portal21.style.left = '540px'; /* ì—´ë²ˆì§¸ */
                portal21.style.top = '440px';
                portal22.style.left = '540px';
                portal22.style.top = '140px';

                portal23.style.left = '390px'; /* ì—´í•œë²ˆì§¸ */
                portal23.style.top = '440px';
                portal24.style.left = '20px';
                portal24.style.top = '540px';

                portal25.style.left = '390px'; /* ì—´ë‘ë²ˆì§¸ */
                portal25.style.top = '340px';
                portal26.style.left = '20px';
                portal26.style.top = '540px';

                portal27.style.left = '390px'; /* ì—´ì„¸ë²ˆì§¸ */
                portal27.style.top = '140px';
                portal28.style.left = '20px';
                portal28.style.top = '540px';

                portal29.style.left = '390px'; /* ì—´ë„¤ë²ˆì§¸ */
                portal29.style.top = '240px';
                portal30.style.left = '20px';
                portal30.style.top = '540px';

                portal31.style.left = '540px'; /* ì—´ë‹¤ì„¯ë²ˆì§¸ */
                portal31.style.top = '240px';
                portal32.style.left = '160px';
                portal32.style.top = '190px'; /* ì§€ê¸ˆì€ ì—¬ê¸°ê¹Œì§€ */

                portal33.style.left = '20px'; /* ì—´ì—¬ì„¯ë²ˆì§¸ */
                portal33.style.top = '240px';
                portal34.style.left = '20px';
                portal34.style.top = '540px';

                portal35.style.left = '20px'; /* ì—´ì¼ê³±ë²ˆì§¸ */
                portal35.style.top = '140px';
                portal36.style.left = '375px';
                portal36.style.top = '30px';

                portal37.style.left = '290px'; /* ì—´ì—¬ëŸë²ˆì§¸ */
                portal37.style.top = '240px';
                portal38.style.left = '20px';
                portal38.style.top = '540px';

                portal39.style.left = '290px'; /* ì—´ì•„í™‰ë²ˆì§¸ */
                portal39.style.top = '140px';
                portal40.style.left = '20px';
                portal40.style.top = '540px';

                portal41.style.left = '540px'; /* ìŠ¤í…Œì´ì§€ 8 ì²«ë²ˆì§¸ */
                portal41.style.top = '30px';
                portal42.style.left = '120px';
                portal42.style.top = '30px';

                portal43.style.left = '240px'; /* ìŠ¤í…Œì´ì§€ 8 ë‘ë²ˆì§¸ */
                portal43.style.top = '30px';
                portal44.style.left = '20px';
                portal44.style.top = '540px';



            }

            // ìƒˆ ìŠ¤í…Œì´ì§€ì˜ ë²½ ìƒì„±
            walls = stages[stageIndex];
            createWalls();

            // í”Œë ˆì´ì–´ì™€ ëª©í‘œ ìœ„ì¹˜ ì„¤ì •
            resetGame();
            setGoalPosition();

            // ê¸°ì¡´ ìœ„í—˜ êµ¬ì—­ ì œê±°
            const existingDangerZones = document.querySelectorAll('.danger-zone, .dark-danger-zone');
            existingDangerZones.forEach(zone => zone.remove());
            
            // ìŠ¤í…Œì´ì§€ 5ì˜ ì¼ë°˜ ìœ„í—˜ êµ¬ì—­ ìƒì„±
            if (dangerZones[stageIndex]) {
                dangerZones[stageIndex].forEach(zone => {
                    const dangerZone = document.createElement('div');
                    dangerZone.className = 'danger-zone';
                    dangerZone.style.left = zone.x + 'px';
                    dangerZone.style.top = zone.y + 'px';
                    dangerZone.style.width = zone.width + 'px';
                    dangerZone.style.height = zone.height + 'px';
                    gameContainer.appendChild(dangerZone);
                });
            }

            // ìŠ¤í…Œì´ì§€ 6ì˜ ì–´ë‘ìš´ ìœ„í—˜ êµ¬ì—­ ìƒì„±
            if (darkDangerZones[stageIndex]) {
                darkDangerZones[stageIndex].forEach(zone => {
                    const dangerZone = document.createElement('div');
                    dangerZone.className = 'dark-danger-zone';
                    dangerZone.style.left = zone.x + 'px';
                    dangerZone.style.top = zone.y + 'px';
                    dangerZone.style.width = zone.width + 'px';
                    dangerZone.style.height = zone.height + 'px';
                    gameContainer.appendChild(dangerZone);
                });
            }

            // ê¸°ì¡´ ì›€ì§ì´ëŠ” ë°”ë‹¥ ì œê±°
            const existingPlatforms = document.querySelectorAll('.moving-platform');
            existingPlatforms.forEach(platform => platform.remove());

            // í•´ë‹¹ ìŠ¤í…Œì´ì§€ì˜ ì›€ì§ì´ëŠ” ë°”ë‹¥ ìƒì„±
            if (movingPlatforms[stageIndex]) {
                movingPlatforms[stageIndex].forEach(platform => {
                    const platformElement = document.createElement('div');
                    platformElement.className = 'moving-platform wall';
                    platformElement.style.left = platform.x + 'px';
                    platformElement.style.top = platform.y + 'px';
                    platformElement.style.width = platform.width + 'px';
                    platformElement.style.height = platform.height + 'px';
                    gameContainer.appendChild(platformElement);
                });
            }

            // ì¡°ëª… íš¨ê³¼ í† ê¸€ (ìŠ¤í…Œì´ì§€ 4ì™€ 6ì— ì ìš©)
            if (stageIndex === 3 || stageIndex === 5) {  // ìŠ¤í…Œì´ì§€ 4 ë˜ëŠ” 6
                lightOverlay.classList.add('active');
                updateLightPosition();
                
                // ë²½ì— dark-wall í´ë˜ìŠ¤ ì¶”ê°€
                document.querySelectorAll('.wall').forEach(wall => {
                    wall.classList.add('dark-wall');
                });
            } else {
                lightOverlay.classList.remove('active');
            }
        }

        function createWalls() {
            walls.forEach((wall, index) => {
                const wallElement = document.createElement('div');
                wallElement.className = 'wall';
                wallElement.style.left = wall.x + 'px';
                wallElement.style.top = wall.y + 'px';
                wallElement.style.width = wall.width + 'px';
                wallElement.style.height = wall.height + 'px';
                gameContainer.appendChild(wallElement);
            });
        }

        function checkWallCollision() {
            const playerLeft = parseFloat(player.style.left);
            const playerTop = parseFloat(player.style.top);
            const playerRight = playerLeft + playerWidth;
            const playerBottom = playerTop + playerHeight;

            // ì¼ë°˜ ë²½ê³¼ ì›€ì§ì´ëŠ” ë²½ì„ ëª¨ë‘ í¬í•¨í•˜ëŠ” ë°°ì—´ ìƒì„±
            let allWalls = [...walls];
            
            // í˜„ì¬ ìŠ¤í…Œì´ì§€ê°€ 3ì´ë©´ ì›€ì§ì´ëŠ” ë²½ë„ ì¶”ê°€
            if (currentStage === 2 && movingPlatforms[2]) {
                movingPlatforms[2].forEach(platform => {
                    allWalls.push({
                        x: platform.x,
                        y: platform.y,
                        width: platform.width,
                        height: platform.height
                    });
                });
            }

            for (const wall of allWalls) {
                if (playerRight > wall.x && playerLeft < wall.x + wall.width &&
                    playerBottom > wall.y && playerTop < wall.y + wall.height) {
                    // ì¶©ëŒ ë°œìƒ
                    const overlapLeft = playerRight - wall.x;
                    const overlapRight = wall.x + wall.width - playerLeft;
                    const overlapTop = playerBottom - wall.y;
                    const overlapBottom = wall.y + wall.height - playerTop;

                    // ê°€ì¥ ì‘ì€ ê²¹ì„ ì°¾ì•„ ê·¸ ë°©í–¥ìœ¼ë¡œ ë°€ì–´ëƒ„
                    const minOverlap = Math.min(overlapLeft, overlapRight, overlapTop, overlapBottom);

                    if (minOverlap === overlapLeft) {
                        player.style.left = (wall.x - playerWidth) + 'px';
                        playerVelocity.x = 0;
                    } else if (minOverlap === overlapRight) {
                        player.style.left = (wall.x + wall.width) + 'px';
                        playerVelocity.x = 0;
                    } else if (minOverlap === overlapTop) {
                        player.style.top = (wall.y - playerHeight) + 'px';
                        playerVelocity.y = 0;
                    } else if (minOverlap === overlapBottom) {
                        player.style.top = (wall.y + wall.height) + 'px';
                        playerVelocity.y = 0;
                    }
                }
            }
        }

        function checkCollision() {
            const playerLeft = parseFloat(player.style.left);
            const playerTop = parseFloat(player.style.top);
            const playerRight = playerLeft + playerWidth;
            const playerBottom = playerTop + playerHeight;

            let wasOnGround = isOnGround;
            isOnGround = false;

            if (playerLeft <= 0) {
                player.style.left = '0px';
                playerVelocity.x = 0;
                if (currentGravity === 'left') {
                    isJumping = false;
                    canJump = true;
                    isOnGround = true;
                }
            } else if (playerRight >= gameWidth) {
                player.style.left = (gameWidth - playerWidth) + 'px';
                playerVelocity.x = 0;
                if (currentGravity === 'right') {
                    isJumping = false;
                    canJump = true;
                    isOnGround = true;
                }
            }

            if (playerTop <= 0) {
                player.style.top = '0px';
                playerVelocity.y = 0;
                if (currentGravity === 'up') {
                    isJumping = false;
                    canJump = true;
                    isOnGround = true;
                }
            } else if (playerBottom >= gameHeight) {
                player.style.top = (gameHeight - playerHeight) + 'px';
                playerVelocity.y = 0;
                if (currentGravity === 'down') {
                    isJumping = false;
                    canJump = true;
                    isOnGround = true;
                }
            }

            checkWallCollision();

            // ë°”ë‹¥ì— ë‹¿ì•˜ì„ ë•Œ ì…ì íš¨ê³¼ ìƒì„±
            if (!wasOnGround && isOnGround) {
                createParticles();
            }
        }

        function checkPortalCollision() {
            if (portalCooldown) return;

            const playerRect = player.getBoundingClientRect();
            
            if (currentStage === 6) { // ìŠ¤í…Œì´ì§€ 7
                const portalPairs = [
                    [portal1, portal2],
                    [portal3, portal4],
                    [portal5, portal6],
                    [portal7, portal8],
                    [portal9, portal10],
                    [portal11, portal12],
                    [portal13, portal14],
                    [portal15, portal16],
                    [portal17, portal18],
                    [portal19, portal20],
                    [portal21, portal22],
                    [portal23, portal24],
                    [portal25, portal26],
                    [portal27, portal28],
                    [portal29, portal30],
                    [portal31, portal32],
                    [portal33, portal34],
                    [portal35, portal36],
                    [portal37, portal38],
                    [portal39, portal40],
                    [portal41, portal42],
                    [portal43, portal44]

                ];

                for (const [portalA, portalB] of portalPairs) {
                    const portalARect = portalA.getBoundingClientRect();
                    const portalBRect = portalB.getBoundingClientRect();

                    if (isColliding(playerRect, portalARect)) {
                        teleportPlayer(portalB);
                        break;
                    }
                }
            } else if (currentStage === 1) { // ìŠ¤í…Œì´ì§€ 2
                const portal1Rect = portal1.getBoundingClientRect();
                const portal2Rect = portal2.getBoundingClientRect();

                if (isColliding(playerRect, portal1Rect)) {
                    teleportPlayer(portal2);
                }
            }
        }

        function isColliding(rect1, rect2) {
            return rect1.left < rect2.right &&
                   rect1.right > rect2.left &&
                   rect1.top < rect2.bottom &&
                   rect1.bottom > rect2.top;
        }

        function teleportPlayer(targetPortal) {
            const targetX = parseFloat(targetPortal.style.left);
            const targetY = parseFloat(targetPortal.style.top);
            
            // í¬íƒˆ ìœ„ì¹˜ì— ì•½ê°„ì˜ ì˜¤í”„ì…‹ ì¶”ê°€í•˜ì—¬ ë” ìì—°ìŠ¤ëŸ¬ìš´ ì´ë™
            player.style.left = (targetX + 10) + 'px';
            player.style.top = (targetY + 10) + 'px';
            
            // í¬íƒˆ ì‚¬ìš©ì‹œ ì†ë„ ì´ˆê¸°í™”
            playerVelocity.x = 0;
            playerVelocity.y = 0;
            
            // í¬íƒˆ ì¿¨ë‹¤ìš´ ì„¤ì •
            portalCooldown = true;
            setTimeout(() => {
                portalCooldown = false;
            }, 10); // ì¿¨ë‹¤ìš´ ì‹œê°„ 1ì´ˆë¡œ ê°ì†Œ
        }

        function updateMovingPlatforms() {
            if (currentStage !== 2) return;  // ìŠ¤í…Œì´ì§€ 3ì„œë§Œ ì‹¤í–‰

            const platforms = document.querySelectorAll('.moving-platform');
            movingPlatforms[2].forEach((platformData, index) => {
                const platform = platforms[index];
                
                // xì¶• ì´ë™
                if (platformData.startX !== platformData.endX) {
                    platformData.x += platformData.speed * platformData.direction;
                    
                    // xì¶• í–¥ ì „í™˜ ì²´í¬
                    if (platformData.x >= platformData.endX) {
                        platformData.direction = -1;
                    } else if (platformData.x <= platformData.startX) {
                        platformData.direction = 1;
                    }
                    platform.style.left = platformData.x + 'px';
                }
                
                // yì¶• ì´ë™
                if (platformData.startY !== platformData.endY) {
                    platformData.y += platformData.speed * platformData.direction;
                    
                    // yì¶• ë°©í–¥ ì „í™˜ ì²´í¬
                    if (platformData.y >= platformData.endY) {
                        platformData.direction = -1;
                    } else if (platformData.y <= platformData.startY) {
                        platformData.direction = 1;
                    }
                    platform.style.top = platformData.y + 'px';
                }
                
                // í”Œë ˆì´ì–´ê°€ í”Œë«í¼ ìœ„ì— ìˆëŠ”ì§€ ì²´í¬
                const playerLeft = parseFloat(player.style.left);
                const playerBottom = parseFloat(player.style.top) + playerHeight;
                const platformTop = platformData.y;
                
                if (playerBottom >= platformTop && 
                    playerBottom <= platformTop + platformData.height &&
                    playerLeft >= platformData.x - playerWidth &&
                    playerLeft <= platformData.x + platformData.width) {
                    // í”Œë ˆì´ì–´ë¥¼ ë«í¼ê³¼ í•¨ê»˜ ì´ë™
                    if (platformData.startX !== platformData.endX) {
                        player.style.left = (parseFloat(player.style.left) + platformData.speed * platformData.direction) + 'px';
                    }
                    if (platformData.startY !== platformData.endY) {
                        player.style.top = (platformData.y - playerHeight) + 'px';
                    }
                }
            });
        }

        // ì¡°ëª… ìœ„ì¹˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateLightPosition() {
            if (currentStage !== 3 && currentStage !== 5) return;  // ìŠ¤í…Œì´ì§€ 4 ë˜ëŠ” 6ì—ì„œë§Œ ì‹¤í–‰
            
            const x = parseFloat(player.style.left) + (playerWidth / 2);
            const y = parseFloat(player.style.top) + (playerHeight / 2);
            
            lightOverlay.style.maskImage = `radial-gradient(circle at ${x}px ${y}px, transparent 30px, black 50px)`;
            lightOverlay.style.webkitMaskImage = `radial-gradient(circle at ${x}px ${y}px, transparent 30px, black 50px)`;
        }

        function update() {
            if (currentGravity === 'left') {
                playerVelocity.x = Math.max(playerVelocity.x - gravity, -maxFallSpeed);
            } else if (currentGravity === 'right') {
                playerVelocity.x = Math.min(playerVelocity.x + gravity, maxFallSpeed);
            } else if (currentGravity === 'up') {
                playerVelocity.y = Math.max(playerVelocity.y - gravity, -maxFallSpeed);
            } else if (currentGravity === 'down') {
                playerVelocity.y = Math.min(playerVelocity.y + gravity, maxFallSpeed);
            }

            player.style.left = (parseFloat(player.style.left) + playerVelocity.x) + 'px';
            player.style.top = (parseFloat(player.style.top) + playerVelocity.y) + 'px';

            checkCollision();
            updateMovingPlatforms();  // ì›€ì§ì´ëŠ” ë°”ë‹¥ ì—…ë°ì´íŠ¸
            checkDangerZones();
            updateLightPosition();  // ì¡°ëª… ìœ„ì¹˜ ì—…ë°ì´íŠ¸ ì¶”ê°€
            checkGoalCollision();
            checkPortalCollision();

            requestAnimationFrame(update);
        }

        function handleKeyDown(event) {
            const currentTime = Date.now();
            if (currentTime - lastMoveTime < moveDelay) return;

            if (keyState[event.code]) return;

            keyState[event.code] = true;
            lastMoveTime = currentTime;

            switch (event.code) {
                case 'ArrowLeft':
                case 'KeyA':
                    playerVelocity.x = -moveSpeed;
                    break;
                case 'ArrowRight':
                case 'KeyD':
                    playerVelocity.x = moveSpeed;
                    break;
                case 'ArrowUp':
                case 'KeyW':
                    playerVelocity.y = -moveSpeed;
                    break;
                case 'ArrowDown':
                case 'KeyS':
                    playerVelocity.y = moveSpeed;
                    break;
            }

            // WASD í‚¤ë¡œ ì¤‘ë ¥ ë³€ê²½
            switch (event.code) {
                case 'KeyW':
                    changeGravity('up');
                    break;
                case 'KeyA':
                    changeGravity('left');
                    break;
                case 'KeyS':
                    changeGravity('down');
                    break;
                case 'KeyD':
                    changeGravity('right');
                    break;
            }
        }

        function handleKeyUp(event) {
            keyState[event.code] = false;

            switch (event.code) {
                case 'ArrowLeft':
                case 'KeyA':
                    if (playerVelocity.x < 0) playerVelocity.x = 0;
                    break;
                case 'ArrowRight':
                case 'KeyD':
                    if (playerVelocity.x > 0) playerVelocity.x = 0;
                    break;
                case 'ArrowUp':
                case 'KeyW':
                    if (playerVelocity.y < 0) playerVelocity.y = 0;
                    break;
                case 'ArrowDown':
                case 'KeyS':
                    if (playerVelocity.y > 0) playerVelocity.y = 0;
                    break;
            }
        }

        function resetGame() {
            player.style.left = '10px';
            player.style.top = (gameHeight - playerHeight - 10) + 'px';
            playerVelocity = { x: 0, y: 0 };
            changeGravity('down');
        }

        function createParticles() {
            const particleCount = 20;
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                const angle = Math.random() * 2 * Math.PI;
                const distance = Math.random() * 50;
                particle.style.setProperty('--x', `${Math.cos(angle) * distance}px`);
                particle.style.setProperty('--y', `${Math.sin(angle) * distance}px`);
                particle.style.left = `${parseFloat(player.style.left) + playerWidth / 2}px`;
                particle.style.top = `${parseFloat(player.style.top) + playerHeight / 2}px`;
                gameContainer.appendChild(particle);

                // ì¼ì • ì‹œê°„ í›„ ì…ì ì œê±°
                setTimeout(() => {
                    particle.remove();
                }, 1000);
            }
        }

        function changeGravity(direction) {
            currentGravity = direction;
            playerVelocity.x = 0;
            playerVelocity.y = 0;
            gameContainer.style.borderColor = 'black';

            let rotation = 0;
            if (direction === 'left') {
                gameContainer.style.borderLeftColor = 'green';
                rotation = 90;
            } else if (direction === 'right') {
                gameContainer.style.borderRightColor = 'green';
                rotation = -90;
            } else if (direction === 'up') {
                gameContainer.style.borderTopColor = 'green';
                rotation = 180;
            } else if (direction === 'down') {
                gameContainer.style.borderBottomColor = 'green';
                rotation = 0;
            }
            
            // ì´ë¯¸ì§€ íšŒì „
            player.style.transform = `rotate(${rotation}deg)`;
        }

        function setGoalPosition() {
            // ê° ìŠ¤í…Œì´ì§€ë§ˆë‹¤ ë‹¤ë¥¸ ëª© ìœ„ ì„¤ì •
            const goalPositions = [
                { x: 540, y: 30 }, //1ë²ˆ ìŠ¤í…Œì´ì§€
                { x: 30, y: 30 }, //2ë²ˆ ìŠ¤í…Œì´ì§€
                { x: 30, y: 30 }, //3ë²ˆ ìŠ¤í…Œì´ì§€    
                { x: 540, y: 30 }, //4ë²ˆ ìŠ¤í…Œì´ì§€
                { x: 30, y: 30 }, //5ë²ˆ ìŠ¤í…Œì´ì§€
                { x: 540, y: 30 }, //6ë²ˆ ìŠ¤í…Œì´ì§€
                { x: 30, y: 30 }, //7ë²ˆ ìŠ¤í…Œì´ì§€
                { x: 540, y: 30 }, //8ë²ˆ ìŠ¤í…Œì´ì§€
                { x: 30, y: 30 }, //9ë²ˆ ìŠ¤í…Œì´ì§€   
                { x: 540, y: 30 }, //10ë²ˆ ìŠ¤í…Œì´ì§€
            ];

            const position = goalPositions[currentStage];
            goal.style.left = `${position.x}px`;
            goal.style.top = `${position.y}px`;
        }

        function checkGoalCollision() {
            const playerRect = player.getBoundingClientRect();
            const goalRect = goal.getBoundingClientRect();

            if (playerRect.left < goalRect.right &&
                playerRect.right > goalRect.left &&
                playerRect.top < goalRect.bottom &&
                playerRect.bottom > goalRect.top) {
                // ëª©í‘œì— ë„ë‹¬í–ˆì„ ë•Œ
                if (currentStage < stages.length - 1) {
                    loadStage(currentStage + 1);
                } else {
                    alert('ì¶•í•˜í•©ë‹ˆë‹¤! ëª¨ë“  ìŠ¤í…Œì´ì§€ë¥¼ í´ë¦¬ì–´í•˜ì…¨ìŠµë‹ˆë‹¤!');
                    loadStage(0); // ì²˜ìŒ ìŠ¤í…Œì´ì§€ë¡œ ëŒì•„ê°€ê¸°
                }
            }
        }

        function checkDangerZones() {
            // ìŠ¤í…Œì´ì§€ 5ì™€ 6ì—ì„œë§Œ ì²´í¬
            if (currentStage !== 4 && currentStage !== 5) return;  
            
            const playerLeft = parseFloat(player.style.left);
            const playerTop = parseFloat(player.style.top);
            const playerRight = playerLeft + playerWidth;
            const playerBottom = playerTop + playerHeight;
            
            // ìŠ¤í…Œì´ì§€ 5ì˜ ì¼ë°˜ ìœ„í—˜ êµ¬ì—­ ì²´í¬
            if (currentStage === 4 && dangerZones[4]) {
                for (const zone of dangerZones[4]) {
                    if (playerRight > zone.x && 
                        playerLeft < zone.x + zone.width &&
                        playerBottom > zone.y && 
                        playerTop < zone.y + zone.height) {
                        resetGame();
                        break;
                    }
                }
            }
            
            // ìŠ¤í…Œì´ì§€ 6ì˜ ì–´ë‘ìš´ ìœ„í—˜ êµ¬ì—­ ì²´í¬
            if (currentStage === 5 && darkDangerZones[5]) {
                for (const zone of darkDangerZones[5]) {
                    if (playerRight > zone.x && 
                        playerLeft < zone.x + zone.width &&
                        playerBottom > zone.y && 
                        playerTop < zone.y + zone.height) {
                        resetGame();
                        break;
                    }
                }
            }
        }

        // ì´ˆê¸°í™” ì½”ë“œ (createStageButtons() í˜¸ì¶œ ì „ì— ì¶”ê°€)
        function initializeAudio() {
            // BGM ìš”ì†Œë“¤ ì €ì¥
            for (let i = 1; i <= 7; i++) {
                bgmElements[i] = document.getElementById(`bgm-${i}`);
                bgmElements[i].volume = volume;
            }

            // ë³¼ë¥¨ ì»¨íŠ¸ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const volumeSlider = document.getElementById('volume-slider');
            const volumeValue = document.getElementById('volume-value');
            const muteButton = document.getElementById('mute-button');

            volumeSlider.addEventListener('input', (e) => {
                volume = e.target.value / 100;
                volumeValue.textContent = `${e.target.value}%`;
                
                if (!isMuted) {
                    Object.values(bgmElements).forEach(audio => {
                        audio.volume = volume;
                    });
                }
            });

            muteButton.addEventListener('click', () => {
                isMuted = !isMuted;
                muteButton.textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
                
                Object.values(bgmElements).forEach(audio => {
                    audio.volume = isMuted ? 0 : volume;
                });
            });
        }

        function initializeReviewSystem() {
            const stars = document.querySelectorAll('.star');
            const ratingValue = document.getElementById('rating-value');
            const submitButton = document.getElementById('submit-review');
            const reviewText = document.getElementById('review-text');
            let currentRating = 0;

            // ë³„ì  ì‹œìŠ¤í…œ
            stars.forEach(star => {
                star.addEventListener('mouseover', () => {
                    const rating = parseInt(star.dataset.rating);
                    highlightStars(rating);
                });

                star.addEventListener('mouseout', () => {
                    highlightStars(currentRating);
                });

                star.addEventListener('click', () => {
                    currentRating = parseInt(star.dataset.rating);
                    ratingValue.textContent = `${currentRating}ì `;
                    highlightStars(currentRating);
                });
            });

            function highlightStars(rating) {
                stars.forEach(star => {
                    const starRating = parseInt(star.dataset.rating);
                    star.classList.toggle('active', starRating <= rating);
                });
            }

            // í›„ê¸° ì œì¶œ
            submitButton.addEventListener('click', async () => {
                if (currentRating === 0) {
                    alert('ë³„ì ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
                    return;
                }

                if (!reviewText.value.trim()) {
                    alert('í›„ê¸°ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”!');
                    return;
                }

                try {
                    const response = await fetch('https://script.google.com/macros/s/AKfycbyUKeIf0S-tTQYwJCchUROJbJS4dEMLZxBGKuzodpe-1cuabZSSTmPF9VUy0LM7aNk/exec', {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8',
                        },
                        body: JSON.stringify({
                            rating: currentRating,
                            review: reviewText.value,
                            timestamp: new Date().toISOString()
                        })
                    });

                    alert('í›„ê¸°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!');
                    currentRating = 0;
                    reviewText.value = '';
                    ratingValue.textContent = '0ì ';
                    highlightStars(0);

                } catch (error) {
                    console.error('í›„ê¸° ì œì¶œ ì˜¤ë¥˜:', error);
                    alert('í›„ê¸° ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            });
        }

        // ì´ˆê¸°í™” ì½”ë“œì— ì¶”ê°€
        initializeUserInfo();
        initializeAudio();
        initializeReviewSystem();
        createStageButtons();
        loadStage(0);
        update();

        document.addEventListener('keydown', handleKeyDown);
        document.addEventListener('keyup', handleKeyUp);

        //goal.style.left = '570px';
        //goal.style.top = '10px';

        let sessionStartTime = Date.now();

        // ì´ë²¤íŠ¸ ë¡œê¹… í•¨ìˆ˜
        async function logEvent(eventType, eventDetail) {
            const studentId = localStorage.getItem('studentId');
            const sessionTime = (Date.now() - sessionStartTime) / 1000; // ì´ˆ ë‹¨ìœ„ë¡œ ë³€í™˜

            try {
                await fetch('https://script.google.com/macros/s/AKfycbzMUuR7N90UM9PqjczwnDoYVqKHwrjXUjmvDQJ-4iSODIjCIq-fetYVfUCqt4rUE95AVw/exec', {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify({
                        studentId: studentId,
                        eventType: eventType,
                        eventDetail: eventDetail,
                        sessionTime: sessionTime
                    })
                });
            } catch (error) {
                console.error('ë¡œê¹… ì˜¤ë¥˜:', error);
            }
        }

        // ë§ˆìš°ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener('click', (e) => {
            logEvent('click', `x: ${e.clientX}, y: ${e.clientY}`);
        });

        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.addEventListener('keydown', (e) => {
            logEvent('keypress', e.key);
        });

        // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ìµœì¢… ì„¸ì…˜ ì‹œê°„ ê¸°ë¡
        window.addEventListener('beforeunload', () => {
            logEvent('session_end', 'í˜ì´ì§€ ì¢…ë£Œ');
        });
    </script>
</body>
</html>


















































